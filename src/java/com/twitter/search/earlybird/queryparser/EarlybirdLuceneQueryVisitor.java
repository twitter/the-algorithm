package com.twittew.seawch.eawwybiwd.quewypawsew;

impowt java.utiw.awways;
i-impowt j-java.utiw.cowwection;
i-impowt java.utiw.cowwections;
i-impowt java.utiw.hashset;
i-impowt java.utiw.wist;
i-impowt java.utiw.map;
i-impowt j-java.utiw.set;
impowt java.utiw.tweeset;
impowt javax.annotation.nuwwabwe;

impowt com.googwe.common.annotations.visibwefowtesting;
i-impowt com.googwe.common.base.functions;
impowt com.googwe.common.base.optionaw;
impowt c-com.googwe.common.base.pweconditions;
impowt com.googwe.common.cowwect.immutabwewist;
i-impowt com.googwe.common.cowwect.immutabwemap;
impowt com.googwe.common.cowwect.wists;
impowt com.googwe.common.cowwect.sets;

i-impowt owg.apache.wucene.seawch.booweancwause;
impowt owg.apache.wucene.seawch.booweancwause.occuw;
i-impowt o-owg.apache.wucene.seawch.booweanquewy;
impowt owg.apache.wucene.seawch.boostquewy;
impowt owg.apache.wucene.seawch.matchnodocsquewy;
impowt owg.apache.wucene.seawch.phwasequewy;
impowt owg.apache.wucene.seawch.quewy;
i-impowt owg.apache.wucene.seawch.tewmquewy;
impowt owg.wocationtech.spatiaw4j.shape.point;
impowt owg.wocationtech.spatiaw4j.shape.wectangwe;
impowt owg.wocationtech.spatiaw4j.shape.impw.pointimpw;
i-impowt owg.wocationtech.spatiaw4j.shape.impw.wectangweimpw;
i-impowt o-owg.swf4j.woggew;
i-impowt owg.swf4j.woggewfactowy;

i-impowt com.twittew.decidew.decidew;
impowt com.twittew.seawch.common.constants.quewycacheconstants;
impowt com.twittew.seawch.common.decidew.decidewutiw;
i-impowt com.twittew.seawch.common.encoding.featuwes.bytenowmawizew;
impowt com.twittew.seawch.common.indexing.thwiftjava.thwiftgeowocationsouwce;
impowt c-com.twittew.seawch.common.metwics.seawchcountew;
impowt com.twittew.seawch.common.quewy.boostutiws;
impowt com.twittew.seawch.common.quewy.fiewdweightutiw;
impowt com.twittew.seawch.common.quewy.fiwtewedquewy;
impowt com.twittew.seawch.common.quewy.hitattwibutehewpew;
i-impowt com.twittew.seawch.common.quewy.mappabwefiewd;
impowt c-com.twittew.seawch.common.schema.immutabweschema;
i-impowt com.twittew.seawch.common.schema.schemautiw;
i-impowt com.twittew.seawch.common.schema.base.fiewdweightdefauwt;
impowt com.twittew.seawch.common.schema.base.immutabweschemaintewface;
impowt com.twittew.seawch.common.schema.base.schema;
i-impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdcwustew;
i-impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdfiewdconstants;
impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdfiewdconstants.eawwybiwdfiewdconstant;
i-impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdthwiftdocumentbuiwdew;
i-impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdthwiftdocumentutiw;
impowt com.twittew.seawch.common.schema.thwiftjava.thwiftcsftype;
i-impowt com.twittew.seawch.common.seawch.tewminationtwackew;
impowt com.twittew.seawch.common.seawch.tewmination.quewytimeout;
i-impowt com.twittew.seawch.common.utiw.anawysis.inttewmattwibuteimpw;
impowt com.twittew.seawch.common.utiw.anawysis.wongtewmattwibuteimpw;
i-impowt com.twittew.seawch.common.utiw.spatiaw.geohashchunkimpw;
impowt com.twittew.seawch.common.utiw.text.highfwequencytewmpaiws;
i-impowt com.twittew.seawch.common.utiw.text.nowmawizewhewpew;
impowt com.twittew.seawch.eawwybiwd.common.config.eawwybiwdconfig;
i-impowt com.twittew.seawch.eawwybiwd.common.usewupdates.usewscwubgeomap;
i-impowt com.twittew.seawch.eawwybiwd.common.usewupdates.usewtabwe;
impowt com.twittew.seawch.eawwybiwd.pawtition.muwtisegmenttewmdictionawymanagew;
impowt com.twittew.seawch.eawwybiwd.quewycache.cachedfiwtewquewy;
impowt com.twittew.seawch.eawwybiwd.quewycache.quewycachemanagew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.csfdisjunctionfiwtew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.docvawwangefiwtew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.featuwevawueinacceptwistowunsetfiwtew;
i-impowt c-com.twittew.seawch.eawwybiwd.seawch.geoquadtweequewybuiwdew;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.matchawwdocsquewy;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.wequiwedstatusidsfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.sincemaxidfiwtew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.sinceuntiwfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.tewmquewywithsafetostwing;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.usewfwagsexcwudefiwtew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.usewscwubgeofiwtew;
impowt c-com.twittew.seawch.eawwybiwd.seawch.quewies.usewidmuwtisegmentquewy;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.minfeatuwevawuefiwtew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.scowefiwtewquewy;
impowt c-com.twittew.seawch.eawwybiwd.seawch.wewevance.scowing.scowingfunctionpwovidew;
i-impowt com.twittew.seawch.quewypawsew.quewy.conjunction;
i-impowt c-com.twittew.seawch.quewypawsew.quewy.disjunction;
impowt com.twittew.seawch.quewypawsew.quewy.phwase;
impowt com.twittew.seawch.quewypawsew.quewy.quewynodeutiws;
i-impowt com.twittew.seawch.quewypawsew.quewy.quewypawsewexception;
i-impowt com.twittew.seawch.quewypawsew.quewy.speciawtewm;
i-impowt c-com.twittew.seawch.quewypawsew.quewy.tewm;
impowt c-com.twittew.seawch.quewypawsew.quewy.annotation.annotation;
impowt com.twittew.seawch.quewypawsew.quewy.annotation.fwoatannotation;
impowt com.twittew.seawch.quewypawsew.quewy.seawch.wink;
i-impowt com.twittew.seawch.quewypawsew.quewy.seawch.seawchopewatow;
impowt com.twittew.seawch.quewypawsew.quewy.seawch.seawchopewatowconstants;
impowt com.twittew.seawch.quewypawsew.quewy.seawch.seawchquewyvisitow;
impowt com.twittew.seawch.quewypawsew.utiw.geocode;
impowt c-com.twittew.sewvice.spidewduck.gen.winkcategowy;
impowt com.twittew.tweetypie.thwiftjava.composewsouwce;

/**
 * visitow fow {@wink com.twittew.seawch.quewypawsew.quewy.quewy}, ü•∫ w-which pwoduces a-a wucene
 * q-quewy ({@wink quewy}). (U Ôπè U)
 */
pubwic c-cwass eawwybiwdwucenequewyvisitow extends seawchquewyvisitow<quewy> {
  p-pwivate s-static finaw woggew wog = woggewfactowy.getwoggew(eawwybiwdwucenequewyvisitow.cwass);

  @visibwefowtesting
  static finaw stwing unsuppowted_opewatow_pwefix = "unsuppowted_quewy_opewatow_";

  pwivate static finaw stwing s-smiwey_fowmat_stwing = "__has_%s_smiwey";
  pwivate s-static finaw stwing phwase_wiwdcawd = "*";
  p-pwivate static f-finaw fwoat defauwt_fiewd_weight = 1.0f;

  pwivate static finaw s-seawchcountew since_time_invawid_int_countew =
      s-seawchcountew.expowt("eawwybiwdwucenequewyvisitow_since_time_invawid_int");
  pwivate static f-finaw seawchcountew u-untiw_time_invawid_int_countew =
      seawchcountew.expowt("eawwybiwdwucenequewyvisitow_untiw_time_invawid_int");

  pwivate static finaw seawchcountew n-nyum_quewies_bewow_min_engagement_thweshowd =
      s-seawchcountew.expowt(
          "eawwybiwdwucenequewyvisitow_num_quewies_bewow_min_engagement_thweshowd");
  p-pwivate static finaw seawchcountew n-nyum_quewies_above_min_engagement_thweshowd =
      s-seawchcountew.expowt(
          "eawwybiwdwucenequewyvisitow_num_quewies_above_min_engagement_thweshowd");

  pwivate static f-finaw seawchopewatow opewatow_cached_excwude_antisociaw_and_nativewetweets =
      nyew seawchopewatow(seawchopewatow.type.cached_fiwtew, >w<
          quewycacheconstants.excwude_antisociaw_and_nativewetweets);

  pwivate s-static finaw map<stwing, nyaa~~ w-wist<seawchopewatow>> opewatows_by_safe_excwude_opewand =
      immutabwemap.of(
          seawchopewatowconstants.tweet_spam, -.- i-immutabwewist.of(
              n-nyew seawchopewatow(seawchopewatow.type.docvaw_wange_fiwtew, XD
                  "extended_encoded_tweet_featuwes.wabew_spam_fwag", -.- "0", >w< "1"),
              new seawchopewatow(seawchopewatow.type.docvaw_wange_fiwtew, (Íàç·¥óÍàç)
                  "extended_encoded_tweet_featuwes.wabew_spam_hi_wcw_fwag", :3 "0", (ÀÜ Ôªå ÀÜ)‚ô° "1"),
              nyew seawchopewatow(seawchopewatow.type.docvaw_wange_fiwtew, -.-
                  "extended_encoded_tweet_featuwes.wabew_dup_content_fwag", mya "0", (ÀòœâÀò) "1")),

          seawchopewatowconstants.tweet_abusive, ^‚Ä¢Ôªå‚Ä¢^ i-immutabwewist.of(
              nyew seawchopewatow(seawchopewatow.type.docvaw_wange_fiwtew, üò≥üò≥üò≥
                  "extended_encoded_tweet_featuwes.wabew_abusive_fwag", œÉœâœÉ "0", "1")),

          seawchopewatowconstants.tweet_unsafe, ( Õ°o œâ Õ°o ) immutabwewist.of(
              n-nyew seawchopewatow(seawchopewatow.type.docvaw_wange_fiwtew,
                  "extended_encoded_tweet_featuwes.wabew_nsfw_hi_pwc_fwag", nyaa~~ "0", :3 "1"))
      );

  pwivate s-static finaw i-immutabwemap<stwing, (‚úøoœâo) fiewdweightdefauwt> defauwt_fiewds =
      immutabwemap.of(eawwybiwdfiewdconstant.text_fiewd.getfiewdname(), >_<
                      n-nyew fiewdweightdefauwt(twue, ^^ d-defauwt_fiewd_weight));

  // aww eawwybiwd fiewds that shouwd have geo s-scwubbed tweets fiwtewed out when s-seawched. (///À¨///‚úø)
  // see go/weawtime-geo-fiwtewing
  @visibwefowtesting
  pubwic static finaw wist<stwing> g-geo_fiewds_to_be_scwubbed = awways.aswist(
      e-eawwybiwdfiewdconstant.geo_hash_fiewd.getfiewdname(), :3
      e-eawwybiwdfiewdconstant.pwace_fiewd.getfiewdname(), :3
      eawwybiwdfiewdconstant.pwace_id_fiewd.getfiewdname(), (ÀÜ Ôªå ÀÜ)‚ô°
      e-eawwybiwdfiewdconstant.pwace_fuww_name_fiewd.getfiewdname(),
      eawwybiwdfiewdconstant.pwace_countwy_code_fiewd.getfiewdname());

  // g-geo scwubbing d-doesn't wemove u-usew pwofiwe wocation, ü•∫ so when using t-the geo wocation t-type fiwtews
  // we onwy nyeed to fiwtew o-out geo scwubbed t-tweets fow the g-geo wocation types othew than
  // thwiftgeowocationsouwce.usew_pwofiwe. üò≥
  // s-sepawatewy, (Íàç·¥óÍàç) we awso n-nyeed to fiwtew o-out geo scwubbed tweets fow the pwace_id fiwtew. mya
  pwivate static f-finaw wist<stwing> g-geo_fiwtews_to_be_scwubbed = a-awways.aswist(
      e-eawwybiwdfiewdconstants.fowmatgeotype(thwiftgeowocationsouwce.geotag), rawr
      eawwybiwdfiewdconstants.fowmatgeotype(thwiftgeowocationsouwce.tweet_text),  òw ò
      e-eawwybiwdthwiftdocumentutiw.fowmatfiwtew(
          eawwybiwdfiewdconstant.pwace_id_fiewd.getfiewdname()));

  // quewies whose pawents awe nyegated. -.-
  // used to decide i-if a nyegated quewy is within a n-nyegated pawent ow nyot. UwU
  pwivate f-finaw set<com.twittew.seawch.quewypawsew.quewy.quewy> pawentnegatedquewies =
      s-sets.newidentityhashset();

  pwivate finaw i-immutabweschemaintewface s-schemasnapshot;
  p-pwivate f-finaw immutabwemap<stwing, :3 f-fiewdweightdefauwt> defauwtfiewdweightmap;
  pwivate finaw quewycachemanagew quewycachemanagew;
  pwivate finaw usewtabwe usewtabwe;
  p-pwivate f-finaw usewscwubgeomap u-usewscwubgeomap;

  @nuwwabwe
  pwivate finaw t-tewminationtwackew tewminationtwackew;
  pwivate finaw map<mappabwefiewd, üò≥ s-stwing> m-mappabwefiewdmap;
  pwivate f-finaw muwtisegmenttewmdictionawymanagew muwtisegmenttewmdictionawymanagew;
  pwivate finaw decidew d-decidew;
  p-pwivate finaw eawwybiwdcwustew eawwybiwdcwustew;

  pwivate fwoat p-pwoximityphwaseweight = 1.0f;
  p-pwivate int pwoximityphwaseswop = 255;
  pwivate immutabwemap<stwing, (Íàç·¥óÍàç) fwoat> enabwedfiewdweightmap;
  pwivate s-set<stwing> quewiedfiewds;

  // i-if we nyeed to a-accumuwate and cowwect p-pew-fiewd a-and pew quewy nyode hit attwibution i-infowmation,
  // t-this wiww have a mapping b-between the quewy n-nyodes and theiw unique wanks, mya a-as weww as the
  // attwibute cowwectow.
  @nuwwabwe
  pwivate h-hitattwibutehewpew hitattwibutehewpew;

  @nuwwabwe
  p-pwivate quewytimeout q-quewytimeout;

  pubwic e-eawwybiwdwucenequewyvisitow(
      immutabweschemaintewface schemasnapshot, nyaa~~
      quewycachemanagew q-quewycachemanagew, o.O
      u-usewtabwe usewtabwe, √≤œâ√≥
      u-usewscwubgeomap usewscwubgeomap,
      eawwybiwdcwustew eawwybiwdcwustew, ^‚Ä¢Ôªå‚Ä¢^
      d-decidew decidew) {
    this(schemasnapshot, (ÀòœâÀò) q-quewycachemanagew, √≤œâ√≥ u-usewtabwe, usewscwubgeomap, n-nyuww, mya defauwt_fiewds, ^^
         cowwections.emptymap(), rawr n-nyuww, >_< d-decidew, eawwybiwdcwustew, nyuww);
  }

  pubwic eawwybiwdwucenequewyvisitow(
      i-immutabweschemaintewface schemasnapshot, (U ·µï U‚ùÅ)
      quewycachemanagew q-quewycachemanagew, /(^‚Ä¢œâ‚Ä¢^)
      u-usewtabwe usewtabwe, mya
      usewscwubgeomap u-usewscwubgeomap, OwO
      @nuwwabwe tewminationtwackew tewminationtwackew, UwU
      m-map<stwing, ü•∫ f-fiewdweightdefauwt> f-fiewdweightmap, (‚úøoœâo)
      map<mappabwefiewd, rawr stwing> mappabwefiewdmap, rawr
      muwtisegmenttewmdictionawymanagew muwtisegmenttewmdictionawymanagew, ( Õ°o œâ Õ°o )
      decidew decidew, /(^‚Ä¢œâ‚Ä¢^)
      eawwybiwdcwustew eawwybiwdcwustew, -.-
      quewytimeout quewytimeout) {
    this.schemasnapshot = schemasnapshot;
    this.defauwtfiewdweightmap = immutabwemap.copyof(fiewdweightmap);
    t-this.enabwedfiewdweightmap = f-fiewdweightdefauwt.getonwyenabwed(defauwtfiewdweightmap);
    this.quewycachemanagew = quewycachemanagew;
    t-this.usewtabwe = u-usewtabwe;
    t-this.usewscwubgeomap = usewscwubgeomap;
    t-this.mappabwefiewdmap = pweconditions.checknotnuww(mappabwefiewdmap);
    t-this.tewminationtwackew = t-tewminationtwackew;
    this.muwtisegmenttewmdictionawymanagew = m-muwtisegmenttewmdictionawymanagew;
    this.decidew = d-decidew;
    t-this.eawwybiwdcwustew = eawwybiwdcwustew;
    this.quewytimeout = q-quewytimeout;
    t-this.quewiedfiewds = n-nyew tweeset<>();
  }

  p-pubwic immutabwemap<stwing, >w< f-fwoat> g-getenabwedfiewdweightmap() {
    w-wetuwn enabwedfiewdweightmap;
  }

  p-pubwic i-immutabwemap<stwing, ( Õ°o œâ Õ°o ) fiewdweightdefauwt> g-getdefauwtfiewdweightmap() {
    w-wetuwn d-defauwtfiewdweightmap;
  }

  pubwic eawwybiwdwucenequewyvisitow s-setpwoximityphwaseweight(fwoat weight) {
    this.pwoximityphwaseweight = w-weight;
    wetuwn t-this;
  }

  pubwic e-eawwybiwdwucenequewyvisitow s-setpwoximityphwaseswop(int swop) {
    t-this.pwoximityphwaseswop = swop;
    wetuwn t-this;
  }

  pubwic void setfiewdhitattwibutehewpew(hitattwibutehewpew n-nyewhitattwibutehewpew) {
    this.hitattwibutehewpew = n-nyewhitattwibutehewpew;
  }

  @ovewwide
  pubwic finaw quewy visit(disjunction disjunction) t-thwows quewypawsewexception {
    booweanquewy.buiwdew b-bqbuiwdew = n-nyew booweanquewy.buiwdew();
    wist<com.twittew.seawch.quewypawsew.quewy.quewy> chiwdwen = disjunction.getchiwdwen();
    // d-do a finaw wound of check, (ÀòœâÀò) if a-aww nyodes undew a-a disjunction awe m-must, /(^‚Ä¢œâ‚Ä¢^)
    // tweat them aww as defauwt (shouwd i-in wucene). (ÀòœâÀò)
    b-boowean awwmust = twue;
    fow (com.twittew.seawch.quewypawsew.quewy.quewy c-chiwd : chiwdwen) {
      if (!chiwd.mustoccuw()) {
        a-awwmust = fawse;
        b-bweak;
      }
    }
    i-if (awwmust) {
      c-chiwdwen = wists.twansfowm(chiwdwen, quewynodeutiws.make_quewy_defauwt);
    }
    // a-actuawwy c-convewting aww chiwdwen n-now. o.O
    f-fow (com.twittew.seawch.quewypawsew.quewy.quewy chiwd : chiwdwen) {
      f-finaw q-quewy q = chiwd.accept(this);
      i-if (q != nyuww) {
        // i-if a nyode is m-mawked with musthave a-annotation, nyaa~~ w-we set it to must e-even if it's a
        // disjunction. :3
        i-if (chiwd.mustoccuw()) {
          bqbuiwdew.add(q, (///À¨///‚úø) o-occuw.must);
        } ewse {
          b-bqbuiwdew.add(q, (U Ôπè U) occuw.shouwd);
        }
      }
    }

    q-quewy b-bq = bqbuiwdew.buiwd();
    fwoat boost = (fwoat) getboostfwomannotations(disjunction.getannotations());
    i-if (boost >= 0) {
      b-bq = boostutiws.maybewwapinboostquewy(bq, b-boost);
    }
    wetuwn bq;
  }

  @ovewwide
  pubwic quewy visit(conjunction conjunction) thwows q-quewypawsewexception {
    b-booweanquewy.buiwdew bqbuiwdew = nyew b-booweanquewy.buiwdew();
    w-wist<com.twittew.seawch.quewypawsew.quewy.quewy> chiwdwen = conjunction.getchiwdwen();
    boowean haspositivetewms = f-fawse;
    f-fow (com.twittew.seawch.quewypawsew.quewy.quewy c-chiwd : chiwdwen) {
      b-boowean chiwdmustnotoccuw = chiwd.mustnotoccuw();
      b-boowean chiwdadded = a-addquewy(bqbuiwdew, o.O chiwd);
      if (chiwdadded && !chiwdmustnotoccuw) {
        h-haspositivetewms = twue;
      }
    }
    if (!chiwdwen.isempty() && !haspositivetewms) {
      b-bqbuiwdew.add(new matchawwdocsquewy(), ^^;; o-occuw.must);
    }

    q-quewy bq = bqbuiwdew.buiwd();
    f-fwoat b-boost = (fwoat) getboostfwomannotations(conjunction.getannotations());
    i-if (boost >= 0) {
      bq = boostutiws.maybewwapinboostquewy(bq,  òw ò boost);
    }
    w-wetuwn bq;
  }

  @ovewwide
  pubwic q-quewy visit(phwase p-phwase) t-thwows quewypawsewexception {
    wetuwn visit(phwase, (///À¨///‚úø) f-fawse);
  }

  @ovewwide
  p-pubwic quewy v-visit(tewm tewm) thwows quewypawsewexception {
    w-wetuwn finawizequewy(cweatetewmquewydisjunction(tewm), œÉœâœÉ tewm);
  }

  @ovewwide
  pubwic quewy v-visit(speciawtewm s-speciaw) thwows q-quewypawsewexception {
    stwing fiewd;

    switch (speciaw.gettype()) {
      case hashtag:
        f-fiewd = eawwybiwdfiewdconstant.hashtags_fiewd.getfiewdname();
        b-bweak;
      case s-stock:
        fiewd = eawwybiwdfiewdconstant.stocks_fiewd.getfiewdname();
        bweak;
      c-case mention:
        fiewd = e-eawwybiwdfiewdconstant.mentions_fiewd.getfiewdname();
        b-bweak;
      d-defauwt:
        f-fiewd = e-eawwybiwdfiewdconstant.text_fiewd.getfiewdname();
    }

    stwing tewmtext = speciaw.getspeciawchaw() + speciaw.getvawue();
    quewy q = c-cweatesimpwetewmquewy(speciaw, ^^;; fiewd, UwU tewmtext);

    f-fwoat boost = (fwoat) getboostfwomannotations(speciaw.getannotations());
    if (boost >= 0) {
      q = boostutiws.maybewwapinboostquewy(q, mya b-boost);
    }

    wetuwn nyegatequewyifnodenegated(speciaw, ^‚Ä¢Ôªå‚Ä¢^ q);
  }

  @ovewwide
  pubwic quewy visit(wink wink) t-thwows quewypawsewexception {
    q-quewy q = cweatesimpwetewmquewy(
        w-wink, (‚ëÖÀòÍí≥Àò) eawwybiwdfiewdconstant.winks_fiewd.getfiewdname(), nyaa~~ wink.getopewand());

    fwoat boost = (fwoat) g-getboostfwomannotations(wink.getannotations());
    i-if (boost >= 0) {
      q = boostutiws.maybewwapinboostquewy(q, ^^;; b-boost);
    }

    wetuwn nyegatequewyifnodenegated(wink, ü•∫ q-q);
  }

  @ovewwide
  pubwic quewy visit(finaw seawchopewatow o-op) thwows quewypawsewexception {
    finaw q-quewy quewy;
    s-seawchopewatow.type t-type = op.getopewatowtype();

    switch (type) {
      case t-to:
        quewy = visittoopewatow(op);
        bweak;

      case fwom:
        quewy = visitfwomopewatow(op);
        b-bweak;

      c-case fiwtew:
        quewy = v-visitfiwtewopewatow(op);
        b-bweak;

      case incwude:
        quewy = v-visitincwudeopewatow(op);
        b-bweak;

      case excwude:
        quewy = v-visitexcwudeopewatow(op);
        bweak;

      case wang:
        q-quewy = visitwangopewatow(op);
        bweak;

      case souwce:
        quewy = v-visitsouwceopewatow(op);
        b-bweak;

      case smiwey:
        q-quewy = v-visitsmiweyopewatow(op);
        b-bweak;

      case docvaw_wange_fiwtew:
        quewy = visitdocvawwangefiwtewopewatow(op);
        b-bweak;

      case cached_fiwtew:
        quewy = visitcachedfiwtewopewatow(op);
        b-bweak;

      case scowe_fiwtew:
        quewy = visitscowedfiwtewopewatow(op);
        b-bweak;

      c-case since_time:
        q-quewy = visitsincetimeopewatow(op);
        b-bweak;

      c-case untiw_time:
        quewy = visituntiwtimeopewatow(op);
        bweak;

      c-case since_id:
        quewy = visitsinceidopewatow(op);
        b-bweak;

      case m-max_id:
        quewy = visitmaxidopewatow(op);
        bweak;

      c-case geowocation_type:
        q-quewy = visitgeowocationtypeopewatow(op);
        bweak;

      c-case geocode:
        quewy = v-visitgeocodeopewatow(op);
        b-bweak;

      case geo_bounding_box:
        q-quewy = visitgeoboundingboxopewatow(op);
        b-bweak;

      case pwace:
        q-quewy = visitpwaceopewatow(op);
        bweak;

      case wink:
        // t-this shouwd nyevew be cawwed - t-the wink visitow (visitow(wink wink)) shouwd be. ^^;;
        quewy = v-visitwinkopewatow(op);
        b-bweak;

      case e-entity_id:
        quewy = visitentityidopewatow(op);
        b-bweak;

      c-case fwom_usew_id:
        quewy = v-visitfwomusewidopewatow(op);
        bweak;

      c-case in_wepwy_to_tweet_id:
        quewy = v-visitinwepwytotweetidopewatow(op);
        b-bweak;

      case in_wepwy_to_usew_id:
        quewy = visitinwepwytousewidopewatow(op);
        bweak;

      c-case w-wiked_by_usew_id:
        quewy = visitwikedbyusewidopewatow(op);
        bweak;

      c-case wetweeted_by_usew_id:
        quewy = v-visitwetweetedbyusewidopewatow(op);
        b-bweak;

      case wepwied_to_by_usew_id:
        quewy = visitwepwiedtobyusewidopewatow(op);
        bweak;

      case quoted_usew_id:
        q-quewy = visitquotedusewidopewatow(op);
        bweak;

      case quoted_tweet_id:
        q-quewy = visitquotedtweetidopewatow(op);
        b-bweak;

      c-case diwected_at_usew_id:
        quewy = v-visitdiwectedatusewidopewatow(op);
        bweak;

      c-case c-convewsation_id:
        q-quewy = v-visitconvewsationidopewatow(op);
        b-bweak;

      case composew_souwce:
        quewy = visitcomposewsouwceopewatow(op);
        bweak;

      case wetweets_of_tweet_id:
        q-quewy = v-visitwetweetsoftweetidopewatow(op);
        b-bweak;

      c-case w-wetweets_of_usew_id:
        q-quewy = visitwetweetsofusewidopewatow(op);
        bweak;

      case wink_categowy:
        quewy = v-visitwinkcategowyopewatow(op);
        b-bweak;

      case cawd_name:
        quewy = visitcawdnameopewatow(op);
        bweak;

      c-case cawd_domain:
        q-quewy = visitcawddomainopewatow(op);
        b-bweak;

      case cawd_wang:
        quewy = visitcawdwangopewatow(op);
        b-bweak;

      case hf_tewm_paiw:
        quewy = v-visithftewmpaiwopewatow(op);
        b-bweak;

      case hf_phwase_paiw:
        quewy = visithftewmphwasepaiwopewatow(op);
        b-bweak;

      case pwoximity_gwoup:
        p-phwase phwase = n-nyew phwase(
            wists.twansfowm(op.getopewands(), nyaa~~
                            s-s -> nyowmawizewhewpew.nowmawizewithunknownwocawe(
                                s-s, eawwybiwdconfig.getpenguinvewsion())));

        quewy = v-visit(phwase, ü•∫ t-twue);
        b-bweak;

      c-case muwti_tewm_disjunction:
        quewy = visitmuwtitewmdisjunction(op);
        b-bweak;

      c-case csf_disjunction_fiwtew:
        quewy = v-visitcsfdisjunctionfiwtew(op);
        bweak;

      case safety_excwude:
        q-quewy = visitsafetyexcwude(op);
        bweak;

      c-case space_id:
        quewy = visitspaceid(op);
        b-bweak;

      c-case nyamed_entity:
        quewy = visitnamedentity(op);
        b-bweak;

      case nyamed_entity_with_type:
        quewy = visitnamedentitywithtype(op);
        b-bweak;

      c-case min_faves:
      case min_quawity_scowe:
      case min_wepwies:
      c-case m-min_wetweets:
      case min_weputation:
        q-quewy = visitminfeatuwevawueopewatow(type, (ÀÜ Ôªå ÀÜ)‚ô° op);
        bweak;

      case featuwe_vawue_in_accept_wist_ow_unset:
        q-quewy = v-visitfeatuwevawueinacceptwistowunsetfiwtewopewatow(op);
        bweak;

      c-case nyeaw:
      c-case wewated_to_tweet_id:
      case since:
      case site:
      c-case untiw:
      c-case w-within:
      case w-within_time:
        quewy = cweateunsuppowtedopewatowquewy(op);
        bweak;

      case nyamed_csf_disjunction_fiwtew:
      case nyamed_muwti_tewm_disjunction:
        quewy = wogandthwowquewypawsewexception(
            "named d-disjunction o-opewatow c-couwd nyot be convewted t-to a disjunction o-opewatow.");
        bweak;

      d-defauwt:
        quewy = w-wogandthwowquewypawsewexception("unknown opewatow " + o-op.tostwing());
    }

    wetuwn nyegatequewyifnodenegated(op, q-quewy);
  }

  p-pwotected quewy visittoopewatow(seawchopewatow op) thwows q-quewypawsewexception {
    wetuwn cweatenowmawizedtewmquewy(
        op, ( Õ°o œâ Õ°o ) eawwybiwdfiewdconstant.to_usew_fiewd.getfiewdname(), nyaa~~ o-op.getopewand());
  }

  pwotected q-quewy visitfwomopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    w-wetuwn cweatenowmawizedtewmquewy(
        o-op, ( Õ°o œâ Õ°o ) e-eawwybiwdfiewdconstant.fwom_usew_fiewd.getfiewdname(), ^^;; op.getopewand());
  }

  p-pwotected quewy v-visitfiwtewopewatow(seawchopewatow op) thwows quewypawsewexception {
    w-wetuwn visitfiwtewopewatow(op, rawr x3 f-fawse);
  }

  p-pwotected q-quewy visitincwudeopewatow(seawchopewatow op) t-thwows quewypawsewexception {
    // incwude is a bit funny. ^^;;  if w-we have [incwude wetweets] we awe saying
    // do incwude wetweets, ^‚Ä¢Ôªå‚Ä¢^ which is the defauwt. ü•∫  awso conjunctions we-negate
    // n-nyanievew nyode we emit fwom the visitow. (Íàç·¥óÍàç)
    if (!ispawentnegated(op) && !nodeisnegated(op)) {
      // positive incwude - nyo-op. ^‚Ä¢Ôªå‚Ä¢^
      wetuwn nyuww;
    }
    w-wetuwn visitfiwtewopewatow(op, :3 fawse);
  }

  pwotected quewy v-visitexcwudeopewatow(seawchopewatow op) thwows quewypawsewexception {
    // e-excwude is a bit funny. (ÀòœâÀò)  if we have -[excwude w-wetweets] we awe saying
    // d-dont excwude wetweets, ^^ w-which is the defauwt. /(^‚Ä¢œâ‚Ä¢^)
    i-if (ispawentnegated(op) || nyodeisnegated(op)) {
      // nyegative excwude. œÉœâœÉ  d-do nyothing - pawent wiww nyot add this to the wist of c-chiwdwen. √≤œâ√≥
      wetuwn nyuww;
    } e-ewse {
      // positive excwude. >w<
      w-wetuwn visitfiwtewopewatow(op, (ÀòœâÀò) t-twue);
    }
  }

  pwotected q-quewy visitfiwtewopewatow(seawchopewatow op, ^‚Ä¢Ôªå‚Ä¢^ boowean nyegate)
      thwows q-quewypawsewexception {
    quewy q;
    boowean nyegatequewy = n-nyegate;

    if (op.getopewand().equaws(seawchopewatowconstants.antisociaw)) {
      // since the object we use to impwement t-these fiwtews is a-actuawwy an
      // excwude fiwtew, >_< w-we nyeed t-to nyegate it to get it to wowk a-as a weguwaw fiwtew. -.-
      q = usewfwagsexcwudefiwtew.getusewfwagsexcwudefiwtew(usewtabwe, √≤œâ√≥ twue, ( Õ°o œâ Õ°o ) fawse, fawse);
      nyegatequewy = !negatequewy;
    } e-ewse if (op.getopewand().equaws(seawchopewatowconstants.offensive_usew)) {
      q-q = usewfwagsexcwudefiwtew.getusewfwagsexcwudefiwtew(usewtabwe, (ÀÜ Ôªå ÀÜ)‚ô° fawse, :3 t-twue, fawse);
      n-nyegatequewy = !negatequewy;
    } ewse if (op.getopewand().equaws(seawchopewatowconstants.antisociaw_offensive_usew)) {
      q-q = usewfwagsexcwudefiwtew.getusewfwagsexcwudefiwtew(usewtabwe, ^‚Ä¢Ôªå‚Ä¢^ twue, ( Õ°o œâ Õ°o ) twue, fawse);
      nyegatequewy = !negatequewy;
    } e-ewse if (op.getopewand().equaws(seawchopewatowconstants.pwotected)) {
      q = usewfwagsexcwudefiwtew.getusewfwagsexcwudefiwtew(usewtabwe, ^‚Ä¢Ôªå‚Ä¢^ f-fawse,  òw ò f-fawse, twue);
      negatequewy = !negatequewy;
    } ewse if (op.getopewand().equaws(seawchopewatowconstants.has_engagement)) {
      w-wetuwn buiwdhasengagementsquewy();
    } ewse if (op.getopewand().equaws(seawchopewatowconstants.safe_seawch_fiwtew)) {
      booweanquewy.buiwdew bqbuiwdew = nyew booweanquewy.buiwdew();
      bqbuiwdew.add(
          cweatenoscowetewmquewy(
              o-op, :3
              e-eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), >_<
              eawwybiwdfiewdconstant.is_offensive), rawr
          o-occuw.shouwd);

      // t-the fowwowing intewnaw f-fiewd __fiwtew_sensitive_content
      // is nyot cuwwentwy buiwt by eawwybiwd. ü•∫
      // this means the safe seawch f-fiwtew sowey opewates on the is_offensive bit
      bqbuiwdew.add(
          cweatenoscowetewmquewy(
              o-op, (‚úøoœâo)
              e-eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), (U Ôπè U)
              eawwybiwdthwiftdocumentutiw.fowmatfiwtew(seawchopewatowconstants.sensitive_content)), rawr x3
          occuw.shouwd);
      q-q = bqbuiwdew.buiwd();
      nyegatequewy = !negatequewy;
    } ewse if (op.getopewand().equaws(seawchopewatowconstants.wetweets)) {
      // speciaw case fow f-fiwtew:wetweets - w-we use the t-text fiewd seawch "-wt"
      // mostwy fow wegacy w-weasons. (‚úøoœâo)
      q = cweatesimpwetewmquewy(
          o-op, (U ·µï U‚ùÅ)
          eawwybiwdfiewdconstant.text_fiewd.getfiewdname(), -.-
          e-eawwybiwdthwiftdocumentbuiwdew.wetweet_tewm);
    } ewse if (schemasnapshot.getfacetfiewdbyfacetname(op.getopewand()) != n-nyuww) {
      schema.fiewdinfo facetfiewd = s-schemasnapshot.getfacetfiewdbyfacetname(op.getopewand());
      if (facetfiewd.getfiewdtype().isstowefacetskipwist()) {
        q-q = cweatesimpwetewmquewy(
            o-op, /(^‚Ä¢œâ‚Ä¢^)
            eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), OwO
            e-eawwybiwdfiewdconstant.getfacetskipfiewdname(facetfiewd.getname()));
      } e-ewse {
        // wetuwn empty bq that d-doesn't match anything
        q-q = nyew booweanquewy.buiwdew().buiwd();
      }
    } ewse if (op.getopewand().equaws(seawchopewatowconstants.vine_wink)) {
      // t-tempowawy s-speciaw case fow fiwtew:vine_wink. rawr x3 the fiwtew i-is cawwed "vine_wink", œÉœâœÉ but it
      // shouwd use the intewnaw fiewd "__fiwtew_vine".  òw ò we nyeed this speciaw case because othewwise
      // i-it wouwd wook fow the nyon-existing "__fiwtew_vine_wink" f-fiewd. -.- see seawch-9390
      q-q = cweatenoscowetewmquewy(
          op, üò≥
          eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), üò≥üò≥üò≥
          e-eawwybiwdthwiftdocumentutiw.fowmatfiwtew("vine"));
    } ewse {
      // the defauwt vaniwwa f-fiwtews just uses the fiwtew fowmat stwing and t-the
      // opewand text.
      q = cweatenoscowetewmquewy(
          o-op, OwO
          eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), ^‚Ä¢Ôªå‚Ä¢^
          eawwybiwdthwiftdocumentutiw.fowmatfiwtew(op.getopewand()));
    }
    // d-doubwe check: no f-fiwtews shouwd have any scowe contwibution. rawr
    q-q = nyew boostquewy(q, (‚úøoœâo) 0.0f);
    w-wetuwn nyegatequewy ? nyegatequewy(q) : q-q;
  }

  p-pwivate quewy buiwdhasengagementsquewy() {
    if (eawwybiwdcwustew == e-eawwybiwdcwustew.pwotected) {
      // engagements and engagement counts awe nyot indexed o-on eawwybiwds, ^^ so thewe is nyo nyeed to
      // twavewse t-the entiwe segment w-with the minfeatuwevawuefiwtew. -.- s-see seawch-28120
      wetuwn nyew matchnodocsquewy();
    }

    quewy favfiwtew = m-minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(
        eawwybiwdfiewdconstant.favowite_count.getfiewdname(), (‚úøoœâo) 1);
    q-quewy wetweetfiwtew = m-minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(
        e-eawwybiwdfiewdconstant.wetweet_count.getfiewdname(), o.O 1);
    quewy wepwyfiwtew = minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(
        eawwybiwdfiewdconstant.wepwy_count.getfiewdname(), :3 1);
    wetuwn nyew booweanquewy.buiwdew()
        .add(favfiwtew, rawr x3 occuw.shouwd)
        .add(wetweetfiwtew, (U ·µï U‚ùÅ) o-occuw.shouwd)
        .add(wepwyfiwtew, :3 o-occuw.shouwd)
        .buiwd();
  }

  pwotected quewy visitwangopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    wetuwn c-cweatenoscowetewmquewy(
        o-op, ü•∫ eawwybiwdfiewdconstant.iso_wanguage_fiewd.getfiewdname(), XD o-op.getopewand());
  }

  p-pwotected q-quewy visitsouwceopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    wetuwn cweatenoscowetewmquewy(
        o-op, >_< eawwybiwdfiewdconstant.nowmawized_souwce_fiewd.getfiewdname(), (Íàç·¥óÍàç) o-op.getopewand());
  }

  p-pwotected quewy v-visitsmiweyopewatow(seawchopewatow o-op) thwows q-quewypawsewexception {
    wetuwn c-cweatesimpwetewmquewy(
        o-op, ( Õ°o œâ Õ°o )
        e-eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), (ÀòœâÀò)
        stwing.fowmat(smiwey_fowmat_stwing, (ÀòœâÀò) op.getopewand()));
  }

  p-pwotected quewy visitdocvawwangefiwtewopewatow(seawchopewatow op) thwows q-quewypawsewexception {
    stwing csffiewdname = op.getopewands().get(0).towowewcase();

    t-thwiftcsftype c-csffiewdtype = schemasnapshot.getcsffiewdtype(csffiewdname);
    if (csffiewdtype == nyuww) {
      thwow nyew quewypawsewexception("invawid c-csf f-fiewd nyame " + op.getopewands().get(0)
          + " u-used in " + o-op.sewiawize());
    }

    twy {
      if (csffiewdtype == thwiftcsftype.doubwe
          || csffiewdtype == thwiftcsftype.fwoat) {
        w-wetuwn docvawwangefiwtew.getdocvawwangequewy(csffiewdname, UwU c-csffiewdtype, (ÀÜ Ôªå ÀÜ)‚ô°
            doubwe.pawsedoubwe(op.getopewands().get(1)), (///À¨///‚úø)
            doubwe.pawsedoubwe(op.getopewands().get(2)));
      } e-ewse if (csffiewdtype == t-thwiftcsftype.wong
          || csffiewdtype == thwiftcsftype.int
          || c-csffiewdtype == thwiftcsftype.byte) {
        quewy quewy = docvawwangefiwtew.getdocvawwangequewy(csffiewdname, (Íàç·¥óÍàç) csffiewdtype, -.-
            wong.pawsewong(op.getopewands().get(1)), üò≥üò≥üò≥
            w-wong.pawsewong(op.getopewands().get(2)));
        if (csffiewdname.equaws(eawwybiwdfiewdconstant.wat_won_csf_fiewd.getfiewdname())) {
          wetuwn w-wwapquewyinusewscwubgeofiwtew(quewy);
        }
        w-wetuwn q-quewy;
      } ewse {
        thwow n-nyew quewypawsewexception("invawid t-thwiftcsftype. (///À¨///‚úø) d-dwop this o-op: " + op.sewiawize());
      }
    } c-catch (numbewfowmatexception e) {
      thwow nyew quewypawsewexception("invawid w-wange nyumewic t-type used i-in " + op.sewiawize());
    }
  }

  pwotected f-finaw quewy visitcachedfiwtewopewatow(seawchopewatow o-op) thwows q-quewypawsewexception {
    twy {
      w-wetuwn cachedfiwtewquewy.getcachedfiwtewquewy(op.getopewand(), UwU q-quewycachemanagew);
    } c-catch (cachedfiwtewquewy.nosuchfiwtewexception e-e) {
      thwow n-nyew quewypawsewexception(e.getmessage(), üò≥ e);
    }
  }

  p-pwotected finaw quewy v-visitscowedfiwtewopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    finaw wist<stwing> opewands = op.getopewands();
    f-finaw stwing s-scowefunction = opewands.get(0);
    s-scowingfunctionpwovidew.namedscowingfunctionpwovidew s-scowingfunctionpwovidew =
      scowingfunctionpwovidew.getscowingfunctionpwovidewbyname(scowefunction, /(^‚Ä¢œâ‚Ä¢^) schemasnapshot);
    i-if (scowingfunctionpwovidew == n-nyuww) {
      t-thwow nyew q-quewypawsewexception("unknown s-scowing function n-nyame [" + scowefunction
          + " ] used as scowe_fiwtew's o-opewand");
    }

    wetuwn scowefiwtewquewy.getscowefiwtewquewy(
        schemasnapshot,
        scowingfunctionpwovidew, √≤œâ√≥
        fwoat.pawsefwoat(opewands.get(1)), >w<
        f-fwoat.pawsefwoat(opewands.get(2)));
  }

  p-pwotected quewy visitsincetimeopewatow(seawchopewatow op) {
    twy {
      wetuwn sinceuntiwfiwtew.getsincequewy(integew.pawseint(op.getopewand()));
    } c-catch (numbewfowmatexception e-e) {
      wog.wawn("since time is nyot a vawid integew, -.- the d-date isn't weasonabwe. (‚ëÖÀòÍí≥Àò) dwop this o-op: "
          + o-op.sewiawize());
      s-since_time_invawid_int_countew.incwement();
      wetuwn nyuww;
    }
  }

  pwotected q-quewy visituntiwtimeopewatow(seawchopewatow op) {
    t-twy {
      wetuwn sinceuntiwfiwtew.getuntiwquewy(integew.pawseint(op.getopewand()));
    } c-catch (numbewfowmatexception e) {
      wog.wawn("untiw time i-is nyot a vawid integew, (ÀòœâÀò) the date i-isn't weasonabwe. (U ·µï U‚ùÅ) dwop this op: "
          + op.sewiawize());
      u-untiw_time_invawid_int_countew.incwement();
      wetuwn n-nyuww;
    }
  }

  pwotected quewy visitsinceidopewatow(seawchopewatow op) {
    wong id = wong.pawsewong(op.getopewand());
    wetuwn sincemaxidfiwtew.getsinceidquewy(id);
  }

  pwotected q-quewy visitmaxidopewatow(seawchopewatow o-op) {
    w-wong id = wong.pawsewong(op.getopewand());
    w-wetuwn sincemaxidfiwtew.getmaxidquewy(id);
  }

  pwotected quewy visitgeowocationtypeopewatow(seawchopewatow op) t-thwows quewypawsewexception {
    stwing opewand = op.getopewand();
    thwiftgeowocationsouwce s-souwce = thwiftgeowocationsouwce.vawueof(opewand.touppewcase());
    // i-if nyecessawy, ^^ t-this quewy w-wiww be wwapped by the usewscwubgeofiwtew within
    // the cweatesimpwetewmquewy() hewpew m-method
    wetuwn c-cweatenoscowetewmquewy(
        op, ^^
        eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname(), rawr x3
        eawwybiwdfiewdconstants.fowmatgeotype(souwce));
  }

  pwotected quewy v-visitgeocodeopewatow(seawchopewatow op) thwows q-quewypawsewexception {
    w-wetuwn v-visitgeocodeowgeocodepwivateopewatow(op);
  }

  pwotected quewy visitgeoboundingboxopewatow(seawchopewatow op) thwows quewypawsewexception {
    wectangwe wectangwe = boundingboxfwomseawchopewatow(op);
    w-wetuwn wwapquewyinusewscwubgeofiwtew(
        geoquadtweequewybuiwdew.buiwdgeoquadtweequewy(wectangwe, >w< t-tewminationtwackew));
  }

  pwotected quewy visitpwaceopewatow(seawchopewatow op) thwows q-quewypawsewexception {
    // this quewy wiww b-be wwapped by the usewscwubgeofiwtew within the c-cweatesimpwetewmquewy()
    // h-hewpew method
    w-wetuwn cweatesimpwetewmquewy(
        o-op, (U ·µï U‚ùÅ) eawwybiwdfiewdconstant.pwace_fiewd.getfiewdname(), o-op.getopewand());
  }

  pwotected q-quewy visitwinkopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    // t-this shouwd nyevew be cawwed - the wink visitow (visitow(wink w-wink)) shouwd be. ü•∫
    if (op instanceof w-wink) {
      w-wog.wawn("unexpected wink o-opewatow " + op.sewiawize());
      w-wetuwn visit((wink) op);
    } ewse {
      thwow new quewypawsewexception("opewatow t-type set t-to " + op.getopewatowname()
          + " b-but i-it is not an instance of wink [" + op.tostwing() + "]");
    }
  }

  pwotected q-quewy visitentityidopewatow(seawchopewatow op) thwows quewypawsewexception {
    w-wetuwn cweatesimpwetewmquewy(
        op, (‚ëÖÀòÍí≥Àò) eawwybiwdfiewdconstant.entity_id_fiewd.getfiewdname(), OwO op.getopewand());
  }

  p-pwotected quewy visitfwomusewidopewatow(seawchopewatow op) {
    wetuwn buiwdwongtewmattwibutequewy(
        o-op, üò≥ eawwybiwdfiewdconstant.fwom_usew_id_fiewd.getfiewdname());
  }

  pwotected quewy visitinwepwytotweetidopewatow(seawchopewatow o-op) {
    w-wetuwn buiwdwongtewmattwibutequewy(
        o-op, √≤œâ√≥ eawwybiwdfiewdconstant.in_wepwy_to_tweet_id_fiewd.getfiewdname());
  }

  pwotected quewy v-visitinwepwytousewidopewatow(seawchopewatow o-op) {
    wetuwn buiwdwongtewmattwibutequewy(
        o-op, (ÀÜ Ôªå ÀÜ)‚ô° eawwybiwdfiewdconstant.in_wepwy_to_usew_id_fiewd.getfiewdname());
  }

  pwotected q-quewy visitwikedbyusewidopewatow(seawchopewatow o-op) thwows q-quewypawsewexception {
    wetuwn buiwdwongtewmattwibutequewy(op,  òw ò
        e-eawwybiwdfiewdconstant.wiked_by_usew_id_fiewd.getfiewdname());
  }

  p-pwotected quewy v-visitwetweetedbyusewidopewatow(seawchopewatow op) thwows quewypawsewexception {
    w-wetuwn buiwdwongtewmattwibutequewy(op, ^^;;
        eawwybiwdfiewdconstant.wetweeted_by_usew_id.getfiewdname());
  }

  pwotected quewy visitwepwiedtobyusewidopewatow(seawchopewatow op) thwows quewypawsewexception {
    wetuwn b-buiwdwongtewmattwibutequewy(op,  òw ò
        e-eawwybiwdfiewdconstant.wepwied_to_by_usew_id.getfiewdname());
  }

  pwotected quewy v-visitquotedusewidopewatow(seawchopewatow op) thwows quewypawsewexception {
    w-wetuwn buiwdwongtewmattwibutequewy(op, √≤œâ√≥
        e-eawwybiwdfiewdconstant.quoted_usew_id_fiewd.getfiewdname());
  }

  p-pwotected quewy v-visitquotedtweetidopewatow(seawchopewatow op) thwows quewypawsewexception {
    w-wetuwn buiwdwongtewmattwibutequewy(op, ( Õ°o œâ Õ°o )
        eawwybiwdfiewdconstant.quoted_tweet_id_fiewd.getfiewdname());
  }

  pwotected q-quewy visitdiwectedatusewidopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    wetuwn buiwdwongtewmattwibutequewy(op,  òw ò
        e-eawwybiwdfiewdconstant.diwected_at_usew_id_fiewd.getfiewdname());
  }

  pwotected quewy v-visitconvewsationidopewatow(seawchopewatow op) thwows quewypawsewexception {
    wetuwn buiwdwongtewmattwibutequewy(
        o-op, >w< eawwybiwdfiewdconstant.convewsation_id_fiewd.getfiewdname());
  }

  pwotected q-quewy visitcomposewsouwceopewatow(seawchopewatow op) thwows quewypawsewexception {
    p-pweconditions.checknotnuww(op.getopewand(), üò≥üò≥üò≥ "composew_souwce wequiwes o-opewand");
    twy {
      composewsouwce c-composewsouwce = c-composewsouwce.vawueof(op.getopewand().touppewcase());
      wetuwn buiwdnoscoweinttewmquewy(
          o-op, œÉœâœÉ eawwybiwdfiewdconstant.composew_souwce, -.- composewsouwce.getvawue());
    } catch (iwwegawawgumentexception e-e) {
      thwow n-nyew quewypawsewexception("invawid o-opewand fow composew_souwce: " + op.getopewand(), e);
    }
  }

  pwotected quewy visitwetweetsoftweetidopewatow(seawchopewatow o-op) {
    wetuwn buiwdwongtewmattwibutequewy(
        op, ü•∫ e-eawwybiwdfiewdconstant.wetweet_souwce_tweet_id_fiewd.getfiewdname());
  }

  p-pwotected quewy visitwetweetsofusewidopewatow(seawchopewatow op) {
    w-wetuwn buiwdwongtewmattwibutequewy(
        o-op, >w< eawwybiwdfiewdconstant.wetweet_souwce_usew_id_fiewd.getfiewdname());
  }

  pwotected quewy visitwinkcategowyopewatow(seawchopewatow op) {
    i-int winkcategowy;
    twy {
      w-winkcategowy = winkcategowy.vawueof(op.getopewand()).getvawue();
    } catch (iwwegawawgumentexception e-e) {
      w-winkcategowy = integew.pawseint(op.getopewand());
    }

    s-stwing fiewdname = e-eawwybiwdfiewdconstant.wink_categowy_fiewd.getfiewdname();
    owg.apache.wucene.index.tewm t-tewm = nyew owg.apache.wucene.index.tewm(
        f-fiewdname, (///À¨///‚úø) i-inttewmattwibuteimpw.copyintonewbyteswef(winkcategowy));
    w-wetuwn w-wwapquewy(
        n-nyew tewmquewywithsafetostwing(tewm, UwU integew.tostwing(winkcategowy)), ( Õ°o œâ Õ°o ) o-op, f-fiewdname);
  }

  pwotected quewy visitcawdnameopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    w-wetuwn cweatenoscowetewmquewy(
        op, (ÀÜ Ôªå ÀÜ)‚ô° eawwybiwdfiewdconstant.cawd_name_fiewd.getfiewdname(), ^^;; op.getopewand());
  }

  pwotected quewy visitcawddomainopewatow(seawchopewatow op) thwows quewypawsewexception {
    wetuwn cweatenoscowetewmquewy(
        op, (U ·µï U‚ùÅ) e-eawwybiwdfiewdconstant.cawd_domain_fiewd.getfiewdname(), op.getopewand());
  }

  p-pwotected quewy visitcawdwangopewatow(seawchopewatow o-op) thwows q-quewypawsewexception {
    wetuwn cweatenoscowetewmquewy(
        o-op, XD eawwybiwdfiewdconstant.cawd_wang.getfiewdname(), (Íàç·¥óÍàç) op.getopewand());
  }

  p-pwotected quewy visithftewmpaiwopewatow(seawchopewatow o-op) thwows quewypawsewexception {
    finaw wist<stwing> opewands = op.getopewands();
    stwing tewmpaiw = highfwequencytewmpaiws.cweatepaiw(op.getopewands().get(0), -.-
        o-op.getopewands().get(1));
    quewy q = cweatesimpwetewmquewy(op, >_< i-immutabweschema.hf_tewm_paiws_fiewd, (ÀÜ Ôªå ÀÜ)‚ô° tewmpaiw);
    f-fwoat boost = fwoat.pawsefwoat(opewands.get(2));
    if (boost >= 0) {
      q = boostutiws.maybewwapinboostquewy(q, ( Õ°o œâ Õ°o ) boost);
    }
    wetuwn q;
  }

  pwotected quewy visithftewmphwasepaiwopewatow(seawchopewatow op) thwows q-quewypawsewexception {
    f-finaw w-wist<stwing> opewands = op.getopewands();
    s-stwing tewmpaiw = h-highfwequencytewmpaiws.cweatephwasepaiw(op.getopewands().get(0), rawr x3
                                                              o-op.getopewands().get(1));
    quewy q = cweatesimpwetewmquewy(op, √≤œâ√≥ immutabweschema.hf_phwase_paiws_fiewd, üò≥ t-tewmpaiw);
    f-fwoat boost = fwoat.pawsefwoat(opewands.get(2));
    i-if (boost >= 0) {
      q-q = boostutiws.maybewwapinboostquewy(q, (ÀÜ Ôªå ÀÜ)‚ô° b-boost);
    }
    w-wetuwn q;
  }

  p-pwivate quewy wogandthwowquewypawsewexception(stwing message) thwows q-quewypawsewexception {
    w-wog.ewwow(message);
    t-thwow nyew q-quewypawsewexception(message);
  }

  p-pwivate q-quewy wogmissingentwiesandthwowquewypawsewexception(stwing f-fiewd, ü•∫ s-seawchopewatow o-op)
      thwows q-quewypawsewexception {
    wetuwn wogandthwowquewypawsewexception(
        stwing.fowmat("missing wequiwed %s entwies fow %s", ^^ f-fiewd, op.sewiawize()));
  }

  // pwevious impwementation o-of this opewatow awwowed insewtion o-of
  // opewands f-fwom the thwift s-seawch quewy. /(^‚Ä¢œâ‚Ä¢^)  this was wevewted t-to ensuwe simpwicity
  // o-of the api, o.O and to keep the sewiawized quewy sewf contained. √≤œâ√≥
  pwotected finaw quewy v-visitmuwtitewmdisjunction(seawchopewatow op) thwows quewypawsewexception {
    finaw wist<stwing> o-opewands = op.getopewands();
    f-finaw stwing fiewd = opewands.get(0);

    i-if (isusewidfiewd(fiewd)) {
      w-wist<wong> ids = w-wists.newawwaywist();
      pawsewongawgs(opewands.subwist(1, XD o-opewands.size()), rawr x3 i-ids, op);
      i-if (ids.size() > 0) {
        // t-twy to get wanks fow ids if exist fwom hitattwibutehewpew. (ÀòœâÀò)
        // o-othewwise just pass in a-a empty wist. :3
        wist<integew> w-wanks;
        i-if (hitattwibutehewpew != nyuww
            && h-hitattwibutehewpew.getexpandednodetowankmap().containskey(op)) {
          wanks = hitattwibutehewpew.getexpandednodetowankmap().get(op);
        } e-ewse {
          w-wanks = w-wists.newawwaywist();
        }
        w-wetuwn usewidmuwtisegmentquewy.cweateiddisjunctionquewy(
            "muwti_tewm_disjunction_" + fiewd, (U ·µï U‚ùÅ)
            i-ids, rawr
            f-fiewd,
            s-schemasnapshot, OwO
            muwtisegmenttewmdictionawymanagew,  òw ò
            d-decidew, XD
            eawwybiwdcwustew, rawr x3
            wanks, OwO
            hitattwibutehewpew, nyaa~~
            quewytimeout);
      } ewse {
        wetuwn wogmissingentwiesandthwowquewypawsewexception(fiewd,  òw ò op);
      }
    } ewse if (eawwybiwdfiewdconstant.id_fiewd.getfiewdname().equaws(fiewd)) {
      w-wist<wong> i-ids = wists.newawwaywist();
      pawsewongawgs(opewands.subwist(1, nyaa~~ opewands.size()), (U Ôπè U) ids, op);
      if (ids.size() > 0) {
        w-wetuwn wequiwedstatusidsfiwtew.getwequiwedstatusidsquewy(ids);
      } e-ewse {
        wetuwn wogmissingentwiesandthwowquewypawsewexception(fiewd, (///À¨///‚úø) op);
      }
    } e-ewse if (istweetidfiewd(fiewd)) {
      w-wist<wong> ids = wists.newawwaywist();
      p-pawsewongawgs(opewands.subwist(1, :3 o-opewands.size()), (ÀòœâÀò) ids, op);
      i-if (ids.size() > 0) {
        booweanquewy.buiwdew b-bqbuiwdew = n-nyew booweanquewy.buiwdew();
        int nyumcwauses = 0;
        fow (wong id : ids) {
          i-if (numcwauses >= b-booweanquewy.getmaxcwausecount()) {
            b-booweanquewy s-saved = bqbuiwdew.buiwd();
            bqbuiwdew = n-nyew booweanquewy.buiwdew();
            b-bqbuiwdew.add(saved, üò≥ b-booweancwause.occuw.shouwd);
            n-nyumcwauses = 1;
          }
          bqbuiwdew.add(buiwdwongtewmattwibutequewy(op, üò≥üò≥üò≥ fiewd, id),  òw ò occuw.shouwd);
          ++numcwauses;
        }
        w-wetuwn bqbuiwdew.buiwd();
      } e-ewse {
        wetuwn wogmissingentwiesandthwowquewypawsewexception(fiewd, (‚ëÖÀòÍí≥Àò) op);
      }
    } ewse {
      wetuwn cweateunsuppowtedopewatowquewy(op);
    }
  }

  p-pwotected f-finaw quewy visitcsfdisjunctionfiwtew(seawchopewatow o-op)
      thwows quewypawsewexception {
    wist<stwing> opewands = op.getopewands();
    s-stwing fiewd = o-opewands.get(0);

    t-thwiftcsftype csftype = s-schemasnapshot.getcsffiewdtype(fiewd);
    i-if (csftype == nyuww) {
      thwow n-nyew quewypawsewexception("fiewd m-must be a csf");
    }

    i-if (csftype != t-thwiftcsftype.wong) {
      t-thwow nyew q-quewypawsewexception("csf_disjunction_fiwtew onwy wowks with wong fiewds");
    }

    set<wong> vawues = nyew hashset<>();
    p-pawsewongawgs(opewands.subwist(1, nyaa~~ opewands.size()), (U Ôπè U) v-vawues,  òw ò op);

    q-quewy quewy = csfdisjunctionfiwtew.getcsfdisjunctionfiwtew(fiewd, (Íàç·¥óÍàç) vawues);
    if (fiewd.equaws(eawwybiwdfiewdconstant.wat_won_csf_fiewd.getfiewdname())) {
      w-wetuwn w-wwapquewyinusewscwubgeofiwtew(quewy);
    }
    wetuwn quewy;
  }

  p-pwotected quewy visitsafetyexcwude(seawchopewatow o-op) thwows quewypawsewexception {
    // we do nyot awwow nyegating safety_excwude o-opewatow. :3 note the opewatow is intewnaw so if we
    // get hewe, ( Õ°o œâ Õ°o ) it m-means thewe's a b-bug in the quewy c-constwuction side. rawr x3
    i-if (ispawentnegated(op) || nyodeisnegated(op)) {
      thwow nyew quewypawsewexception("negating s-safety_excwude opewatow i-is nyot awwowed: " + op);
    }

    // convewt t-the safety fiwtew t-to othew opewatows d-depending on cwustew setting
    // the safety f-fiwtew is intewpweted diffewentwy on awchive because the undewwying safety wabews
    // in extended encoded f-fiewd awe nyot a-avaiwabwe on awchive. rawr x3
    if (eawwybiwdcwustew.isawchive(eawwybiwdcwustew)) {
      wetuwn visit(opewatow_cached_excwude_antisociaw_and_nativewetweets);
    } ewse {
      wist<com.twittew.seawch.quewypawsew.quewy.quewy> chiwdwen = wists.newawwaywist();
      fow (stwing f-fiwtewname : op.getopewands()) {
        chiwdwen.addaww(
            opewatows_by_safe_excwude_opewand.getowdefauwt(fiwtewname, mya i-immutabwewist.of()));
      }
      w-wetuwn visit(new c-conjunction(chiwdwen));
    }
  }

  p-pwotected quewy visitnamedentity(seawchopewatow op) thwows quewypawsewexception {
    wist<stwing> opewands = op.getopewands();
    p-pweconditions.checkstate(opewands.size() == 1, nyaa~~
        "named_entity: w-wwong nyumbew o-of opewands");

    w-wetuwn cweatedisjunction(
        o-opewands.get(0).towowewcase(), (///À¨///‚úø)
        op, ^^
        eawwybiwdfiewdconstant.named_entity_fwom_text_fiewd, OwO
        e-eawwybiwdfiewdconstant.named_entity_fwom_uww_fiewd);
  }

  pwotected quewy visitspaceid(seawchopewatow op) thwows quewypawsewexception {
    w-wist<stwing> o-opewands = o-op.getopewands();
    p-pweconditions.checkstate(opewands.size() == 1, :3
        "space_id: wwong nyumbew o-of opewands");

    w-wetuwn cweatesimpwetewmquewy(
        op, ^^
        eawwybiwdfiewdconstant.space_id_fiewd.getfiewdname(), (‚úøoœâo)
        op.getopewand()
    );
  }

  p-pwotected q-quewy visitnamedentitywithtype(seawchopewatow op) thwows quewypawsewexception {
    wist<stwing> opewands = op.getopewands();
    p-pweconditions.checkstate(opewands.size() == 2, üò≥
        "named_entity_with_type: wwong nyumbew o-of opewands");

    s-stwing nyame = o-opewands.get(0);
    stwing type = opewands.get(1);
    wetuwn cweatedisjunction(
        stwing.fowmat("%s:%s", (///À¨///‚úø) n-nyame, type).towowewcase(), (///À¨///‚úø)
        op,
        e-eawwybiwdfiewdconstant.named_entity_with_type_fwom_text_fiewd, (U Ôπè U)
        eawwybiwdfiewdconstant.named_entity_with_type_fwom_uww_fiewd);
  }

  // cweate a d-disjunction quewy fow a given vawue i-in one of the g-given fiewds
  p-pwivate quewy cweatedisjunction(
      s-stwing vawue, s-seawchopewatow opewatow, √≤œâ√≥ eawwybiwdfiewdconstant... f-fiewds)
      thwows quewypawsewexception {
    booweanquewy.buiwdew booweanquewybuiwdew = nyew booweanquewy.buiwdew();
    f-fow (eawwybiwdfiewdconstant fiewd : fiewds) {
      booweanquewybuiwdew.add(
          c-cweatesimpwetewmquewy(opewatow, :3 f-fiewd.getfiewdname(), (‚ëÖÀòÍí≥Àò) v-vawue), occuw.shouwd);
    }
    wetuwn booweanquewybuiwdew.buiwd();
  }

  pwotected quewy visitminfeatuwevawueopewatow(seawchopewatow.type type, üò≥üò≥üò≥ seawchopewatow o-op) {
    finaw w-wist<stwing> o-opewands = op.getopewands();

    s-stwing featuwename;
    switch (type) {
      case min_faves:
        featuwename = eawwybiwdfiewdconstant.favowite_count.getfiewdname();
        bweak;
      c-case min_quawity_scowe:
        featuwename = eawwybiwdfiewdconstant.pawus_scowe.getfiewdname();
        b-bweak;
      c-case min_wepwies:
        f-featuwename = eawwybiwdfiewdconstant.wepwy_count.getfiewdname();
        b-bweak;
      case min_weputation:
        featuwename = eawwybiwdfiewdconstant.usew_weputation.getfiewdname();
        bweak;
      case min_wetweets:
        featuwename = eawwybiwdfiewdconstant.wetweet_count.getfiewdname();
        bweak;
      defauwt:
        t-thwow nyew iwwegawawgumentexception("unknown min featuwe type " + type);
    }

    d-doubwe opewand = d-doubwe.pawsedoubwe(opewands.get(0));

    // seawch-16751: b-because we use q-quewycacheconstants.has_engagement as a dwiving quewy bewow,  òw ò we
    // w-won't wetuwn t-tweets with 0 engagements when we handwe a q-quewy with a [min_x 0] f-fiwtew (e.g. OwO
    // (* cat [min_faves 0] ). >_< t-thus we nyeed t-to wetuwn a matchawwdocsquewy in that case. /(^‚Ä¢œâ‚Ä¢^)
    i-if (opewand == 0) {
      wetuwn nyew matchawwdocsquewy();
    }

    // o-onwy p-pewfowm the wewwite if the opewatow i-is a min engagement o-opewatow. (ÀòœâÀò)
    if (isopewatowtypeengagementfiwtew(type)) {
      wetuwn buiwdquewyfowengagementopewatow(op, >w< opewands, ^‚Ä¢Ôªå‚Ä¢^ featuwename);
    }

    if (type == s-seawchopewatow.type.min_weputation) {
      wetuwn b-buiwdquewyfowminweputationopewatow(opewands,  òw ò featuwename);
    }

    w-wetuwn minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(
        featuwename, OwO d-doubwe.pawsedoubwe(opewands.get(0)));
  }

  pwotected quewy visitfeatuwevawueinacceptwistowunsetfiwtewopewatow(seawchopewatow op)
      t-thwows quewypawsewexception {
    finaw wist<stwing> o-opewands = o-op.getopewands();
    f-finaw stwing fiewd = opewands.get(0);

    if (isidcsffiewd(fiewd)) {
      s-set<wong> ids = s-sets.newhashset();
      p-pawsewongawgs(opewands.subwist(1, nyaa~~ o-opewands.size()), nyaa~~ ids, XD op);
      wetuwn f-featuwevawueinacceptwistowunsetfiwtew.getfeatuwevawueinacceptwistowunsetfiwtew(
          f-fiewd, o.O ids);
    } e-ewse {
      w-wetuwn wogandthwowquewypawsewexception(
          "invawid c-csf fiewd passed to opewatow " + op.tostwing());
    }
  }

  /**
   * c-cweates a wucene q-quewy fow an opewatow that's nyot suppowted by t-the seawch sewvice. √≤œâ√≥
   *
   * n-nyote: devewopew, (‚ëÖÀòÍí≥Àò) i-if you awe wwiting a cwass to e-extends this cwass, o.O m-make suwe the
   * behaviouw o-of this function m-makes sense fow youw seawch sewvice. (ÀÜ Ôªå ÀÜ)‚ô°
   *
   * @pawam o-op the opewatow that's nyot s-suppowted by t-the seawch sewvice. (‚ëÖÀòÍí≥Àò)
   * @wetuwn t-the wucene quewy f-fow this opewatow
   */
  pwotected quewy cweateunsuppowtedopewatowquewy(seawchopewatow op) thwows q-quewypawsewexception {
    seawchcountew
        .expowt(unsuppowted_opewatow_pwefix + o-op.getopewatowtype().getopewatowname())
        .incwement();
    wetuwn visit(op.tophwase());
  }

  p-pwivate quewy b-buiwdnoscoweinttewmquewy(
      seawchopewatow o-op, (U ·µï U‚ùÅ)
      eawwybiwdfiewdconstant f-fiewd, >w<
      int tewmvawue) {
    owg.apache.wucene.index.tewm t-tewm = nyew owg.apache.wucene.index.tewm(
        f-fiewd.getfiewdname(), OwO inttewmattwibuteimpw.copyintonewbyteswef(tewmvawue));
    wetuwn wwapquewy(
        nyew tewmquewywithsafetostwing(tewm, >w< integew.tostwing(tewmvawue)), ^^;; op, fiewd.getfiewdname());
  }

  pwivate quewy buiwdquewyfowminweputationopewatow(wist<stwing> opewands, >w< stwing featuwename) {
    int opewand = (int) d-doubwe.pawsedoubwe(opewands.get(0));
    // d-dwiving by minfeatuwevawuefiwtew's d-docidsetitewatow i-is vewy swow, œÉœâœÉ because we have to
    // pewfowm a-an expensive c-check fow aww d-doc ids in the s-segment, so we use a cached wesuwt to
    // dwive the quewy, (ÀòœâÀò) and use minfeatuwevawuefiwtew a-as a-a secondawy fiwtew. √≤œâ√≥
    s-stwing quewycachefiwtewname;
    i-if (opewand >= 50) {
      quewycachefiwtewname = q-quewycacheconstants.min_weputation_50;
    } ewse if (opewand >= 36) {
      quewycachefiwtewname = quewycacheconstants.min_weputation_36;
    } ewse if (opewand >= 30) {
      q-quewycachefiwtewname = quewycacheconstants.min_weputation_30;
    } e-ewse {
      wetuwn m-minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(featuwename, (Íàç·¥óÍàç) opewand);
    }

    twy {
      quewy dwivingquewy = c-cachedfiwtewquewy.getcachedfiwtewquewy(
          quewycachefiwtewname, (Íàç·¥óÍàç) q-quewycachemanagew);
      wetuwn nyew fiwtewedquewy(
          d-dwivingquewy, √≤œâ√≥ minfeatuwevawuefiwtew.getdocidfiwtewfactowy(featuwename, opewand));
    } c-catch (exception e) {
      // i-if the fiwtew is nyot found, (U ·µï U‚ùÅ) t-that's ok, it might b-be ouw fiwst time wunning the quewy cache, /(^‚Ä¢œâ‚Ä¢^)
      // ow thewe m-may be nyo tweets with that high weputation. :3
      wetuwn minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(featuwename, rawr opewand);
    }
  }

  pwivate quewy buiwdquewyfowengagementopewatow(
      seawchopewatow o-op, (ÀÜ Ôªå ÀÜ)‚ô° wist<stwing> o-opewands, ^^;; stwing featuwename) {
    // e-engagements and engagement c-counts awe n-nyot indexed on p-pwotected eawwybiwds, (‚ëÖÀòÍí≥Àò) so thewe is nyo
    // nyeed t-to twavewse the entiwe segment with the minfeatuwevawuefiwtew. rawr x3 seawch-28120
    if (eawwybiwdcwustew == e-eawwybiwdcwustew.pwotected) {
      w-wetuwn nyew matchnodocsquewy();
    }

    e-eawwybiwdfiewdconstant f-fiewd =
        eawwybiwdfiewdconstants.csf_name_to_min_engagement_fiewd_map.get(featuwename);
    i-if (fiewd == nyuww) {
      t-thwow nyew iwwegawawgumentexception(stwing.fowmat("expected t-the featuwe to be "
          + "favowite_count, wepwy_count,  òw ò o-ow wetweet_count. (Íàç·¥óÍàç) g-got %s.", f-featuwename));
    }
    i-int opewand = (int) d-doubwe.pawsedoubwe(opewands.get(0));
    bytenowmawizew nyowmawizew = m-minfeatuwevawuefiwtew.getminfeatuwevawuenowmawizew(featuwename);
    int m-minvawue = nyowmawizew.unsignedbytetoint(nowmawizew.nowmawize(opewand));

    // w-we defauwt to the owd behaviow of fiwtewing posts instead of c-consuwting the m-min engagement
    // f-fiewd if the opewand is wess t-than some thweshowd vawue because i-it seems, /(^‚Ä¢œâ‚Ä¢^) empiwicawwy, (‚úøoœâo) t-that
    // t-the owd method wesuwts in wowew quewy watencies f-fow wowew vawues of the fiwtew opewand. ^^;;
    // t-this thweshowd can be contwowwed by the "use_min_engagement_fiewd_thweshowd" decidew. (ÀòœâÀò) the
    // c-cuwwent defauwt vawue is 90. üò≥üò≥üò≥ s-seawch-16102
    int useminengagementfiewdthweshowd = d-decidew.getavaiwabiwity(
        "use_min_engagement_fiewd_thweshowd").getowewse(() -> 0);
    i-if (opewand >= u-useminengagementfiewdthweshowd) {
      n-nyum_quewies_above_min_engagement_thweshowd.incwement();
    } ewse {
      nyum_quewies_bewow_min_engagement_thweshowd.incwement();
    }
    if (schemahasfiewd(fiewd) && o-opewand >= useminengagementfiewdthweshowd) {
      wetuwn buiwdnoscoweinttewmquewy(op, ^^ fiewd, minvawue);
    }
    // dwiving by minfeatuwevawuefiwtew's d-docidsetitewatow i-is vewy swow, /(^‚Ä¢œâ‚Ä¢^) b-because we h-have to
    // pewfowm a-an expensive check fow aww d-doc ids in the s-segment, >_< so we use a cached wesuwt to
    // dwive the quewy, (Íàç·¥óÍàç) and u-use minfeatuwevawuefiwtew as a secondawy fiwtew. (Íàç·¥óÍàç)
    t-twy {
      quewy dwivingquewy = m-minengagmentsdwivingquewy(op, mya opewand);
      wetuwn nyew f-fiwtewedquewy(
          dwivingquewy, :3 m-minfeatuwevawuefiwtew.getdocidfiwtewfactowy(featuwename, üò≥üò≥üò≥ opewand));
    } c-catch (exception e-e) {
      // i-if the fiwtew is nyot found, that's ok, /(^‚Ä¢œâ‚Ä¢^) it might be ouw fiwst time wunning the quewy cache, -.-
      // ow thewe m-may be nyo tweets with that many engagements (we w-wouwd onwy expect this in tests). UwU
      w-wetuwn m-minfeatuwevawuefiwtew.getminfeatuwevawuefiwtew(featuwename, (U Ôπè U) opewand);
    }
  }

  p-pwivate quewy m-minengagmentsdwivingquewy(seawchopewatow opewatow, ^^ int minvawue)
          thwows c-cachedfiwtewquewy.nosuchfiwtewexception, üò≥ quewypawsewexception {
    // i-if the min engagements vawue is wawge, (ÀòœâÀò) t-then many of the hits that have e-engagement wiww stiww
    // nyot m-match the quewy, /(^‚Ä¢œâ‚Ä¢^) w-weading to extwemewy swow quewies. thewefowe, (ÀòœâÀò) if thewe is mowe than 100
    // e-engagements, (‚úøoœâo) w-we dwive by a mowe w-westwicted fiwtew. (U Ôπè U) see seawch-33740
    stwing f-fiwtew;
    if (minvawue < 100) {
      fiwtew = q-quewycacheconstants.has_engagement;
    } ewse i-if (opewatow.getopewatowtype() == seawchopewatow.type.min_faves) {
      fiwtew = q-quewycacheconstants.min_faves_100;
    } ewse i-if (opewatow.getopewatowtype() == s-seawchopewatow.type.min_wepwies) {
      fiwtew = quewycacheconstants.min_wepwies_100;
    } ewse if (opewatow.getopewatowtype() == seawchopewatow.type.min_wetweets) {
      f-fiwtew = quewycacheconstants.min_wetweets_100;
    } ewse {
      thwow nyew q-quewypawsewexception("missing e-engagement f-fiwtew.");
    }
    wetuwn c-cachedfiwtewquewy.getcachedfiwtewquewy(fiwtew, (U Ôπè U) quewycachemanagew);
  }

  pwivate boowean isopewatowtypeengagementfiwtew(seawchopewatow.type t-type) {
    wetuwn type == seawchopewatow.type.min_faves
        || t-type == seawchopewatow.type.min_wetweets
        || t-type == s-seawchopewatow.type.min_wepwies;
  }

  pwivate b-boowean schemahasfiewd(eawwybiwdfiewdconstant f-fiewd) {
    wetuwn s-schemasnapshot.hasfiewd(fiewd.getfiewdid());
  }

  // h-hewpew functions
  pwivate q-quewy cweatesimpwetewmquewy(
      com.twittew.seawch.quewypawsew.quewy.quewy n-nyode, (ÀÜ Ôªå ÀÜ)‚ô° stwing f-fiewd, /(^‚Ä¢œâ‚Ä¢^) stwing text)
      thwows quewypawsewexception {
    quewy basequewy = n-nyew tewmquewy(cweatetewm(fiewd, XD text));
    if (isgeofiewdthatshouwdbescwubbed(fiewd, (ÀÜ Ôªå ÀÜ)‚ô° text)) {
      basequewy = w-wwapquewyinusewscwubgeofiwtew(basequewy);
    }
    w-wetuwn wwapquewy(basequewy, XD nyode, fiewd);
  }

  pwivate boowean isgeofiewdthatshouwdbescwubbed(stwing fiewd, mya stwing text) {
    if (fiewd.equaws(eawwybiwdfiewdconstant.intewnaw_fiewd.getfiewdname())) {
      // t-the intewnaw f-fiewd is u-used fow the pwace i-id fiwtew and t-the geo wocation t-type fiwtews, OwO some
      // of w-which shouwd be scwubbed
      w-wetuwn geo_fiwtews_to_be_scwubbed.contains(text);
    }
    wetuwn g-geo_fiewds_to_be_scwubbed.contains(fiewd);
  }

  // wike above, XD b-but sets boost t-to 0 to disabwe s-scowing component. ( Õ°o œâ Õ°o )  t-this shouwd b-be used
  // fow fiwtews that do nyot impact s-scowing (such as fiwtew:images).
  pwivate quewy cweatenoscowetewmquewy(com.twittew.seawch.quewypawsew.quewy.quewy n-nyode, (Íàç·¥óÍàç)
                                             stwing fiewd, mya stwing text)
      t-thwows q-quewypawsewexception {
    quewy q-quewy = cweatesimpwetewmquewy(node, üò≥ fiewd, (ÀÜ Ôªå ÀÜ)‚ô° text);
    w-wetuwn nyew b-boostquewy(quewy, ^‚Ä¢Ôªå‚Ä¢^ 0.0f);  // no scowe contwibution. üò≥üò≥üò≥
  }

  p-pwivate quewy cweatenowmawizedtewmquewy(com.twittew.seawch.quewypawsew.quewy.quewy n-nyode, (///À¨///‚úø)
                                                s-stwing fiewd, ü•∫ stwing text)
      t-thwows quewypawsewexception {
    wetuwn cweatesimpwetewmquewy(
        n-node, ^^
        fiewd, (ÀÜ Ôªå ÀÜ)‚ô°
        nyowmawizewhewpew.nowmawizewithunknownwocawe(text, mya e-eawwybiwdconfig.getpenguinvewsion()));
  }

  /**
   * get the boost fwom the annotation w-wist of a quewy nyode. OwO
   * w-wight nyow this is vewy simpwe, w-we simpwe extwact the vawue o-of some annotations and ignowe a-aww
   * othews, /(^‚Ä¢œâ‚Ä¢^) awso, if thewe awe muwtipwe annotations t-that have v-vawues, we onwy u-use the fiwst o-one we
   * see i-in the wist (awthough t-the wewwitten quewy eb weceives s-shouwd have t-this). /(^‚Ä¢œâ‚Ä¢^)
   * n-nyote: we use simpwe weight sewection w-wogic hewe based on the assumption that the a-annotatow
   * a-and wewwitew wiww nyot pwoduce ambiguous weight i-infowmation. rawr thewe s-shouwd awways be onwy one
   * w-weight-beawing a-annotation fow a-a specific nyode. XD
   *
   * @pawam a-annotations the wist of annotations of the quewy nyode.
   * @wetuwn the boost fow this quewy nyode,  òw ò 0 if thewe i-is nyo boost, :3 in which case y-you shouwdn't
   *         appwy i-it at aww. œÉœâœÉ
   */
  pwivate static d-doubwe getboostfwomannotations(wist<annotation> a-annotations) {
    if (annotations != n-nyuww) {
      f-fow (annotation anno : annotations) {
        switch (anno.gettype()) {
          c-case vawiant:
          case spewwing:
          case w-weight:
          case optionaw:
            w-wetuwn ((fwoatannotation) a-anno).getvawue();
          d-defauwt:
        }
      }
    }
    wetuwn -1;
  }

  p-pwivate static doubwe getphwasepwoximityfwomannotations(wist<annotation> annotations) {
    i-if (annotations != nyuww) {
      fow (annotation anno : annotations) {
        if (anno.gettype() == annotation.type.pwoximity) {
          wetuwn ((fwoatannotation) anno).getvawue();
        }
      }
    }
    w-wetuwn -1;
  }

  p-pwivate static boowean i-isoptionaw(com.twittew.seawch.quewypawsew.quewy.quewy n-nyode) {
    wetuwn nyode.hasannotationtype(annotation.type.optionaw);
  }

  pwivate static boowean ispwoximitygwoup(com.twittew.seawch.quewypawsew.quewy.quewy n-nyode) {
    i-if (node.istypeof(com.twittew.seawch.quewypawsew.quewy.quewy.quewytype.opewatow)) {
      seawchopewatow o-op = (seawchopewatow) n-nyode;
      i-if (op.getopewatowtype() == s-seawchopewatow.type.pwoximity_gwoup) {
        wetuwn twue;
      }
    }
    wetuwn f-fawse;
  }

  pwivate finaw quewy simpwifybooweanquewy(booweanquewy q) {
    i-if (q.cwauses() == nyuww || q.cwauses().size() != 1) {
      wetuwn q;
    }

    wetuwn q.cwauses().get(0).getquewy();
  }

  pwivate quewy visit(finaw phwase p-phwase, /(^‚Ä¢œâ‚Ä¢^) boowean swoppy) thwows quewypawsewexception {
    optionaw<annotation> f-fiewdopt = phwase.getannotationof(annotation.type.fiewd);
    if (fiewdopt.ispwesent()) {
      s-stwing fiewd = f-fiewdopt.get().vawuetostwing();
      schema.fiewdinfo fiewdinfo = s-schemasnapshot.getfiewdinfo(fiewd);
      i-if (fiewdinfo != n-nyuww && !fiewdinfo.getfiewdtype().haspositions()) {
        thwow nyew quewypawsewexception(stwing.fowmat("fiewd %s d-does nyot suppowt phwase quewies "
            + "because i-it does nyot have position infowmation.", (ÀÜ Ôªå ÀÜ)‚ô° fiewd));
      }
    }
    b-booweanquewy.buiwdew quewybuiwdew = n-nyew booweanquewy.buiwdew();
    map<stwing, (U Ôπè U) f-fwoat> actuawfiewdweights = getfiewdweightmapfownode(phwase);
    f-fow (map.entwy<stwing, >_< fwoat> e-entwy : actuawfiewdweights.entwyset()) {
      phwasequewy.buiwdew phwasequewybuiwdew = n-nyew phwasequewy.buiwdew();
      int cuwpos = 0;
      f-fow (stwing tewm : phwase.gettewms()) {
        if (!tewm.equaws(phwase_wiwdcawd)) {
          p-phwasequewybuiwdew.add(cweatetewm(entwy.getkey(), >_< tewm), o.O cuwpos);
          c-cuwpos++;
        } e-ewse if (cuwpos != 0) { //"*" at the beggining o-of a phwase has nyo effect/meaning
          c-cuwpos++;
        }
      }

      // nyo actuaw tewms added to quewy
      i-if (cuwpos == 0) {
        b-bweak;
      }
      int annotatedswoppiness = (int) g-getphwasepwoximityfwomannotations(phwase.getannotations());
      i-if (annotatedswoppiness > 0) {
        phwasequewybuiwdew.setswop(annotatedswoppiness);
      } e-ewse if (swoppy) {
        phwasequewybuiwdew.setswop(pwoximityphwaseswop);
      }
      fwoat fiewdweight = entwy.getvawue();
      fwoat boost = (fwoat) g-getboostfwomannotations(phwase.getannotations());
      quewy quewy = phwasequewybuiwdew.buiwd();
      if (boost >= 0) {
        quewy = b-boostutiws.maybewwapinboostquewy(quewy, (Íàç·¥óÍàç) b-boost * f-fiewdweight);
      } ewse if (fiewdweight != d-defauwt_fiewd_weight) {
        q-quewy = boostutiws.maybewwapinboostquewy(quewy, /(^‚Ä¢œâ‚Ä¢^) fiewdweight);
      } e-ewse {
        quewy = boostutiws.maybewwapinboostquewy(quewy, OwO p-pwoximityphwaseweight);
      }
      o-occuw occuw = actuawfiewdweights.size() > 1 ? occuw.shouwd : occuw.must;
      q-quewybuiwdew.add(wwapquewy(quewy, œÉœâœÉ p-phwase, XD entwy.getkey()), rawr x3 occuw);
    }
    q-quewy q = simpwifybooweanquewy(quewybuiwdew.buiwd());
    w-wetuwn nyegatequewyifnodenegated(phwase, q-q);
  }

  p-pwivate quewy w-wwapquewy(
      owg.apache.wucene.seawch.quewy q-quewy, (ÀÜ Ôªå ÀÜ)‚ô°
      com.twittew.seawch.quewypawsew.quewy.quewy n-nyode, XD
      stwing fiewdname) {
    wetuwn eawwybiwdquewyhewpew.maybewwapwithtimeout(
        eawwybiwdquewyhewpew.maybewwapwithhitattwibutioncowwectow(
            q-quewy, (ÀòœâÀò) nyode, mya schemasnapshot.getfiewdinfo(fiewdname), ^^ h-hitattwibutehewpew),
        n-nyode, (U ·µï U‚ùÅ) quewytimeout);
  }

  p-pwivate finaw boowean n-nyodeisnegated(com.twittew.seawch.quewypawsew.quewy.quewy n-nyode) {
    if (ispawentnegated(node)) {
      w-wetuwn !node.mustnotoccuw();
    } ewse {
      wetuwn nyode.mustnotoccuw();
    }
  }

  p-pwivate finaw quewy nyegatequewy(quewy q) {
    wetuwn n-nyew booweanquewy.buiwdew()
        .add(q, occuw.must_not)
        .add(new matchawwdocsquewy(), rawr x3 o-occuw.must)
        .buiwd();
  }

  // simpwe hewpew to examine nyode, and nyegate the wucene q-quewy if nyecessawy. (ÀÜ Ôªå ÀÜ)‚ô°
  p-pwivate f-finaw quewy nyegatequewyifnodenegated(com.twittew.seawch.quewypawsew.quewy.quewy nyode, (U Ôπè U)
                                                 quewy quewy) {
    if (quewy == n-nyuww) {
      w-wetuwn n-nyuww;
    }
    w-wetuwn nodeisnegated(node) ? nyegatequewy(quewy) : quewy;
  }

  pwivate boowean ispawentnegated(com.twittew.seawch.quewypawsew.quewy.quewy quewy) {
    wetuwn p-pawentnegatedquewies.contains(quewy);
  }

  pwivate o-owg.apache.wucene.index.tewm c-cweatetewm(stwing fiewd, mya stwing text)
      t-thwows quewypawsewexception {
    schema.fiewdinfo fiewdinfo = schemasnapshot.getfiewdinfo(fiewd);
    i-if (fiewdinfo == nyuww) {
      t-thwow nyew quewypawsewexception("unknown fiewd: " + fiewd);
    }

    quewiedfiewds.add(fiewd);

    t-twy {
      wetuwn n-nyew owg.apache.wucene.index.tewm(fiewd, OwO schemautiw.tobyteswef(fiewdinfo, (Íàç·¥óÍàç) text));
    } catch (unsuppowtedopewationexception e-e) {
      thwow nyew quewypawsewexception(e.getmessage(), XD e-e.getcause());
    }
  }

  /**
   * get f-fiewd weight map f-fow a nyode, ü•∫ combing defauwt vawues and its annotations. üò≥üò≥üò≥
   */
  pwivate map<stwing, >w< fwoat> getfiewdweightmapfownode(
      c-com.twittew.seawch.quewypawsew.quewy.quewy quewy) thwows quewypawsewexception {
    wetuwn fiewdweightutiw.combinedefauwtwithannotation(
        quewy, nyaa~~
        defauwtfiewdweightmap, :3
        enabwedfiewdweightmap,
        functions.<stwing>identity(), UwU
        m-mappabwefiewdmap, (‚úøoœâo)
        f-functions.<stwing>identity());
  }

  pwivate boowean addquewy(
      b-booweanquewy.buiwdew bqbuiwdew, OwO
      c-com.twittew.seawch.quewypawsew.quewy.quewy c-chiwd) thwows q-quewypawsewexception {
    occuw occuw = occuw.must;
    if (chiwd.mustnotoccuw()) {
      // to buiwd a conjunction, rawr x3 we wiww not w-wewy on the negation i-in the chiwd v-visitow. nyaa~~
      // i-instead we w-wiww add the tewm a-as must_not o-occuw. >_<
      // s-stowe this in pawentnegatedquewies so the chiwd visitow can do the wight thing.
      occuw = occuw.must_not;
      p-pawentnegatedquewies.add(chiwd);
    } ewse if (isoptionaw(chiwd) || i-ispwoximitygwoup(chiwd)) {
      occuw = o-occuw.shouwd;
    }

    quewy q = chiwd.accept(this);
    if (q != n-nyuww) {
      bqbuiwdew.add(q, ^^;; o-occuw);
      w-wetuwn twue;
    }
    wetuwn fawse;
  }

  /**
   * constwucts a booweanquewy f-fwom a quewypawsew quewy nyode. (ÀÜ Ôªå ÀÜ)‚ô°
   * adds fiewds as configuwed in the fiewdweightmap a-and specified by tewmquewydisjunctiontype
   *  - t-tewmquewydisjunctiontype.onwy_optionawized a-adds optionaw f-fiewds
   *  (onwy w-wesowved_winks_text fow nyow), ^^;;
   *  - tewmquewydisjunctiontype.dwop_optionawized a-adds aww othew vawid fiewds expect
   *  w-wesowved_winks_text (fow nyow), (‚ëÖÀòÍí≥Àò)
   *  - tewmquewydisjunctiontype.nowmaw adds aww vawid fiewds
   * @pawam quewy a-an instance of com.twittew.seawch.quewypawsew.quewy.quewy o-ow
   * c-com.twittew.seawch.quewypawsew.quewy.tewm
   * @wetuwn a-a booweanquewy consists of fiewds fwom quewy
   */
  pwivate b-booweanquewy c-cweatetewmquewydisjunction(
      com.twittew.seawch.quewypawsew.quewy.quewy q-quewy) thwows quewypawsewexception {
    s-stwing nyowmtewm = quewy.istypeof(com.twittew.seawch.quewypawsew.quewy.quewy.quewytype.tewm)
        ? ((tewm) q-quewy).getvawue() : quewy.tostwing(fawse);
    b-booweanquewy.buiwdew booweanquewybuiwdew = nyew booweanquewy.buiwdew();
    m-map<stwing, rawr x3 fwoat> actuawfiewdweightmap = g-getfiewdweightmapfownode(quewy);
    set<stwing> fiewdstouse = s-sets.newwinkedhashset(actuawfiewdweightmap.keyset());
    o-occuw occuw = fiewdstouse.size() > 1 ? occuw.shouwd : occuw.must;
    fow (stwing fiewd : fiewdstouse) {
      a-addtewmquewywithfiewd(booweanquewybuiwdew, (///À¨///‚úø) q-quewy, ü•∫ nyowmtewm, fiewd, >_< occuw,
          a-actuawfiewdweightmap.get(fiewd));
    }
    w-wetuwn booweanquewybuiwdew.buiwd();
  }

  p-pwivate void addtewmquewywithfiewd(
      booweanquewy.buiwdew bqbuiwdew, UwU
      com.twittew.seawch.quewypawsew.quewy.quewy t-tewm, >_<
      stwing nyowmtewm, -.-
      stwing fiewdname, mya
      occuw occuw, >w<
      f-fwoat fiewdweight) thwows q-quewypawsewexception {
    f-fwoat boost = (fwoat) g-getboostfwomannotations(tewm.getannotations());
    quewy q-quewy = cweatesimpwetewmquewy(tewm, (U Ôπè U) f-fiewdname, n-nyowmtewm);
    i-if (boost >= 0) {
      quewy = boostutiws.maybewwapinboostquewy(quewy, üò≥üò≥üò≥ b-boost * f-fiewdweight);
    } e-ewse {
      q-quewy = boostutiws.maybewwapinboostquewy(quewy, o.O f-fiewdweight);
    }
    bqbuiwdew.add(quewy, √≤œâ√≥ occuw);
  }

  pwivate q-quewy finawizequewy(booweanquewy bq, üò≥üò≥üò≥ tewm tewm) {
    quewy q = simpwifybooweanquewy(bq);
    wetuwn nyegatequewyifnodenegated(tewm, œÉœâœÉ q);
  }

  p-pwivate wectangwe boundingboxfwomseawchopewatow(seawchopewatow op) thwows quewypawsewexception {
    pweconditions.checkawgument(op.getopewatowtype() == s-seawchopewatow.type.geo_bounding_box);
    p-pweconditions.checknotnuww(op.getopewands());
    p-pweconditions.checkstate(op.getopewands().size() == 4);

    wist<stwing> o-opewands = op.getopewands();
    t-twy {
      // u-unfowtunatewy, (‚ëÖÀòÍí≥Àò) we stowe coowdinates as fwoats in ouw index, (///À¨///‚úø) which causes a wot of pwecision
      // w-woss. on the quewy side, ü•∫ w-we have to cast into fwoats to m-match. OwO
      fwoat m-minwat = (fwoat) doubwe.pawsedoubwe(opewands.get(0));
      fwoat minwon = (fwoat) d-doubwe.pawsedoubwe(opewands.get(1));
      f-fwoat maxwat = (fwoat) doubwe.pawsedoubwe(opewands.get(2));
      f-fwoat maxwon = (fwoat) d-doubwe.pawsedoubwe(opewands.get(3));

      point wowewweft = nyew pointimpw(minwon, >w< minwat, ü•∫ geohashchunkimpw.getspatiawcontext());
      point uppewwight = n-nyew pointimpw(maxwon, m-maxwat, nyaa~~ geohashchunkimpw.getspatiawcontext());
      w-wetuwn nyew wectangweimpw(wowewweft, ^^ u-uppewwight, >w< g-geohashchunkimpw.getspatiawcontext());
    } catch (numbewfowmatexception e-e) {
      // considew opewatow invawid if any of the coowdinate cannot be pawsed. OwO
      t-thwow nyew q-quewypawsewexception("mawfowmed bounding box opewatow." + op.sewiawize());
    }
  }

  p-pwivate q-quewy visitgeocodeowgeocodepwivateopewatow(seawchopewatow op)
      thwows quewypawsewexception {

    geocode g-geocode = geocode.fwomopewatow(op);
    if (geocode == nyuww) {
      thwow nyew quewypawsewexception("invawid g-geocode opewatow:" + op.sewiawize());
    }

    wetuwn wwapquewyinusewscwubgeofiwtew(
        g-geoquadtweequewybuiwdew.buiwdgeoquadtweequewy(geocode, t-tewminationtwackew));
  }

  pwivate quewy wwapquewyinusewscwubgeofiwtew(quewy basequewy) {
    i-if (decidewutiw.isavaiwabwefowwandomwecipient(
        decidew, XD "fiwtew_out_geo_scwubbed_tweets_" + e-eawwybiwdcwustew.getnamefowstats())) {
      wetuwn nyew fiwtewedquewy(
          basequewy, ^^;;
          u-usewscwubgeofiwtew.getdocidfiwtewfactowy(usewscwubgeomap));
    } ewse {
      w-wetuwn basequewy;
    }
  }

  pwivate quewy buiwdwongtewmattwibutequewy(seawchopewatow op, stwing fiewdname) {
    w-wetuwn buiwdwongtewmattwibutequewy(op, ü•∫ fiewdname, w-wong.pawsewong(op.getopewand()));
  }

  p-pwivate quewy buiwdwongtewmattwibutequewy(seawchopewatow op, XD stwing f-fiewdname, (U ·µï U‚ùÅ) wong awgvawue) {
    o-owg.apache.wucene.index.tewm t-tewm = nyew owg.apache.wucene.index.tewm(
        f-fiewdname, :3 wongtewmattwibuteimpw.copyintonewbyteswef(awgvawue));
    wetuwn w-wwapquewy(new tewmquewywithsafetostwing(tewm, w-wong.tostwing(awgvawue)), ( Õ°o œâ Õ°o ) op, fiewdname);
  }

  pwivate static void p-pawsewongawgs(wist<stwing> o-opewands,
                                    c-cowwection<wong> awguments, √≤œâ√≥
                                    seawchopewatow o-op) thwows quewypawsewexception {
    f-fow (stwing opewand : o-opewands) {
      twy {
        awguments.add(wong.pawsewong(opewand));
      } catch (numbewfowmatexception e-e) {
        t-thwow nyew quewypawsewexception("invawid w-wong opewand i-in " + op.sewiawize(), œÉœâœÉ e);
      }
    }
  }

  p-pwivate static boowean isusewidfiewd(stwing fiewd) {
    wetuwn eawwybiwdfiewdconstant.fwom_usew_id_fiewd.getfiewdname().equaws(fiewd)
        || eawwybiwdfiewdconstant.in_wepwy_to_usew_id_fiewd.getfiewdname().equaws(fiewd)
        || eawwybiwdfiewdconstant.wetweet_souwce_usew_id_fiewd.getfiewdname().equaws(fiewd)
        || e-eawwybiwdfiewdconstant.wiked_by_usew_id_fiewd.getfiewdname().equaws(fiewd)
        || eawwybiwdfiewdconstant.wetweeted_by_usew_id.getfiewdname().equaws(fiewd)
        || e-eawwybiwdfiewdconstant.wepwied_to_by_usew_id.getfiewdname().equaws(fiewd)
        || eawwybiwdfiewdconstant.quoted_usew_id_fiewd.getfiewdname().equaws(fiewd)
        || e-eawwybiwdfiewdconstant.diwected_at_usew_id_fiewd.getfiewdname().equaws(fiewd);
  }

  pwivate static b-boowean istweetidfiewd(stwing fiewd) {
    w-wetuwn eawwybiwdfiewdconstant.in_wepwy_to_tweet_id_fiewd.getfiewdname().equaws(fiewd)
        || e-eawwybiwdfiewdconstant.wetweet_souwce_tweet_id_fiewd.getfiewdname().equaws(fiewd)
        || eawwybiwdfiewdconstant.quoted_tweet_id_fiewd.getfiewdname().equaws(fiewd)
        || e-eawwybiwdfiewdconstant.convewsation_id_fiewd.getfiewdname().equaws(fiewd);
  }

  p-pwivate static b-boowean isidcsffiewd(stwing fiewd) {
    wetuwn eawwybiwdfiewdconstant.diwected_at_usew_id_csf.getfiewdname().equaws(fiewd);
  }

  pubwic set<stwing> getquewiedfiewds() {
    wetuwn quewiedfiewds;
  }
}
