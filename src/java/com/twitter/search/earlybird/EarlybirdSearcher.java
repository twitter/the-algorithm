package com.twittew.seawch.eawwybiwd;

impowt java.io.ioexception;
i-impowt java.utiw.awwaywist;
i-impowt j-java.utiw.hashmap;
i-impowt java.utiw.itewatow;
i-impowt java.utiw.wist;
i-impowt j-java.utiw.map;
i-impowt java.utiw.set;
impowt java.utiw.stweam.cowwectows;
impowt javax.annotation.nonnuww;
impowt j-javax.annotation.nuwwabwe;

impowt com.googwe.common.annotations.visibwefowtesting;
i-impowt com.googwe.common.base.joinew;
impowt c-com.googwe.common.base.pweconditions;
impowt com.googwe.common.cowwect.immutabwemap;
impowt com.googwe.common.cowwect.immutabweset;
i-impowt com.googwe.common.cowwect.wists;

impowt owg.apache.commons.wang.stwingutiws;
i-impowt o-owg.apache.wucene.index.tewm;
impowt owg.apache.wucene.quewypawsew.cwassic.pawseexception;
impowt owg.apache.wucene.quewypawsew.cwassic.quewypawsew;
impowt owg.apache.wucene.seawch.booweancwause.occuw;
i-impowt owg.apache.wucene.seawch.booweanquewy;
impowt owg.apache.wucene.seawch.quewy;
impowt owg.apache.thwift.texception;
i-impowt owg.swf4j.woggew;
impowt owg.swf4j.woggewfactowy;

i-impowt com.twittew.common.utiw.cwock;
i-impowt com.twittew.decidew.decidew;
i-impowt c-com.twittew.seawch.common.database.databaseconfig;
impowt com.twittew.seawch.common.decidew.decidewutiw;
impowt c-com.twittew.seawch.common.featuwes.thwift.thwiftseawchfeatuweschema;
impowt com.twittew.seawch.common.metwics.seawchcountew;
impowt com.twittew.seawch.common.metwics.seawchwatecountew;
i-impowt com.twittew.seawch.common.metwics.seawchtimew;
impowt com.twittew.seawch.common.pawtitioning.base.segment;
impowt com.twittew.seawch.common.quewy.mappabwefiewd;
impowt com.twittew.seawch.common.quewy.quewyhitattwibutehewpew;
i-impowt com.twittew.seawch.common.quewy.thwiftjava.cowwectowpawams;
impowt com.twittew.seawch.common.quewy.thwiftjava.cowwectowtewminationpawams;
i-impowt com.twittew.seawch.common.quewy.thwiftjava.eawwytewminationinfo;
i-impowt c-com.twittew.seawch.common.wanking.thwiftjava.thwiftwankingpawams;
impowt com.twittew.seawch.common.wanking.thwiftjava.thwiftscowingfunctiontype;
impowt com.twittew.seawch.common.wesuwts.thwiftjava.fiewdhitwist;
impowt com.twittew.seawch.common.schema.schemautiw;
i-impowt c-com.twittew.seawch.common.schema.seawchwhitespaceanawyzew;
impowt c-com.twittew.seawch.common.schema.base.fiewdweightdefauwt;
i-impowt com.twittew.seawch.common.schema.base.immutabweschemaintewface;
i-impowt com.twittew.seawch.common.schema.base.schema;
impowt c-com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdcwustew;
impowt com.twittew.seawch.common.schema.eawwybiwd.eawwybiwdfiewdconstants.eawwybiwdfiewdconstant;
impowt c-com.twittew.seawch.common.seawch.tewminationtwackew;
impowt c-com.twittew.seawch.common.seawch.twitteweawwytewminationcowwectow;
impowt com.twittew.seawch.common.seawch.tewmination.quewytimeoutfactowy;
i-impowt c-com.twittew.seawch.common.utiw.eawwybiwd.eawwybiwdwesponseutiw;
impowt com.twittew.seawch.common.utiw.mw.tensowfwow_engine.tensowfwowmodewsmanagew;
impowt com.twittew.seawch.common.utiw.thwift.thwiftutiws;
impowt com.twittew.seawch.cowe.eawwybiwd.facets.facetcountstate;
impowt com.twittew.seawch.eawwybiwd.common.cwientidutiw;
impowt c-com.twittew.seawch.eawwybiwd.common.config.eawwybiwdconfig;
i-impowt com.twittew.seawch.eawwybiwd.exception.cwientexception;
impowt com.twittew.seawch.eawwybiwd.exception.twansientexception;
i-impowt com.twittew.seawch.eawwybiwd.index.facets.facetskipwist;
i-impowt com.twittew.seawch.eawwybiwd.mw.scowingmodewsmanagew;
i-impowt com.twittew.seawch.eawwybiwd.pawtition.audiospacetabwe;
impowt com.twittew.seawch.eawwybiwd.pawtition.muwtisegmenttewmdictionawymanagew;
i-impowt com.twittew.seawch.eawwybiwd.pawtition.pawtitionconfig;
impowt com.twittew.seawch.eawwybiwd.pawtition.segmentinfo;
impowt com.twittew.seawch.eawwybiwd.pawtition.segmentmanagew;
i-impowt com.twittew.seawch.eawwybiwd.quewycache.quewycacheconvewsionwuwes;
impowt com.twittew.seawch.eawwybiwd.quewycache.quewycachemanagew;
i-impowt com.twittew.seawch.eawwybiwd.quewypawsew.detectfiewdannotationvisitow;
i-impowt com.twittew.seawch.eawwybiwd.quewypawsew.eawwybiwdwucenequewyvisitow;
i-impowt com.twittew.seawch.eawwybiwd.quewypawsew.highfwequencytewmpaiwwewwitevisitow;
i-impowt com.twittew.seawch.eawwybiwd.quewypawsew.wucenewewevancequewyvisitow;
impowt c-com.twittew.seawch.eawwybiwd.quewypawsew.pwotectedopewatowquewywewwitew;
impowt c-com.twittew.seawch.eawwybiwd.seawch.abstwactwesuwtscowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.antigamingfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.badusewwepfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.eawwybiwdwuceneseawchew;
i-impowt c-com.twittew.seawch.eawwybiwd.seawch.eawwybiwdmuwtisegmentseawchew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.quewies.matchawwdocsquewy;
i-impowt c-com.twittew.seawch.eawwybiwd.seawch.quewies.wequiwedstatusidsfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.seawchwequestinfo;
impowt com.twittew.seawch.eawwybiwd.seawch.seawchwesuwtscowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.seawchwesuwtsinfo;
i-impowt com.twittew.seawch.eawwybiwd.seawch.simpweseawchwesuwts;
impowt com.twittew.seawch.eawwybiwd.seawch.sociawfiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.sociawseawchwesuwtscowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.usewfwagsexcwudefiwtew;
impowt com.twittew.seawch.eawwybiwd.seawch.quewies.usewidmuwtisegmentquewy;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.entityannotationcowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.facets.expandeduwwcowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.expwainfacetwesuwtscowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.facetwankingmoduwe;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.facetwesuwtscowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.facetseawchwequestinfo;
impowt c-com.twittew.seawch.eawwybiwd.seawch.facets.namedentitycowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.facets.spacefacetcowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.facets.tewmstatisticscowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.facets.tewmstatisticswequestinfo;
impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.wewevanceseawchwequestinfo;
impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.wewevanceseawchwesuwts;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.cowwectows.abstwactwewevancecowwectow;
impowt c-com.twittew.seawch.eawwybiwd.seawch.wewevance.cowwectows.batchwewevancetopcowwectow;
impowt c-com.twittew.seawch.eawwybiwd.seawch.wewevance.cowwectows.wewevanceawwcowwectow;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.cowwectows.wewevancetopcowwectow;
impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.scowing.wewevancequewy;
impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.scowing.scowingfunction;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.scowing.scowingfunctionpwovidew;
i-impowt com.twittew.seawch.eawwybiwd.seawch.wewevance.scowing.tensowfwowbasedscowingfunction;
impowt com.twittew.seawch.eawwybiwd.stats.eawwybiwdwpcstats;
i-impowt com.twittew.seawch.eawwybiwd.stats.eawwybiwdseawchewstats;
i-impowt com.twittew.seawch.eawwybiwd.thwift.eawwybiwddebuginfo;
impowt com.twittew.seawch.eawwybiwd.thwift.eawwybiwdwequest;
impowt com.twittew.seawch.eawwybiwd.thwift.eawwybiwdwesponse;
impowt com.twittew.seawch.eawwybiwd.thwift.eawwybiwdwesponsecode;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftfacetcount;
i-impowt c-com.twittew.seawch.eawwybiwd.thwift.thwiftfacetcountmetadata;
impowt com.twittew.seawch.eawwybiwd.thwift.thwiftfacetfiewdwequest;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftfacetfiewdwesuwts;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftfacetwequest;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftfacetwesuwts;
impowt com.twittew.seawch.eawwybiwd.thwift.thwiftseawchquewy;
impowt com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwankingmode;
impowt c-com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwewevanceoptions;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwesuwt;
impowt com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwesuwtextwametadata;
impowt c-com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwesuwtmetadataoptions;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwiftseawchwesuwts;
impowt com.twittew.seawch.eawwybiwd.thwift.thwifttewmwequest;
i-impowt com.twittew.seawch.eawwybiwd.thwift.thwifttewmstatisticswequest;
impowt com.twittew.seawch.eawwybiwd.thwift.thwifttewmstatisticswesuwts;
impowt com.twittew.seawch.eawwybiwd.utiw.eawwybiwdseawchwesuwtutiw;
i-impowt com.twittew.seawch.quewypawsew.pawsew.sewiawizedquewypawsew;
impowt com.twittew.seawch.quewypawsew.quewy.conjunction;
i-impowt c-com.twittew.seawch.quewypawsew.quewy.disjunction;
impowt com.twittew.seawch.quewypawsew.quewy.quewynodeutiws;
impowt com.twittew.seawch.quewypawsew.quewy.quewypawsewexception;
impowt com.twittew.seawch.quewypawsew.quewy.annotation.annotation;
i-impowt com.twittew.seawch.quewypawsew.quewy.seawch.seawchopewatow;
i-impowt com.twittew.seawch.quewypawsew.quewy.seawch.seawchopewatowconstants;
impowt com.twittew.seawch.quewypawsew.utiw.idtimewanges;
impowt com.twittew.seawch.quewypawsew.visitows.convewsionvisitow;
impowt c-com.twittew.seawch.quewypawsew.visitows.detectpositiveopewatowvisitow;
impowt c-com.twittew.seawch.quewypawsew.visitows.nameddisjunctionvisitow;
impowt com.twittew.seawch.quewypawsew.visitows.pwoximitygwoupwewwitevisitow;
impowt com.twittew.seawch.quewypawsew.visitows.stwipannotationsvisitow;

impowt s-static com.twittew.seawch.quewypawsew.quewy.seawch.seawchopewatow.type.untiw_time;

/**
 * this c-cwass pwovides t-the basic seawch() method:
 * - c-convewts the thwift wequest object i-into nyani wucene e-expects. 😳
 * - g-gets the segment. mya
 * - handwes a-aww ewwows, 😳 and p-pwepawes the wesponse in case of ewwow. ^^
 *
 * w-we have one instance o-of this cwass p-pew seawch weceived. :3
 */
pubwic cwass eawwybiwdseawchew {
  p-pubwic enum quewymode {
    // pwease think befowe a-adding mowe quewy m-modes: can this be impwemented in a genewaw way?
    wecency(new e-eawwybiwdwpcstats("seawch_wecency")), (U ﹏ U)
    f-facets(new eawwybiwdwpcstats("seawch_facets")), UwU
    t-tewm_stats(new e-eawwybiwdwpcstats("seawch_tewmstats")), (ˆ ﻌ ˆ)♡
    wewevance(new eawwybiwdwpcstats("seawch_wewevance")), (ˆ ﻌ ˆ)♡
    t-top_tweets(new eawwybiwdwpcstats("seawch_toptweets"));

    pwivate finaw eawwybiwdwpcstats wequeststats;

    quewymode(eawwybiwdwpcstats w-wequeststats) {
      this.wequeststats = w-wequeststats;
    }

    pubwic eawwybiwdwpcstats g-getwequeststats() {
      wetuwn w-wequeststats;
    }
  }

  pwivate s-static finaw w-woggew wog = woggewfactowy.getwoggew(eawwybiwdseawchew.cwass);
  p-pwivate static f-finaw stwing match_aww_sewiawized_quewy = "(* )";
  /**
   * g-genewic fiewd annotations can be mapped to a concwete fiewd in the index using this mapping
   * via {@wink c-com.twittew.seawch.quewypawsew.quewy.annotation.annotation.type#mappabwe_fiewd}
   */
  p-pwivate static f-finaw map<mappabwefiewd, ^^;; stwing> m-mappabwe_fiewd_map =
      immutabwemap.of(
          mappabwefiewd.uww, rawr
          eawwybiwdfiewdconstant.wesowved_winks_text_fiewd.getfiewdname());

  p-pwivate s-static finaw stwing awwow_quewy_specific_signaw_decidew_key
      = "awwow_quewy_specific_scowe_adjustments";

  @visibwefowtesting
  p-pubwic static finaw stwing awwow_authow_specific_signaw_decidew_key
      = "awwow_authow_specific_scowe_adjustments";

  p-pwivate static f-finaw stwing use_muwti_tewm_disjunction_fow_wiked_by_usew_ids_decidew_key
      = "use_muwti_tewm_disjunction_fow_wiked_by_usew_ids";

  pwivate s-static finaw stwing a-awwow_camewcase_usewname_fiewd_weight_ovewwide_decidew_key_pwefix
      = "awwow_camewcase_usewname_fiewd_weight_ovewwide_in_";

  pwivate static finaw stwing awwow_tokenized_dispway_name_fiewd_weight_ovewwide_decidew_key_pwefix
      = "awwow_tokenized_dispway_name_fiewd_weight_ovewwide_in_";

  pwivate static finaw b-boowean awwow_quewy_specific_signaw_config
      = e-eawwybiwdconfig.getboow("awwow_quewy_specific_scowe_adjustments", f-fawse);

  p-pwivate static f-finaw boowean awwow_authow_specific_signaw_config
      = e-eawwybiwdconfig.getboow("awwow_authow_specific_scowe_adjustments", nyaa~~ f-fawse);

  pubwic static finaw i-int defauwt_num_facet_wesuwts = 100;

  p-pwivate finaw immutabweschemaintewface schemasnapshot;
  p-pwivate finaw eawwybiwdcwustew cwustew;

  pwivate finaw cwock c-cwock;
  pwivate finaw decidew decidew;

  // t-the a-actuaw wequest thwift. rawr x3
  pwivate f-finaw eawwybiwdwequest wequest;

  // seawchquewy f-fwom inside t-the wequest.
  p-pwivate finaw thwiftseawchquewy seawchquewy;

  // cowwectowpawams fwom inside the s-seawchquewy;
  pwivate finaw cowwectowpawams c-cowwectowpawams;

  // p-pawsed quewy (pawsed fwom s-sewiawized quewy stwing in wequest). (⑅˘꒳˘)
  p-pwivate c-com.twittew.seawch.quewypawsew.quewy.quewy pawsedquewy;
  pwivate b-boowean pawsedquewyawwownuwwcast;
  pwivate idtimewanges idtimewanges;

  // wucene v-vewsion of t-the above. OwO  this is nyani we wiww a-actuawwy be executing. OwO
  pwivate o-owg.apache.wucene.seawch.quewy w-wucenequewy;

  // u-used fow quewies whewe we want to cowwect pew-fiewd hit attwibution
  @nuwwabwe
  pwivate quewyhitattwibutehewpew hitattwibutehewpew;

  // debugging info can be appended to this buffew. ʘwʘ
  pwivate finaw stwingbuiwdew messagebuffew = nyew stwingbuiwdew(1024);
  p-pwivate f-finaw eawwybiwddebuginfo debuginfo = nyew eawwybiwddebuginfo();

  // t-the segment w-we awe seawching, :3 o-ow nyuww fow the muwti-seawchew.
  p-pwivate segment segment = n-nuww;

  // t-twue iff we awe seawching aww segments (muwti-seawchew). mya
  p-pwivate finaw boowean s-seawchawwsegments;

  // t-twacking tewmination cwitewia fow this q-quewy
  pwivate f-finaw tewminationtwackew t-tewminationtwackew;

  p-pwivate eawwybiwdwuceneseawchew s-seawchew = nyuww;

  p-pwivate finaw s-segmentmanagew s-segmentmanagew;
  p-pwivate finaw quewycachemanagew q-quewycachemanagew;
  p-pwivate f-finaw scowingmodewsmanagew scowingmodewsmanagew;
  p-pwivate finaw tensowfwowmodewsmanagew tensowfwowmodewsmanagew;

  p-pwivate antigamingfiwtew antigamingfiwtew = n-nyuww;

  pwivate f-finaw boowean s-seawchhighfwequencytewmpaiws =
      eawwybiwdconfig.getboow("seawch_high_fwequency_tewm_paiws", OwO f-fawse);

  // how wong to awwow p-post-tewmination when enfowcing q-quewy timeout
  pwivate finaw i-int enfowcequewytimeoutbuffewmiwwis =
      eawwybiwdconfig.getint("enfowce_quewy_timeout_buffew_miwwis", :3 50);

  pwivate eawwybiwdwpcstats wequeststats;

  pwivate quewytimeoutfactowy q-quewytimeoutfactowy;

  // expowted stats
  p-pwivate finaw e-eawwybiwdseawchewstats seawchewstats;

  @visibwefowtesting
  pubwic static finaw seawchcountew f-fiewd_weight_ovewwide_map_non_nuww_count =
      seawchcountew.expowt("fiewd_weight_ovewwide_map_non_nuww_count");
  @visibwefowtesting
  pubwic s-static finaw s-seawchcountew d-dwopped_camewcase_usewname_fiewd_weight_ovewwide =
      seawchcountew.expowt("dwopped_camewcase_usewname_fiewd_weight_ovewwide");
  @visibwefowtesting
  pubwic s-static finaw seawchcountew d-dwopped_tokenized_dispway_name_fiewd_weight_ovewwide =
      seawchcountew.expowt("dwopped_tokenized_dispway_name_fiewd_weight_ovewwide");

  p-pwivate static finaw seawchcountew wesponse_has_no_thwift_seawch_wesuwts =
      s-seawchcountew.expowt("tweets_eawwybiwd_seawchew_wesponse_has_no_thwift_seawch_wesuwts");
  pwivate static f-finaw seawchcountew c-cwient_has_featuwe_schema_countew =
      s-seawchcountew.expowt("tweets_eawwybiwd_seawchew_cwient_has_featuwe_schema");
  pwivate static f-finaw seawchcountew c-cwient_doesnt_have_featuwe_schema_countew =
      s-seawchcountew.expowt("tweet_eawwybiwd_seawchew_cwient_doesnt_have_featuwe_schema");
  p-pwivate static finaw s-seawchcountew c-cowwectow_pawams_max_hits_to_pwocess_not_set_countew =
      s-seawchcountew.expowt("cowwectow_pawams_max_hits_to_pwocess_not_set");
  p-pwivate static f-finaw seawchcountew p-positive_pwotected_opewatow_detected_countew =
      s-seawchcountew.expowt("positive_pwotected_opewatow_detected_countew");

  // q-quewy mode we awe executing. >_<
  p-pwivate finaw quewymode q-quewymode;

  // facetwequest fwom i-inside the wequest (ow n-nyuww). σωσ
  p-pwivate finaw thwiftfacetwequest facetwequest;

  // tewmstatisticswequest f-fwom inside the w-wequest (ow nyuww). /(^•ω•^)
  p-pwivate finaw thwifttewmstatisticswequest tewmstatisticswequest;

  // wesuwts f-fiewds fiwwed i-in duwing seawchintewnaw(). mya
  pwivate thwiftseawchwesuwts s-seawchwesuwts = n-nyuww;
  pwivate thwiftfacetwesuwts facetwesuwts = nyuww;
  pwivate t-thwifttewmstatisticswesuwts t-tewmstatisticswesuwts = n-nyuww;
  pwivate e-eawwytewminationinfo eawwytewminationinfo = nyuww;

  // pawtition c-config u-used to fiww in debugging info. nyaa~~
  // if nyuww, 😳 nyo d-debug info is wwitten into wesuwts. ^^;;
  @nuwwabwe
  pwivate finaw p-pawtitionconfig pawtitionconfig;

  p-pwivate finaw m-muwtisegmenttewmdictionawymanagew muwtisegmenttewmdictionawymanagew;

  p-pwivate f-finaw quawityfactow quawityfactow;

  p-pwivate set<stwing> quewiedfiewds;
  p-pwivate finaw audiospacetabwe a-audiospacetabwe;

  p-pubwic eawwybiwdseawchew(
      e-eawwybiwdwequest wequest, 😳😳😳
      s-segmentmanagew s-segmentmanagew, nyaa~~
      a-audiospacetabwe audiospacetabwe, 🥺
      q-quewycachemanagew quewycachemanagew, XD
      immutabweschemaintewface s-schema,
      e-eawwybiwdcwustew c-cwustew, (ꈍᴗꈍ)
      @nuwwabwe pawtitionconfig pawtitionconfig, 😳😳😳
      decidew decidew, ( ͡o ω ͡o )
      eawwybiwdseawchewstats seawchewstats, nyaa~~
      s-scowingmodewsmanagew scowingmodewsmanagew, XD
      t-tensowfwowmodewsmanagew t-tensowfwowmodewsmanagew, (ˆ ﻌ ˆ)♡
      cwock cwock, rawr x3
      muwtisegmenttewmdictionawymanagew m-muwtisegmenttewmdictionawymanagew, OwO
      quewytimeoutfactowy q-quewytimeoutfactowy, UwU
      q-quawityfactow q-quawityfactow) {
    t-this.quewymode = g-getquewymode(wequest);
    this.schemasnapshot = schema.getschemasnapshot();
    // set the wequest stats as eawwy a-as possibwe, ^^ so that we can twack e-ewwows that happen
    // eawwy on in quewy pwocessing. (✿oωo)
    this.wequeststats = q-quewymode.getwequeststats();
    this.facetwequest = wequest.issetfacetwequest() ? wequest.getfacetwequest() : nyuww;
    this.tewmstatisticswequest = w-wequest.issettewmstatisticswequest()
        ? w-wequest.gettewmstatisticswequest() : nyuww;
    t-this.pawtitionconfig = pawtitionconfig;
    this.seawchewstats = seawchewstats;
    t-this.muwtisegmenttewmdictionawymanagew = m-muwtisegmenttewmdictionawymanagew;
    this.cwock = c-cwock;
    this.decidew = d-decidew;
    this.wequest = wequest;
    this.segmentmanagew = segmentmanagew;
    t-this.quewycachemanagew = quewycachemanagew;
    this.cwustew = cwustew;
    t-this.scowingmodewsmanagew = s-scowingmodewsmanagew;
    t-this.tensowfwowmodewsmanagew = tensowfwowmodewsmanagew;
    this.audiospacetabwe = a-audiospacetabwe;
    // nyote: we'we defewwing the vawidation/nuwwchecks untiw vawidatewequest()
    // fow mowe contained e-exception h-handwing
    this.seawchquewy = w-wequest.getseawchquewy();
    t-this.cowwectowpawams = this.seawchquewy == nyuww ? n-nyuww : this.seawchquewy.getcowwectowpawams();
    // s-seawch aww segments if seawchsegmentid is u-unset.
    this.seawchawwsegments = !wequest.issetseawchsegmentid();
    if (this.cowwectowpawams == nyuww
        || !this.cowwectowpawams.issettewminationpawams()) {
      this.tewminationtwackew = n-nyew tewminationtwackew(cwock);
    } ewse if (wequest.issetcwientwequesttimems()) {
      this.tewminationtwackew = n-nyew t-tewminationtwackew(cowwectowpawams.gettewminationpawams(), 😳😳😳
          wequest.getcwientwequesttimems(), 🥺 c-cwock, ʘwʘ
          g-getposttewminationovewheadmiwwis(cowwectowpawams.gettewminationpawams()));
    } e-ewse {
      this.tewminationtwackew = nyew tewminationtwackew(
          c-cowwectowpawams.gettewminationpawams(), 😳 cwock,
          getposttewminationovewheadmiwwis(cowwectowpawams.gettewminationpawams()));
    }
    this.quewytimeoutfactowy = quewytimeoutfactowy;
    t-this.quawityfactow = quawityfactow;
  }

  pwivate int getposttewminationovewheadmiwwis(cowwectowtewminationpawams tewminationpawams) {
    // i-if enfowcing t-timeouts, ^^;; set t-the post-tewmination b-buffew to t-the smowew of the timeout ow the
    // c-configuwed buffew. this ensuwes that timeout >= b-buffew, (///ˬ///✿) and a wequest with a-a smowew timeout
    // shouwd just time out i-immediatewy (because t-timeout == buffew). OwO
    wetuwn (tewminationpawams.isenfowcequewytimeout() && t-tewminationpawams.gettimeoutms() > 0)
        ? math.min(enfowcequewytimeoutbuffewmiwwis, -.- t-tewminationpawams.gettimeoutms()) : 0;
  }

  // a-appends a debug stwing t-to the buffew. ^^
  p-pwivate void appendmessage(stwing m-message) {
    messagebuffew.append(message).append("\n");
  }

  /**
   * pwocesses an eawwybiwd seawch w-wequest. (ꈍᴗꈍ)
   * @wetuwn the eawwybiwd w-wesponse fow this seawch wequest. ^^;;
   */
  pubwic eawwybiwdwesponse s-seawch() {
    t-twy {
      d-debuginfo.sethost(databaseconfig.getwocawhostname());

      // thwows twansient e-exception fow i-invawid wequests. (˘ω˘)
      vawidatewequest();

      // t-thwows cwient exception fow b-bad quewies, 🥺
      pawseeawwybiwdwequest();

      // m-modify t-the wucene quewy if nyecessawy. ʘwʘ
      wucenequewy = postwucenequewypwocess(wucenequewy);

      // might wetuwn p-pawtition_not_found o-ow pawtition_disabwed. (///ˬ///✿)
      eawwybiwdwesponsecode code = initseawchew();
      if (code != e-eawwybiwdwesponsecode.success) {
        wetuwn w-wespondewwow(code);
      }

      w-wetuwn seawchintewnaw();

    } catch (twansientexception e) {
      wog.ewwow(stwing.fowmat("twansient exception i-in seawch() fow eawwybiwdwequest:\n%s", ^^;; wequest), XD
                e-e);
      appendmessage(e.getmessage());
      w-wetuwn wespondewwow(eawwybiwdwesponsecode.twansient_ewwow);
    } c-catch (cwientexception e) {
      wog.wawn(stwing.fowmat("cwient e-exception i-in seawch() %s f-fow eawwybiwdwequest:\n %s", (ˆ ﻌ ˆ)♡
          e-e, (˘ω˘) wequest));
      a-appendmessage(e.getmessage());
      w-wetuwn wespondewwow(eawwybiwdwesponsecode.cwient_ewwow);
    } catch (exception e) {
      wog.wawn(stwing.fowmat("uncaught exception in seawch() fow eawwybiwdwequest:\n%s", σωσ w-wequest), 😳😳😳
               e-e);
      a-appendmessage(e.getmessage());
      w-wetuwn wespondewwow(eawwybiwdwesponsecode.twansient_ewwow);
    } c-catch (assewtionewwow e-e) {
      wog.wawn(stwing.fowmat("assewtion ewwow in seawch() fow eawwybiwdwequest:\n%s", ^•ﻌ•^ wequest), e-e);
      appendmessage(e.getmessage());
      w-wetuwn wespondewwow(eawwybiwdwesponsecode.twansient_ewwow);
    } catch (ewwow e) {
      // seawch-33166: if w-we got hewe, σωσ it m-means nani was t-thwown was nyot an exception, (///ˬ///✿) ow anything
      // w-we know how to handwe. XD wog the ewwow fow diagnostic p-puwposes a-and pwopagate it. >_<
      wog.ewwow("we-thwowing uncaught ewwow", òωó e-e);
      thwow e;
    }
  }

  p-pubwic eawwybiwdwpcstats g-getwequeststats() {
    wetuwn wequeststats;
  }

  /**
   * w-wwaps the g-given quewy with t-the pwovided fiwtew q-quewies. (U ᵕ U❁)
   *
   * @pawam q-quewy the quewy t-to wwap with fiwtews.
   * @pawam fiwtews the fiwtews t-to wwap the q-quewy with. (˘ω˘)
   * @wetuwn a booweanquewy w-wwapped with fiwtews
   */
  pubwic static q-quewy wwapfiwtews(quewy quewy, 🥺 q-quewy... (✿oωo) fiwtews) {
    boowean f-fiwtewsempty = f-fiwtews == nyuww || fiwtews.wength == 0;

    if (!fiwtewsempty) {
      f-fiwtewsempty = twue;
      fow (quewy f-f : fiwtews) {
        i-if (f != nyuww) {
          fiwtewsempty = f-fawse;
          b-bweak;
        }
      }
    }

    if (fiwtewsempty) {
      i-if (quewy == nyuww) {
        wetuwn nyew matchawwdocsquewy();
      } e-ewse {
        w-wetuwn quewy;
      }
    }

    b-booweanquewy.buiwdew bqbuiwdew = n-nyew booweanquewy.buiwdew();
    if (quewy != n-nyuww) {
      b-bqbuiwdew.add(quewy, (˘ω˘) o-occuw.must);
    }
    f-fow (quewy f : fiwtews) {
      if (f != nyuww) {
        bqbuiwdew.add(f, (ꈍᴗꈍ) occuw.fiwtew);
      }
    }
    wetuwn bqbuiwdew.buiwd();
  }

  // examine aww fiewds in the wequest f-fow sanity. ( ͡o ω ͡o )
  p-pwivate void v-vawidatewequest() t-thwows twansientexception, (U ᵕ U❁) c-cwientexception {
    // f-fiwst twy thwift's intewnaw v-vawidate. ʘwʘ  shouwd a-awways succeed. (ˆ ﻌ ˆ)♡
    twy {
      w-wequest.vawidate();
    } catch (texception e-e) {
      thwow nyew twansientexception(e.getmessage(), /(^•ω•^) e);
    }

    i-if (seawchquewy == nyuww) {
      thwow n-nyew twansientexception("no thwiftseawchquewy specified");
    }

    i-if (cowwectowpawams == n-nyuww) {
      thwow n-nyew twansientexception("no cowwectowpawams specified");
    }

    v-vawidatetewmstatswequest();

    i-if (!seawchawwsegments) {
      if (wequest.getseawchsegmentid() <= 0) {
        s-stwing m-msg = "bad time swice id: " + wequest.getseawchsegmentid();
        t-thwow nyew twansientexception(msg);
      }

      // initiawize t-the segment.
      s-segmentinfo s-segmentinfo = this.segmentmanagew.getsegmentinfo(wequest.getseawchsegmentid());
      s-segment = segmentinfo != nyuww ? segmentinfo.getsegment() : n-nyuww;
    }

    if (cowwectowpawams.getnumwesuwtstowetuwn() < 0) {
      stwing msg = "invawid nyumwesuwts: " + cowwectowpawams.getnumwesuwtstowetuwn();
      thwow nyew twansientexception(msg);
    }

    i-if (seawchquewy.getnameddisjunctionmapsize() > 0 && seawchquewy.issetwucenequewy()) {
      thwow nyew cwientexception("namedmuwtitewmdisjunctionmap does nyot suppowt with wucenequewy");
    }
  }

  pwivate v-void vawidatetewmstatswequest() thwows cwientexception {
    // vawidate the f-fiewd nyames and vawues fow aww t-thwifttewmwequests. (ˆ ﻌ ˆ)♡
    if (wequest.issettewmstatisticswequest()
        && wequest.gettewmstatisticswequest().issettewmwequests()) {
      fow (thwifttewmwequest tewmwequest : w-wequest.gettewmstatisticswequest().gettewmwequests()) {
        // if tewmwequest.fiewdname i-is nyot set, (✿oωo) it defauwts to 'text', ^•ﻌ•^ w-which is a stwing f-fiewd, (ˆ ﻌ ˆ)♡
        // so we don't nyeed to check t-the tewm. XD
        if (tewmwequest.issetfiewdname()) {
          stwing fiewdname = tewmwequest.getfiewdname();
          s-schema.fiewdinfo facetfiewdinfo = s-schemasnapshot.getfacetfiewdbyfacetname(fiewdname);
          if (facetfiewdinfo != n-nyuww) {
            // facet f-fiewds awe stwing f-fiewds, :3 so we don't nyeed to check the tewm. -.-
            c-continue;
          }

          schema.fiewdinfo fiewdinfo = s-schemasnapshot.getfiewdinfo(fiewdname);
          if (fiewdinfo == nyuww) {
            thwow nyew cwientexception("fiewd " + fiewdname + " i-is nyot pwesent i-in the schema.");
          }

          twy {
            s-schemautiw.tobyteswef(fiewdinfo, ^^;; t-tewmwequest.gettewm());
          } catch (unsuppowtedopewationexception e-e) {
            thwow nyew cwientexception("tewm " + tewmwequest.gettewm() + " is nyot c-compatibwe with "
                                      + "the t-type of fiewd " + fiewdname);
          }
        }
      }
    }
  }

  p-pwivate v-void setquewiesindebuginfo(
      com.twittew.seawch.quewypawsew.quewy.quewy pawsedq,
      o-owg.apache.wucene.seawch.quewy wuceneq) {
    debuginfo.setpawsedquewy(pawsedq == n-nyuww ? nyuww : pawsedq.sewiawize());
    debuginfo.setwucenequewy(wuceneq == n-nyuww ? n-nyuww : wuceneq.tostwing());
  }

  /**
   * takes the eawwybiwdwequest that c-came into the sewvice and aftew vawious pawsing and pwocessing
   * steps uwtimatewy pwoduces a wucene quewy. OwO
   */
  pwivate v-void pawseeawwybiwdwequest() t-thwows cwientexception {
    s-sewiawizedquewypawsew p-pawsew = new sewiawizedquewypawsew(eawwybiwdconfig.getpenguinvewsion());

    twy {
      // if t-the depwecated itewativequewies fiewd is set, ^^;; wetuwn an ewwow to the cwient
      // indicating t-that suppowt fow it has been wemoved. 🥺
      if (seawchquewy.issetdepwecated_itewativequewies()) {
        thwow nyew cwientexception("invawid wequest: i-itewativequewies f-featuwe h-has been wemoved");
      }

      // we pawse the actuaw quewy fwom the usew, ^^ i-if any
      wucenequewy = n-nuww;
      p-pawsedquewy = nyuww;  // t-this wiww be set by pawsequewyhewpew()

      i-if (seawchquewy.getwikedbyusewidfiwtew64size() > 0
          && seawchquewy.issetwucenequewy()) {
        t-thwow nyew cwientexception("wikedbyusewidfiwtew64 d-does nyot suppowt with wucenequewy");
      }

      if (!stwingutiws.isbwank(wequest.getseawchquewy().getsewiawizedquewy())) {
        s-seawchewstats.thwiftquewywithsewiawizedquewy.incwement();
        wucenequewy = p-pawsesewiawizedquewy(seawchquewy.getsewiawizedquewy(), o.O p-pawsew, ( ͡o ω ͡o ) twue);
      } e-ewse if (!stwingutiws.isbwank(wequest.getseawchquewy().getwucenequewy())) {
        s-seawchewstats.thwiftquewywithwucenequewy.incwement();
        wucenequewy = p-pawsewucenequewy(seawchquewy.getwucenequewy());
        wog.info("wucene q-quewy: {}", nyaa~~ seawchquewy.getwucenequewy());
        i-if (wucenequewy != nyuww) {
          w-wog.info("using wucene quewy diwectwy fwom the w-wequest: " + wucenequewy.tostwing());
        }
      } ewse {
        seawchewstats.thwiftquewywithouttextquewy.incwement();
        wucenequewy = pawsesewiawizedquewy(
            match_aww_sewiawized_quewy, (///ˬ///✿)
            pawsew, (ˆ ﻌ ˆ)♡
            quewymode != quewymode.tewm_stats);
      }
    } c-catch (quewypawsewexception | booweanquewy.toomanycwauses e) {
      wog.info("exception p-pawsing quewy duwing s-seawch", XD e);
      appendmessage(e.getmessage());
      thwow n-nyew cwientexception(e);
    }
  }

  /**
   * pawses a sewiawized quewy and cweates a-a wucene quewy out of it.
   *
   * to see h-how sewiawized quewies wook wike, >_< go to go/seawchsyntax. (U ﹏ U)
   */
  p-pwivate quewy pawsesewiawizedquewy(
      stwing s-sewiawizedquewy, òωó
      s-sewiawizedquewypawsew pawsew,
      boowean shouwdadjustquewybasedonwequestpawametews) t-thwows quewypawsewexception {
    // p-pawse the sewiawized quewy. >w<
    p-pawsedquewy = p-pawsew.pawse(sewiawizedquewy);
    if (pawsedquewy == nyuww) {
      w-wetuwn nyuww;
    }

    // wewwite quewy if positive 'pwotected' o-opewatow is detected
    if (pawsedquewy.accept(new detectpositiveopewatowvisitow(seawchopewatowconstants.pwotected))) {
      positive_pwotected_opewatow_detected_countew.incwement();
      p-pwotectedopewatowquewywewwitew w-wewwitew = n-nyew pwotectedopewatowquewywewwitew();
      pawsedquewy = wewwitew.wewwite(
          pawsedquewy, ^•ﻌ•^
          wequest.fowwowedusewids, 🥺
          s-segmentmanagew.getusewtabwe());
    }

    thwiftseawchwewevanceoptions o-options = seawchquewy.getwewevanceoptions();
    i-if (shouwdadjustquewybasedonwequestpawametews) {
      // i-if wikedbyusewidfiwtew64 is set, (✿oωo) combine it with quewy
      // nyote: we deaw with wikedbyusewidfiwtew64 hewe instead of i-in postwucenequewypwocess a-as we
      // want annotate quewy with w-wanks. UwU
      if (seawchquewy.issetwikedbyusewidfiwtew64()
          && seawchquewy.getwikedbyusewidfiwtew64size() > 0) {
        p-pawsedquewy = c-combinewithwikedbyusewidfiwtew64(
            p-pawsedquewy, (˘ω˘) seawchquewy.getwikedbyusewidfiwtew64());
      }

      // i-if nyamedwistmap f-fiewd i-is set, ʘwʘ wepwace the nyamed wists in the sewiawized q-quewy.
      i-if (seawchquewy.getnameddisjunctionmapsize() > 0) {
        p-pawsedquewy = p-pawsedquewy.accept(
            n-nyew nyameddisjunctionvisitow(seawchquewy.getnameddisjunctionmap()));
      }

      if (seawchquewy.issetwewevanceoptions()
          && s-seawchquewy.getwewevanceoptions().iscowwectfiewdhitattwibutions()) {
        // nyote: befowe w-we do any modifications t-to the s-sewiawized quewy twee, (ˆ ﻌ ˆ)♡ annotate the quewy
        // n-nyodes with theiw nyode wank in the owiginaw q-quewy. ( ͡o ω ͡o )
        this.hitattwibutehewpew =
            quewyhitattwibutehewpew.fwom(pawsedquewy, :3 s-schemasnapshot);
        p-pawsedquewy = hitattwibutehewpew.getannotatedquewy();
      }

      // cuwwentwy antisociaw/nuwwcast tweets awe dwopped w-when we buiwd i-index, 😳 but some tweets may
      // b-become antisociaw w-with weawtime updates. (✿oωo) fow consistency, /(^•ω•^) we shouwd awways f-fiwtew out
      // a-antisociaw/nuwwcast tweets if the usew is nyot e-expwicitwy incwuding i-it. :3
      finaw boowean awwowantisociaw =
          p-pawsedquewy.accept(new detectpositiveopewatowvisitow(seawchopewatowconstants.antisociaw));
      if (!awwowantisociaw) {
        pawsedquewy = quewynodeutiws.appendasconjunction(
            pawsedquewy, σωσ
            q-quewycacheconvewsionwuwes.cached_excwude_antisociaw);
      }
      pawsedquewyawwownuwwcast =
          pawsedquewy.accept(new d-detectpositiveopewatowvisitow(seawchopewatowconstants.nuwwcast));
      i-if (!pawsedquewyawwownuwwcast) {
        p-pawsedquewy = quewynodeutiws.appendasconjunction(
            p-pawsedquewy, σωσ n-nyew seawchopewatow("fiwtew", 🥺 seawchopewatowconstants.nuwwcast).negate());
      }

      // s-stwip a-aww annotations f-fwom the fiwtews that wiww be convewted to quewy c-cache fiwtews. rawr
      // s-see s-seawch-15552. o.O
      pawsedquewy = p-pawsedquewy.accept(
          n-nyew stwipannotationsvisitow(quewycacheconvewsionwuwes.stwip_annotations_quewies));

      // convewt c-cewtain fiwtews into cached f-fiwtews, 😳😳😳 awso c-consowidate them. /(^•ω•^)
      p-pawsedquewy = p-pawsedquewy.accept(
          n-nyew convewsionvisitow(quewycacheconvewsionwuwes.defauwt_wuwes));

      // add pwoximity if n-nyeeded
      if (options != nyuww
          && o-options.ispwoximityscowing()
          && s-seawchquewy.getwankingmode() != thwiftseawchwankingmode.wecency) {
        pawsedquewy = pawsedquewy.accept(new p-pwoximitygwoupwewwitevisitow()).simpwify();
      }
    }

    i-if (wequest.isskipvewywecenttweets()) {
      pawsedquewy = w-westwictquewytofuwwyindexedtweets(pawsedquewy);
    }

    p-pawsedquewy = pawsedquewy.simpwify();
    debuginfo.setpawsedquewy(pawsedquewy.sewiawize());

    // e-extwact top-wevew s-since-id f-fow pagination o-optimizations. σωσ
    i-idtimewanges = i-idtimewanges.fwomquewy(pawsedquewy);

    // does any finaw pwocessing specific t-to eawwybiwdseawch cwass. OwO
    pawsedquewy = pwewucenequewypwocess(pawsedquewy);

    // convewt to a wucene quewy. OwO
    e-eawwybiwdwucenequewyvisitow w-wucenevisitow = getwucenevisitow(
        options == nyuww ? nyuww : options.getfiewdweightmapovewwide());

    i-if (options != n-nyuww) {
      wucenevisitow
          .setpwoximityphwaseweight((fwoat) options.getpwoximityphwaseweight())
          .setpwoximityphwaseswop(options.getpwoximityphwaseswop());
    }

    // p-pwopagate hit attwibute hewpew t-to the wucene v-visitow if it h-has been setup. òωó
    wucenevisitow.setfiewdhitattwibutehewpew(this.hitattwibutehewpew);

    owg.apache.wucene.seawch.quewy quewy = p-pawsedquewy.accept(wucenevisitow);
    if (quewy != n-nyuww) {
      debuginfo.setwucenequewy(quewy.tostwing());
    }

    q-quewiedfiewds = wucenevisitow.getquewiedfiewds();

    wetuwn quewy;
  }

  p-pwivate quewy pawsewucenequewy(stwing quewy) {
    q-quewypawsew pawsew = nyew quewypawsew(
        e-eawwybiwdfiewdconstant.text_fiewd.getfiewdname(), :3
        nyew seawchwhitespaceanawyzew());
    p-pawsew.setspwitonwhitespace(twue);
    twy {
      wetuwn pawsew.pawse(quewy);
    } catch (pawseexception e) {
      wog.ewwow("cannot pawse waw wucene q-quewy: " + quewy, σωσ e-e);
    } c-catch (nuwwpointewexception e-e) {
      wog.ewwow("nuwwpointewexception whiwe pawsing w-waw wucene quewy: " + quewy
          + ", σωσ pwobabwy youw gwammaw is wwong.\n", e-e);
    }
    w-wetuwn nyuww;
  }

  p-pwivate com.twittew.seawch.quewypawsew.quewy.quewy c-combinewithwikedbyusewidfiwtew64(
      com.twittew.seawch.quewypawsew.quewy.quewy quewy, -.-
      wist<wong> ids) thwows q-quewypawsewexception {
    w-wetuwn quewynodeutiws.appendasconjunction(quewy, (///ˬ///✿) getwikedbyusewidquewy(ids));
  }

  /**
   * initseawchew i-initiawizes the segmentseawchew, rawr x3 a-and wetuwns s-success if ok
   * o-ow some othew wesponse code it nyot ok. (U ﹏ U)
   */
  pwivate eawwybiwdwesponsecode initseawchew() thwows ioexception {
    s-seawchew = nyuww;
    i-if (seawchawwsegments) {
      wetuwn initmuwtisegmentseawchew();
    } ewse {
      wetuwn initsingwesegmentseawchew();
    }
  }

  p-pwivate eawwybiwdwesponsecode i-initsingwesegmentseawchew() thwows ioexception {
    if (segment == n-nyuww) {
      s-stwing m-message = "segment n-nyot found fow t-time swice: " + wequest.getseawchsegmentid();
      w-wog.wawn(message);
      a-appendmessage(message);
      wetuwn e-eawwybiwdwesponsecode.pawtition_not_found;
    }

    eawwybiwdwesponsecode code = this.segmentmanagew.checksegment(segment);
    i-if (code != eawwybiwdwesponsecode.success) {
      s-stwing m-message = "segment " + segment + " e-eithew disabwed o-ow dwopped";
      wog.wawn(message);
      appendmessage(message);
      wetuwn c-code;
    }

    s-seawchew = s-segmentmanagew.getseawchew(segment, òωó s-schemasnapshot);
    if (seawchew == nyuww) {
      stwing m-message = "couwd nyot constwuct seawchew fow segment " + s-segment;
      wog.ewwow(message);
      appendmessage(message);
      w-wetuwn eawwybiwdwesponsecode.pewsistent_ewwow;
    } ewse {
      appendmessage("seawching segment: " + s-segment);
      wetuwn eawwybiwdwesponsecode.success;
    }
  }

  p-pwivate e-eawwybiwdwesponsecode i-initmuwtisegmentseawchew() thwows ioexception {
    e-eawwybiwdmuwtisegmentseawchew m-muwtiseawchew =
        segmentmanagew.getmuwtiseawchew(schemasnapshot);
    s-seawchew = m-muwtiseawchew;
    p-pweconditions.checknotnuww(seawchew);

    // s-set a top wevew since id to s-skip entiwe segments w-when possibwe. OwO
    m-muwtiseawchew.setidtimewanges(idtimewanges);
    wetuwn e-eawwybiwdwesponsecode.success;
  }

  pwivate com.twittew.seawch.quewypawsew.quewy.quewy
  westwictquewytofuwwyindexedtweets(com.twittew.seawch.quewypawsew.quewy.quewy quewy) {
    wong untiwtimeseconds =
        wecenttweetwestwiction.wecenttweetsuntiwtime(decidew, ^^ (int) (cwock.nowmiwwis() / 1000));
    i-if (untiwtimeseconds == 0) {
      w-wetuwn quewy;
    }

    seawchopewatow t-timewimit = nyew seawchopewatow(untiw_time, /(^•ω•^) untiwtimeseconds);
    w-wetuwn nyew conjunction(quewy, >_< timewimit);
  }

  p-pwivate eawwybiwdwesponse n-nyewwesponse(eawwybiwdwesponsecode code, -.- b-boowean setdebuginfo) {
    eawwybiwdwesponse w-wesponse = nyew eawwybiwdwesponse();
    wesponse.setwesponsecode(code);
    i-if (setdebuginfo) {
      w-wesponse.setdebuginfo(debuginfo);
      if (messagebuffew.wength() > 0) {
        wesponse.setdebugstwing(databaseconfig.getwocawhostname()
                                + ":\n" + messagebuffew.tostwing());
      }
    }
    w-wetuwn wesponse;
  }

  p-pwivate eawwybiwdwesponse wespondewwow(eawwybiwdwesponsecode code) {
    appendmessage("wesponding with ewwow c-code " + code);
    // awways w-wespond with an ewwow message, (˘ω˘) even when wequest.debug i-is fawse
    wetuwn nyewwesponse(code, >_< twue);
  }

  @visibwefowtesting
  p-pubwic tewminationtwackew gettewminationtwackew() {
    w-wetuwn t-tewminationtwackew;
  }

  pubwic void maybesetcowwectowdebuginfo(twitteweawwytewminationcowwectow c-cowwectow) {
    if (wequest.issetdebugoptions() && wequest.getdebugoptions().isincwudecowwectowdebuginfo()) {
      d-debuginfo.setcowwectowdebuginfo(cowwectow.getdebuginfo());
    }
  }

  p-pubwic void settewmstatisticsdebuginfo(wist<stwing> t-tewmstatisticsdebuginfo) {
    debuginfo.settewmstatisticsdebuginfo(tewmstatisticsdebuginfo);
  }

  pwivate eawwybiwdwesponse seawchintewnaw() thwows twansientexception, (˘ω˘) c-cwientexception {
    seawchwesuwts = nyew thwiftseawchwesuwts();

    s-seawchwesuwtsinfo s-seawchwesuwtsinfo;
    twy {
      switch (quewymode) {
        case wecency:
          s-seawchwesuwtsinfo = p-pwocessweawtimequewy();
          bweak;
        case wewevance:
          // wewevance seawch a-and modew-based seawch diffew o-onwy on the scowing function used. >w<
          seawchtimew timew = s-seawchewstats.cweatetimew();
          t-timew.stawt();
          seawchwesuwtsinfo = p-pwocesswewevancequewy();
          t-timew.stop();
          seawchewstats.wecowdwewevancestats(timew, 😳😳😳 w-wequest);
          bweak;
        case f-facets:
          s-seawchwesuwtsinfo = p-pwocessfacetsquewy();
          b-bweak;
        c-case tewm_stats:
          seawchwesuwtsinfo = p-pwocesstewmstatsquewy();
          b-bweak;
        case top_tweets:
          seawchwesuwtsinfo = p-pwocesstoptweetsquewy();
          bweak;
        d-defauwt:
          thwow new twansientexception("unknown quewy mode " + quewymode);
      }

      wetuwn wespondsuccess(seawchwesuwts, 😳 f-facetwesuwts, XD tewmstatisticswesuwts, OwO
          e-eawwytewminationinfo, -.- seawchwesuwtsinfo);
    } c-catch (ioexception e-e) {
      thwow nyew twansientexception(e.getmessage(), o.O e-e);
    }
  }

  /**
   * hewpew method t-to pwocess facets quewy. ^^
   */
  p-pwivate seawchwesuwtsinfo pwocessfacetsquewy() thwows cwientexception, ^^ ioexception {
    // figuwe out which fiewds we nyeed to count
    f-facetcountstate facetcountstate = nyewfacetcountstate();

    // a-additionawwy wwap ouw quewy into a-a skip wist boowean quewy fow fastew counting. XD
    if (!facetwequest.isusingquewycache()) {
      // onwy if aww fiewds to be counted use skip wists, >w< then we can add a wequiwed c-cwause
      // t-that fiwtews o-out aww wesuwts that do nyot contain t-those fiewds
      b-boowean c-cannotaddwequiwedcwause = facetcountstate.hasfiewdtocountwithoutskipwist();
      finaw quewy facetskipwistfiwtew =
          cannotaddwequiwedcwause ? n-nyuww : f-facetskipwist.getskipwistquewy(facetcountstate);
      finaw quewy a-antisociawfiwtew = u-usewfwagsexcwudefiwtew.getusewfwagsexcwudefiwtew(
          s-segmentmanagew.getusewtabwe(), (⑅˘꒳˘) t-twue, 😳 twue, fawse);
      w-wucenequewy = wwapfiwtews(wucenequewy, :3
          f-facetskipwistfiwtew, :3
          a-antisociawfiwtew);
    }

    f-facetwesuwts = n-new thwiftfacetwesuwts(new h-hashmap<>());

    f-facetseawchwequestinfo s-seawchwequestinfo =
        n-nyew facetseawchwequestinfo(seawchquewy, OwO f-facetwequest.getfacetwankingoptions(), (U ﹏ U)
            w-wucenequewy, (⑅˘꒳˘) facetcountstate, 😳 tewminationtwackew);
    seawchwequestinfo.setidtimewanges(idtimewanges);
    i-if (seawchquewy.getmaxhitspewusew() > 0) {
      antigamingfiwtew = n-nyew antigamingfiwtew(
          seawchquewy.getmaxhitspewusew(),
          seawchquewy.getmaxtweepcwedfowantigaming(), (ˆ ﻌ ˆ)♡
          w-wucenequewy);
    }

    a-abstwactwesuwtscowwectow<
        f-facetseawchwequestinfo, mya eawwybiwdwuceneseawchew.facetseawchwesuwts> c-cowwectow;
    i-if (wequest.getdebugmode() > 2) {
      cowwectow = nyew expwainfacetwesuwtscowwectow(schemasnapshot, ʘwʘ
          seawchwequestinfo, (˘ω˘) antigamingfiwtew, (///ˬ///✿) seawchewstats, XD c-cwock, 😳 wequest.debugmode);
    } ewse {
      cowwectow = n-nyew facetwesuwtscowwectow(schemasnapshot, :3
          s-seawchwequestinfo, 😳😳😳 antigamingfiwtew, (U ᵕ U❁) s-seawchewstats, ^•ﻌ•^ c-cwock, w-wequest.debugmode);
    }

    s-setquewiesindebuginfo(pawsedquewy, (˘ω˘) s-seawchwequestinfo.getwucenequewy());
    seawchew.seawch(seawchwequestinfo.getwucenequewy(), /(^•ω•^) c-cowwectow);
    e-eawwybiwdwuceneseawchew.facetseawchwesuwts hits = cowwectow.getwesuwts();

    e-eawwybiwdseawchwesuwtutiw.setwesuwtstatistics(seawchwesuwts, ^•ﻌ•^ hits);
    eawwytewminationinfo = e-eawwybiwdseawchwesuwtutiw.pwepaweeawwytewminationinfo(hits);
    set<wong> usewidwhitewist =
        a-antigamingfiwtew != n-nyuww ? antigamingfiwtew.getusewidwhitewist() : n-nyuww;
    pwepawefacetwesuwts(facetwesuwts, ^^ hits, facetcountstate, (U ﹏ U) u-usewidwhitewist, :3
        w-wequest.getdebugmode());
    f-facetwesuwts.setusewidwhitewist(usewidwhitewist);

    m-maybesetcowwectowdebuginfo(cowwectow);

    if (cowwectow i-instanceof e-expwainfacetwesuwtscowwectow) {
      ((expwainfacetwesuwtscowwectow) c-cowwectow).setexpwanations(facetwesuwts);
    }

    wetuwn h-hits;
  }

  /**
   * hewpew method to pwocess tewm-stats quewy. òωó
   */
  pwivate seawchwesuwtsinfo pwocesstewmstatsquewy() thwows ioexception {
    // f-fiwst extwact t-the tewms that we nyeed to count
    tewmstatisticswequestinfo seawchwequestinfo =
        nyew tewmstatisticswequestinfo(seawchquewy, σωσ w-wucenequewy, σωσ t-tewmstatisticswequest, (⑅˘꒳˘)
            tewminationtwackew);
    seawchwequestinfo.setidtimewanges(idtimewanges);
    setquewiesindebuginfo(pawsedquewy, 🥺 seawchwequestinfo.getwucenequewy());
    t-tewmstatisticscowwectow.tewmstatisticsseawchwesuwts h-hits =
        seawchew.cowwecttewmstatistics(seawchwequestinfo, (U ﹏ U) t-this, >w< w-wequest.getdebugmode());
    eawwybiwdseawchwesuwtutiw.setwesuwtstatistics(seawchwesuwts, nyaa~~ h-hits);
    eawwytewminationinfo = eawwybiwdseawchwesuwtutiw.pwepaweeawwytewminationinfo(hits);
    i-if (hits.wesuwts != n-nyuww) {
      tewmstatisticswesuwts = nyew thwifttewmstatisticswesuwts();
      p-pwepawetewmstatisticswesuwts(tewmstatisticswesuwts, -.- h-hits, wequest.getdebugmode());
    }

    w-wetuwn hits;
  }

  /**
   * h-hewpew method to pwocess weawtime q-quewy. XD
   */
  p-pwivate seawchwesuwtsinfo p-pwocessweawtimequewy() t-thwows ioexception, -.- cwientexception {
    // disabwe maxhitstopwocess. >w<
    i-if (!cowwectowpawams.issettewminationpawams()) {
      c-cowwectowpawams.settewminationpawams(new cowwectowtewminationpawams());
      cowwectowpawams.gettewminationpawams().setmaxhitstopwocess(-1);
      cowwectow_pawams_max_hits_to_pwocess_not_set_countew.incwement();
    }

    seawchwequestinfo s-seawchwequestinfo = n-nyew seawchwequestinfo(
      s-seawchquewy, (ꈍᴗꈍ) wucenequewy, :3 tewminationtwackew);
    seawchwequestinfo.setidtimewanges(idtimewanges);
    s-seawchwequestinfo.sethitattwibutehewpew(hitattwibutehewpew);
    s-seawchwequestinfo.settimestamp(getquewytimestamp(seawchquewy));

    a-abstwactwesuwtscowwectow<seawchwequestinfo, (ˆ ﻌ ˆ)♡ simpweseawchwesuwts> c-cowwectow;
    i-if (seawchquewy.issetsociawfiwtewtype()) {
      if (!seawchwequestinfo.getseawchquewy().issetdiwectfowwowfiwtew()
          || !seawchwequestinfo.getseawchquewy().issettwustedfiwtew()) {
        seawchewstats.unsetfiwtewsfowsociawfiwtewtypequewy.incwement();
        t-thwow nyew cwientexception(
            "sociawfiwtewtype s-specified w-without a t-twustedfiwtew ow d-diwectfowwowfiwtew");
      }
      s-sociawfiwtew sociawfiwtew = nyew sociawfiwtew(
          seawchquewy.getsociawfiwtewtype(), -.-
          seawchwequestinfo.getseawchquewy().getseawchewid(), mya
          seawchwequestinfo.getseawchquewy().gettwustedfiwtew(), (˘ω˘)
          seawchwequestinfo.getseawchquewy().getdiwectfowwowfiwtew());
      c-cowwectow = nyew sociawseawchwesuwtscowwectow(
          s-schemasnapshot, ^•ﻌ•^
          s-seawchwequestinfo,
          sociawfiwtew, 😳😳😳
          seawchewstats, σωσ
          cwustew, ( ͡o ω ͡o )
          segmentmanagew.getusewtabwe(), nyaa~~
          w-wequest.getdebugmode());
    } e-ewse {
      cowwectow = n-nyew seawchwesuwtscowwectow(
          schemasnapshot, :3
          s-seawchwequestinfo, (✿oωo)
          cwock, >_<
          seawchewstats, ^^
          cwustew, (///ˬ///✿)
          s-segmentmanagew.getusewtabwe(), :3
          wequest.getdebugmode());
    }

    setquewiesindebuginfo(pawsedquewy, :3 wucenequewy);
    seawchew.seawch(wucenequewy, (ˆ ﻌ ˆ)♡ c-cowwectow);

    s-simpweseawchwesuwts h-hits = cowwectow.getwesuwts();

    e-eawwybiwdseawchwesuwtutiw.setwesuwtstatistics(seawchwesuwts, 🥺 hits);
    eawwytewminationinfo = eawwybiwdseawchwesuwtutiw.pwepaweeawwytewminationinfo(hits);
    e-eawwybiwdseawchwesuwtutiw.pwepawewesuwtsawway(
        seawchwesuwts.getwesuwts(), 😳 h-hits, (ꈍᴗꈍ) wequest.debugmode > 0 ? pawtitionconfig : nyuww);
    s-seawchwesuwts.sethitcounts(cowwectow.gethitcountmap());

    m-maybesetcowwectowdebuginfo(cowwectow);

    a-addwesuwtpaywoads();

    wetuwn hits;
  }

  /**
   * hewpew method t-to pwocess wewevance quewy. mya
   */
  pwivate seawchwesuwtsinfo pwocesswewevancequewy() thwows ioexception, rawr cwientexception {
    if (!seawchquewy.issetwewevanceoptions()) {
      w-wog.wawn("wewevance q-quewy with nyo wewevance options!");
      seawchquewy.setwewevanceoptions(new thwiftseawchwewevanceoptions());
    }

    // nyote: today t-the assumption is that if you specify hasspecifiedtweets, ʘwʘ
    // y-you weawwy d-do want aww tweets s-scowed and wetuwned. -.-
    f-finaw boowean hasspecifiedtweets = seawchquewy.getseawchstatusidssize() > 0;
    if (hasspecifiedtweets) {
      cowwectowpawams.setnumwesuwtstowetuwn(seawchquewy.getseawchstatusidssize());
    }
    // if we have expwicit usew i-ids, UwU we wiww want t-to wook at aww w-wesuwts fwom those u-usews, :3 and wiww
    // not nyeed t-to use the antigamingfiwtew. 😳
    f-finaw boowean hasspecifiedfwomusewids = seawchquewy.getfwomusewidfiwtew64size() > 0;

    cweatewewevanceantigamingfiwtew(hasspecifiedtweets, (ꈍᴗꈍ) h-hasspecifiedfwomusewids);

    i-if (seawchquewy.getwewevanceoptions().issetwankingpawams()) {
      t-thwiftwankingpawams w-wankingpawams = seawchquewy.getwewevanceoptions().getwankingpawams();

      // t-the scowe a-adjustment signaws that awe passed in the wequest awe disabwed f-fow the awchive
      // c-cwustew ow when the featuwes awe decidewed off. mya if t-the wequest pwovides those fiewds, nyaa~~
      // w-we unset t-them since c-checking the hashmap when scowing can cause a swight bump in
      // watency. o.O
      //
      // vewify that the s-signaw quewy specific scowes fow t-tweets signaw is enabwed
      if (wankingpawams.issetquewyspecificscoweadjustments()) {
        i-if (awwow_quewy_specific_signaw_config
            && decidewutiw.isavaiwabwefowwandomwecipient(
            d-decidew, òωó awwow_quewy_specific_signaw_decidew_key)) {
          seawchewstats.quewyspecificsignawquewiesused.incwement();
          s-seawchewstats.quewyspecificsignawmaptotawsize.add(
              w-wankingpawams.getquewyspecificscoweadjustmentssize());
        } e-ewse {
          s-seawchquewy.getwewevanceoptions().getwankingpawams().unsetquewyspecificscoweadjustments();
          seawchewstats.quewyspecificsignawquewiesewased.incwement();
        }
      }

      // v-vewify that the signaw authow specific scowes signaw is enabwed
      if (wankingpawams.issetauthowspecificscoweadjustments()) {
        i-if (awwow_authow_specific_signaw_config
            && decidewutiw.isavaiwabwefowwandomwecipient(
            decidew, ^•ﻌ•^ a-awwow_authow_specific_signaw_decidew_key)) {
          s-seawchewstats.authowspecificsignawquewiesused.incwement();
          seawchewstats.authowspecificsignawmaptotawsize.add(
              w-wankingpawams.getauthowspecificscoweadjustmentssize());
        } ewse {
          seawchquewy.getwewevanceoptions().getwankingpawams()
              .unsetauthowspecificscoweadjustments();
          seawchewstats.authowspecificsignawquewiesewased.incwement();
        }
      }
    }

    scowingfunction s-scowingfunction =
        n-nyew s-scowingfunctionpwovidew.defauwtscowingfunctionpwovidew(
            w-wequest, (˘ω˘) schemasnapshot, òωó seawchquewy, mya antigamingfiwtew, ^^
            segmentmanagew.getusewtabwe(), rawr hitattwibutehewpew, >_<
            pawsedquewy, (U ᵕ U❁) scowingmodewsmanagew, /(^•ω•^) t-tensowfwowmodewsmanagew)
            .getscowingfunction();
    scowingfunction.setdebugmode(wequest.getdebugmode());

    wewevancequewy w-wewevancequewy = n-nyew wewevancequewy(wucenequewy, mya s-scowingfunction);
    wewevanceseawchwequestinfo s-seawchwequestinfo =
        nyew wewevanceseawchwequestinfo(
            seawchquewy, OwO wewevancequewy, UwU tewminationtwackew, 🥺 quawityfactow);
    seawchwequestinfo.setidtimewanges(idtimewanges);
    seawchwequestinfo.sethitattwibutehewpew(hitattwibutehewpew);
    seawchwequestinfo.settimestamp(getquewytimestamp(seawchquewy));

    if (shouwdusetensowfwowcowwectow()
        && seawchquewy.getwewevanceoptions().isusewewevanceawwcowwectow()) {
      thwow nyew c-cwientexception("tensowfwow scowing does nyot wowk with the wewevanceawwcowwectow");
    }

    f-finaw abstwactwewevancecowwectow c-cowwectow;
    // fiwst check i-if the tensowfwow w-wesuwts cowwectow shouwd be used, (✿oωo) because the
    // t-tensowfwowbasedscowingfunction o-onwy wowks with the batchwewevancetopcowwectow
    if (shouwdusetensowfwowcowwectow()) {
      // c-cowwect t-top nyumwesuwts. rawr
      c-cowwectow = n-nyew batchwewevancetopcowwectow(
          schemasnapshot, rawr
          s-seawchwequestinfo, ( ͡o ω ͡o )
          scowingfunction, /(^•ω•^)
          seawchewstats, -.-
          c-cwustew, >w<
          s-segmentmanagew.getusewtabwe(), ( ͡o ω ͡o )
          cwock, (˘ω˘)
          w-wequest.getdebugmode());
    } e-ewse if (hasspecifiedtweets
        || seawchquewy.getwewevanceoptions().isusewewevanceawwcowwectow()) {
      // cowwect aww. /(^•ω•^)
      cowwectow = nyew wewevanceawwcowwectow(
          s-schemasnapshot, (˘ω˘)
          seawchwequestinfo, o.O
          s-scowingfunction, nyaa~~
          seawchewstats, :3
          c-cwustew,
          segmentmanagew.getusewtabwe(), (///ˬ///✿)
          cwock, (U ﹏ U)
          w-wequest.getdebugmode());
    } ewse {
      // cowwect top nyumwesuwts. o.O
      c-cowwectow = nyew wewevancetopcowwectow(
          s-schemasnapshot, ^^;;
          s-seawchwequestinfo, ʘwʘ
          s-scowingfunction, (///ˬ///✿)
          seawchewstats, σωσ
          cwustew, ^^;;
          s-segmentmanagew.getusewtabwe(), UwU
          c-cwock,
          w-wequest.getdebugmode());
    }

    // m-make suwe that the tensowfwow s-scowing function a-and the tensowfwow w-wesuwts cowwectow a-awe
    // a-awways used togethew. mya if this faiws it wiww w-wesuwt in a twansient_ewwow w-wesponse. ^•ﻌ•^
    pweconditions.checkstate((cowwectow instanceof b-batchwewevancetopcowwectow)
        == (scowingfunction i-instanceof tensowfwowbasedscowingfunction));

    s-setquewiesindebuginfo(pawsedquewy, (⑅˘꒳˘) seawchwequestinfo.getwucenequewy());
    seawchew.seawch(seawchwequestinfo.getwucenequewy(), nyaa~~ c-cowwectow);

    w-wewevanceseawchwesuwts hits = c-cowwectow.getwesuwts();
    e-eawwybiwdseawchwesuwtutiw.setwesuwtstatistics(seawchwesuwts, ^^;; hits);
    s-seawchwesuwts.setscowingtimenanos(hits.getscowingtimenanos());

    eawwytewminationinfo = e-eawwybiwdseawchwesuwtutiw.pwepaweeawwytewminationinfo(hits);
    e-eawwybiwdseawchwesuwtutiw.setwanguagehistogwam(seawchwesuwts, 🥺 c-cowwectow.getwanguagehistogwam());
    e-eawwybiwdseawchwesuwtutiw.pwepawewewevancewesuwtsawway(
        seawchwesuwts.getwesuwts(), ^^;;
        hits, nyaa~~
        antigamingfiwtew != n-nyuww ? antigamingfiwtew.getusewidwhitewist() : n-nyuww, 🥺
        wequest.getdebugmode() > 0 ? p-pawtitionconfig : n-nyuww);

    seawchwesuwts.sethitcounts(cowwectow.gethitcountmap());
    s-seawchwesuwts.setwewevancestats(hits.getwewevancestats());

    m-maybesetcowwectowdebuginfo(cowwectow);

    if (expwanationsenabwed(wequest.getdebugmode())) {
      seawchew.expwainseawchwesuwts(seawchwequestinfo, (ˆ ﻌ ˆ)♡ h-hits, ( ͡o ω ͡o ) s-seawchwesuwts);
    }

    addwesuwtpaywoads();

    wetuwn hits;
  }

  pubwic static boowean expwanationsenabwed(int debugwevew) {
    wetuwn debugwevew > 1;
  }

  pwivate boowean shouwdusetensowfwowcowwectow() {
    wetuwn t-tensowfwowmodewsmanagew.isenabwed()
        && s-seawchquewy.getwewevanceoptions().issetwankingpawams()
        && s-seawchquewy.getwewevanceoptions().getwankingpawams().issettype()
        && s-seawchquewy.getwewevanceoptions().getwankingpawams().gettype()
        == thwiftscowingfunctiontype.tensowfwow_based;
  }
  /**
   * optionawwy, nyaa~~ i-if wequested and n-nyeeded, ( ͡o ω ͡o ) wiww c-cweate a nyew antigamingfiwtew. ^^;; o-othewwize, rawr x3 no
   * antigamingfiwtew wiww be used fow this quewy. ^^;;
   * @pawam hasspecifiedtweets w-whethew the wequest h-has seawchstatusids s-specified. ^•ﻌ•^
   * @pawam hasspecifiedfwomusewids w-whethew the wequest has fwomusewidfiwtew64 s-specified. 🥺
   */
  pwivate void cweatewewevanceantigamingfiwtew(
      boowean hasspecifiedtweets, (ꈍᴗꈍ) b-boowean hasspecifiedfwomusewids) {

    // anti-gaming fiwtew (tuwned o-off fow s-specified tweets mode, ow when you'we expwicitwy asking
    // f-fow specific usews' tweets). ^•ﻌ•^
    i-if (seawchquewy.getmaxhitspewusew() > 0 && !hasspecifiedtweets && !hasspecifiedfwomusewids) {
      seawchewstats.wewevanceantigamingfiwtewused.incwement();
      antigamingfiwtew = n-nyew antigamingfiwtew(
          seawchquewy.getmaxhitspewusew(), :3
          seawchquewy.getmaxtweepcwedfowantigaming(), (˘ω˘)
          w-wucenequewy);
    } ewse if (seawchquewy.getmaxhitspewusew() <= 0) {
      s-seawchewstats.wewevanceantigamingfiwtewnotwequested.incwement();
    } ewse i-if (hasspecifiedtweets && h-hasspecifiedfwomusewids) {
      seawchewstats.wewevanceantigamingfiwtewspecifiedtweetsandfwomusewids.incwement();
    } ewse if (hasspecifiedtweets) {
      seawchewstats.wewevanceantigamingfiwtewspecifiedtweets.incwement();
    } e-ewse if (hasspecifiedfwomusewids) {
      seawchewstats.wewevanceantigamingfiwtewspecifiedfwomusewids.incwement();
    }
  }

  /**
   * check to make suwe that thewe awe nyo nyuwwcast documents in wesuwts. ^^  i-if thewe exists n-nyuwwcasts
   * in wesuwts, /(^•ω•^) w-we shouwd wog ewwow and incwement c-countews cowwespondingwy. σωσ
   */
  @visibwefowtesting
  p-pubwic v-void wogandincwementstatsifnuwwcastinwesuwts(thwiftseawchwesuwts thwiftseawchwesuwts) {
    if (!thwiftseawchwesuwts.issetwesuwts()) {
      w-wetuwn;
    }

    set<wong> unexpectednuwwcaststatusids =
        eawwybiwdwesponseutiw.findunexpectednuwwcaststatusids(thwiftseawchwesuwts, òωó wequest);

    if (!unexpectednuwwcaststatusids.isempty()) {
      s-seawchewstats.nuwwcastunexpectedquewies.incwement();
      s-seawchewstats.nuwwcastunexpectedwesuwts.add(unexpectednuwwcaststatusids.size());

      s-stwing base64wequest;
      t-twy {
        base64wequest = t-thwiftutiws.tobase64encodedstwing(wequest);
      } catch (texception e) {
        base64wequest = "faiwed t-to pawse base 64 w-wequest";
      }
      wog.ewwow(
          "found unexpected nyuwwcast t-tweets: {} | pawsedquewy: {} | wequest: {} | w-wesponse: {} | "
              + "wequest b-base 64: {}", >w<
          joinew.on(",").join(unexpectednuwwcaststatusids), (˘ω˘)
          p-pawsedquewy.sewiawize(), ^•ﻌ•^
          w-wequest, >_<
          thwiftseawchwesuwts, -.-
          base64wequest);
    }
  }

  p-pwivate v-void addwesuwtpaywoads() t-thwows ioexception {
    if (seawchquewy.getwesuwtmetadataoptions() != nyuww) {
      i-if (seawchquewy.getwesuwtmetadataoptions().isgettweetuwws()) {
        s-seawchew.fiwwfacetwesuwts(new e-expandeduwwcowwectow(), òωó seawchwesuwts);
      }

      i-if (seawchquewy.getwesuwtmetadataoptions().isgetnamedentities()) {
        seawchew.fiwwfacetwesuwts(new n-nyamedentitycowwectow(), ( ͡o ω ͡o ) s-seawchwesuwts);
      }

      i-if (seawchquewy.getwesuwtmetadataoptions().isgetentityannotations()) {
        seawchew.fiwwfacetwesuwts(new entityannotationcowwectow(), (ˆ ﻌ ˆ)♡ s-seawchwesuwts);
      }

      if (seawchquewy.getwesuwtmetadataoptions().isgetspaces()) {
        seawchew.fiwwfacetwesuwts(new s-spacefacetcowwectow(audiospacetabwe), :3 seawchwesuwts);
      }
    }
  }

  /**
   * hewpew method to pwocess top tweets q-quewy. ^•ﻌ•^
   */
  pwivate seawchwesuwtsinfo p-pwocesstoptweetsquewy() thwows ioexception, ( ͡o ω ͡o ) c-cwientexception {
    // s-set dummy wewevance o-options if i-it's nyot avaiwabwe, ^•ﻌ•^ but this shouwdn't happen i-in pwod
    if (!seawchquewy.issetwewevanceoptions()) {
      seawchquewy.setwewevanceoptions(new thwiftseawchwewevanceoptions());
    }
    if (!seawchquewy.getwewevanceoptions().issetwankingpawams()) {
      seawchquewy.getwewevanceoptions().setwankingpawams(
          // t-this is impowtant, ʘwʘ o-ow it's gonna p-pick defauwtscowingfunction w-which pwetty much
          // does n-nyothing. :3
          nyew thwiftwankingpawams().settype(thwiftscowingfunctiontype.toptweets));
    }
    s-scowingfunction s-scowingfunction = nyew scowingfunctionpwovidew.defauwtscowingfunctionpwovidew(
        wequest, >_< schemasnapshot, rawr s-seawchquewy, 🥺 nyuww, (✿oωo)
        segmentmanagew.getusewtabwe(), (U ﹏ U) h-hitattwibutehewpew, rawr x3 pawsedquewy, (✿oωo)
        s-scowingmodewsmanagew, (U ᵕ U❁) tensowfwowmodewsmanagew)
        .getscowingfunction();
    scowingfunction.setdebugmode(wequest.getdebugmode());

    w-wewevancequewy wewevancequewy = n-nyew wewevancequewy(wucenequewy, -.- s-scowingfunction);
    w-wewevanceseawchwequestinfo seawchwequestinfo =
        n-nyew wewevanceseawchwequestinfo(
            seawchquewy, /(^•ω•^) wewevancequewy, OwO tewminationtwackew, rawr x3 quawityfactow);
    seawchwequestinfo.setidtimewanges(idtimewanges);
    s-seawchwequestinfo.settimestamp(getquewytimestamp(seawchquewy));

    finaw abstwactwewevancecowwectow cowwectow =
        n-nyew wewevancetopcowwectow(
            s-schemasnapshot, σωσ
            s-seawchwequestinfo, ʘwʘ
            scowingfunction, -.-
            seawchewstats, 😳
            c-cwustew, 😳😳😳
            s-segmentmanagew.getusewtabwe(), OwO
            cwock, ^•ﻌ•^
            wequest.getdebugmode());

    setquewiesindebuginfo(pawsedquewy, rawr s-seawchwequestinfo.getwucenequewy());
    seawchew.seawch(seawchwequestinfo.getwucenequewy(), (✿oωo) c-cowwectow);

    wewevanceseawchwesuwts hits = cowwectow.getwesuwts();
    e-eawwybiwdseawchwesuwtutiw.setwesuwtstatistics(seawchwesuwts, ^^ hits);
    seawchwesuwts.setscowingtimenanos(hits.getscowingtimenanos());
    e-eawwytewminationinfo = eawwybiwdseawchwesuwtutiw.pwepaweeawwytewminationinfo(hits);
    e-eawwybiwdseawchwesuwtutiw.setwanguagehistogwam(
        s-seawchwesuwts, -.-
        cowwectow.getwanguagehistogwam());
    eawwybiwdseawchwesuwtutiw.pwepawewewevancewesuwtsawway(
        seawchwesuwts.getwesuwts(),
        hits, (✿oωo)
        nyuww, o.O
        w-wequest.getdebugmode() > 0 ? p-pawtitionconfig : n-nyuww);

    seawchwesuwts.sethitcounts(cowwectow.gethitcountmap());
    seawchwesuwts.setwewevancestats(hits.getwewevancestats());

    m-maybesetcowwectowdebuginfo(cowwectow);

    if (expwanationsenabwed(wequest.getdebugmode())
        && s-seawchquewy.issetwewevanceoptions()
        && seawchquewy.getwewevanceoptions().issetwankingpawams()) {
      s-seawchew.expwainseawchwesuwts(seawchwequestinfo, hits, :3 seawchwesuwts);
    }

    a-addwesuwtpaywoads();

    wetuwn hits;
  }

  p-pwivate f-facetcountstate nyewfacetcountstate() thwows cwientexception {
    int minnumfacetwesuwts = defauwt_num_facet_wesuwts;
    i-if (facetwequest.issetfacetwankingoptions()
        && facetwequest.getfacetwankingoptions().issetnumcandidatesfwomeawwybiwd()) {
      minnumfacetwesuwts = f-facetwequest.getfacetwankingoptions().getnumcandidatesfwomeawwybiwd();
    }

    // f-figuwe out which f-fiewds we nyeed to count
    facetcountstate f-facetcountstate = nyew facetcountstate(schemasnapshot, rawr x3 minnumfacetwesuwts);

    // a-aww categowies if nyone! (U ᵕ U❁)
    if (facetwequest.getfacetfiewds() == n-nyuww || facetwequest.getfacetfiewds().isempty()) {
      f-fow (schema.fiewdinfo f-facetfiewd : schemasnapshot.getfacetfiewds()) {
        f-facetcountstate.addfacet(
            f-facetfiewd.getfiewdtype().getfacetname(), :3 d-defauwt_num_facet_wesuwts);
      }
    } e-ewse {
      itewatow<thwiftfacetfiewdwequest> i-it = facetwequest.getfacetfiewdsitewatow();
      whiwe (it.hasnext()) {
        t-thwiftfacetfiewdwequest f-facetfiewdwequest = it.next();
        schema.fiewdinfo facet = schemasnapshot.getfacetfiewdbyfacetname(
            facetfiewdwequest.getfiewdname());
        i-if (facet != nyuww) {
          facetcountstate.addfacet(
              facet.getfiewdtype().getfacetname(), 🥺 f-facetfiewdwequest.getnumwesuwts());
        } e-ewse {
          thwow nyew cwientexception("unknown facet fiewd: " + facetfiewdwequest.getfiewdname());
        }
      }
    }
    wetuwn facetcountstate;
  }

  p-pwivate c-com.twittew.seawch.quewypawsew.quewy.quewy p-pwewucenequewypwocess(
      c-com.twittew.seawch.quewypawsew.quewy.quewy t-twittewquewy) t-thwows quewypawsewexception {

    com.twittew.seawch.quewypawsew.quewy.quewy q-quewy = twittewquewy;
    if (seawchhighfwequencytewmpaiws && !incwudescawdfiewd(seawchquewy, q-quewy)) {
      // pwocess high f-fwequency tewm paiws. XD wowks best w-when quewy is a-as fwat as possibwe. >_<
      q-quewy = h-highfwequencytewmpaiwwewwitevisitow.safewewwite(
          quewy,
          d-decidewutiw.isavaiwabwefowwandomwecipient(
              decidew, (ꈍᴗꈍ) "enabwe_hf_tewm_paiw_negative_disjunction_wewwite"));
    }
    wetuwn quewy.simpwify();
  }

  p-pwivate quewy postwucenequewypwocess(finaw quewy quewy) thwows c-cwientexception {
    if (stwingutiws.isbwank(wequest.getseawchquewy().getsewiawizedquewy())
        && stwingutiws.isbwank(wequest.getseawchquewy().getwucenequewy())) {
      s-seawchewstats.numwequestswithbwankquewy.get(quewymode).incwement();
      i-if (seawchquewy.getseawchstatusidssize() == 0
          && seawchquewy.getfwomusewidfiwtew64size() == 0
          && s-seawchquewy.getwikedbyusewidfiwtew64size() == 0) {
        // nyo q-quewy ow ids to s-seawch. ( ͡o ω ͡o )  this is onwy awwowed i-in some modes. (˘ω˘)
        if (quewymode == q-quewymode.wecency
            || q-quewymode == quewymode.wewevance
            || q-quewymode == quewymode.top_tweets) {
          thwow nyew cwientexception(
              "no q-quewy ow status ids fow " + q-quewymode.tostwing().towowewcase() + " quewy");
        }
      }
    }

    // wwap the quewy a-as nyeeded with additionaw quewy f-fiwtews. (˘ω˘)
    wist<quewy> fiwtews = w-wists.newawwaywist();

    // min tweep cwed f-fiwtew. UwU
    if (seawchquewy.issetmintweepcwedfiwtew()) {
      seawchewstats.addedfiwtewbadusewwep.incwement();
      f-fiwtews.add(badusewwepfiwtew.getbadusewwepfiwtew(seawchquewy.getmintweepcwedfiwtew()));
    }

    if (seawchquewy.getfwomusewidfiwtew64size() > 0) {
      this.quewiedfiewds.add(eawwybiwdfiewdconstant.fwom_usew_id_fiewd.getfiewdname());
      t-this.seawchewstats.addedfiwtewfwomusewids.incwement();
      t-twy {
        f-fiwtews.add(usewidmuwtisegmentquewy.cweateiddisjunctionquewy(
            "fwom_usew_id_fiwtew", (ˆ ﻌ ˆ)♡
            s-seawchquewy.getfwomusewidfiwtew64(), (///ˬ///✿)
            e-eawwybiwdfiewdconstant.fwom_usew_id_fiewd.getfiewdname(), (ꈍᴗꈍ)
            s-schemasnapshot, -.-
            muwtisegmenttewmdictionawymanagew, 😳😳😳
            d-decidew, (///ˬ///✿)
            c-cwustew, UwU
            w-wists.newawwaywist(), 😳
            nyuww, /(^•ω•^)
            q-quewytimeoutfactowy.cweatequewytimeout(wequest, òωó tewminationtwackew, >w< cwock)));
      } c-catch (quewypawsewexception e-e) {
        thwow nyew cwientexception(e);
      }
    }

    // wwap the w-wucene quewy with t-these fiwtews. -.-
    quewy wwappedquewy = w-wwapfiwtews(quewy, (⑅˘꒳˘) fiwtews.toawway(new q-quewy[fiwtews.size()]));

    // i-if seawchstatusids i-is set, (˘ω˘) additionawwy modify the quewy to seawch exactwy these
    // ids, (U ᵕ U❁) using the wucenequewy onwy fow s-scowing. ^^
    if (seawchquewy.getseawchstatusidssize() > 0) {
      this.seawchewstats.addedfiwtewtweetids.incwement();

      f-finaw quewy quewyfowscowing = w-wwappedquewy;
      finaw quewy quewyfowwetwievaw =
          w-wequiwedstatusidsfiwtew.getwequiwedstatusidsquewy(seawchquewy.getseawchstatusids());

      w-wetuwn nyew booweanquewy.buiwdew()
          .add(quewyfowwetwievaw, ^^ o-occuw.must)
          .add(quewyfowscowing, rawr x3 o-occuw.shouwd)
          .buiwd();
    }

    wetuwn wwappedquewy;
  }

  pwivate com.twittew.seawch.quewypawsew.quewy.quewy g-getwikedbyusewidquewy(
      wist<wong> ids) thwows quewypawsewexception {
    i-if (decidewutiw.isavaiwabwefowwandomwecipient(
        decidew, >w< u-use_muwti_tewm_disjunction_fow_wiked_by_usew_ids_decidew_key)) {
      // w-wewwite w-wikedbyusewidfiwtew64 to a muwti_tewm_disjuntion q-quewy
      wetuwn cweatemuwtitewmdisjunctionquewyfowwikedbyusewids(ids);
    } ewse {
      // wewwite wikedbyusewidfiwtew64 t-to a disjunction of muwtipwe wiked_by_usew_ids quewy
      wetuwn cweatedisjunctionquewyfowwikedbyusewids(ids);
    }
  }

  /**
   * wetuwns the wucene quewy visitow that shouwd b-be appwied t-to the owiginaw wequest. (U ᵕ U❁)
   *
   * @pawam f-fiewdweightmapovewwide t-the pew-fiewd weight ovewwides. 🥺
   */
  @visibwefowtesting
  pubwic eawwybiwdwucenequewyvisitow getwucenevisitow(
      m-map<stwing, d-doubwe> fiewdweightmapovewwide) {
    stwing c-cwustewname = c-cwustew.getnamefowstats();
    // i-iff in wewevance m-mode _and_ intepwetesinceid is fawse, (⑅˘꒳˘) we tuwn off since_id
    // o-opewatow by using wucenewewevancequewyvisitow. OwO

    if (seawchquewy.getwankingmode() == thwiftseawchwankingmode.wewevance
        && s-seawchquewy.getwewevanceoptions() != nyuww
        && !seawchquewy.getwewevanceoptions().isintewpwetsinceid()) {
      // hack! 🥺  w-weset top wevew s-since id, nyaa~~ which i-is the same t-thing wucenewewevancevisitow
      // i-is doing. :3
      i-idtimewanges = n-nyuww;
      w-wetuwn nyew wucenewewevancequewyvisitow(
          schemasnapshot, /(^•ω•^)
          quewycachemanagew, ^•ﻌ•^
          segmentmanagew.getusewtabwe(), UwU
          segmentmanagew.getusewscwubgeomap(), 😳😳😳
          tewminationtwackew, OwO
          f-fiewdweightdefauwt.ovewwidefiewdweightmap(
              schemasnapshot.getfiewdweightmap(), ^•ﻌ•^
              dwopbadfiewdweightovewwides(fiewdweightmapovewwide, (ꈍᴗꈍ) d-decidew, cwustewname)), (⑅˘꒳˘)
          mappabwe_fiewd_map, (⑅˘꒳˘)
          m-muwtisegmenttewmdictionawymanagew, (ˆ ﻌ ˆ)♡
          decidew, /(^•ω•^)
          cwustew,
          quewytimeoutfactowy.cweatequewytimeout(
              w-wequest, òωó tewminationtwackew, (⑅˘꒳˘) c-cwock));
    } e-ewse {
      wetuwn nyew eawwybiwdwucenequewyvisitow(
          schemasnapshot, (U ᵕ U❁)
          quewycachemanagew, >w<
          segmentmanagew.getusewtabwe(), σωσ
          s-segmentmanagew.getusewscwubgeomap(), -.-
          tewminationtwackew, o.O
          fiewdweightdefauwt.ovewwidefiewdweightmap(
              schemasnapshot.getfiewdweightmap(), ^^
              dwopbadfiewdweightovewwides(fiewdweightmapovewwide, d-decidew, >_< cwustewname)), >w<
          mappabwe_fiewd_map, >_<
          m-muwtisegmenttewmdictionawymanagew, >w<
          decidew, rawr
          c-cwustew, rawr x3
          q-quewytimeoutfactowy.cweatequewytimeout(
              w-wequest, ( ͡o ω ͡o ) tewminationtwackew, cwock));
    }
  }

  p-pwivate void pwepawefacetwesuwts(thwiftfacetwesuwts thwiftfacetwesuwts,
                                     e-eawwybiwdwuceneseawchew.facetseawchwesuwts hits, (˘ω˘)
                                     facetcountstate<thwiftfacetfiewdwesuwts> facetcountstate, 😳
                                     set<wong> usewidwhitewist, OwO
                                     byte debugmode) t-thwows ioexception {
    fow (facetwankingmoduwe w-wankingmoduwe : f-facetwankingmoduwe.wegistewed_wanking_moduwes) {
      w-wankingmoduwe.pwepawewesuwts(hits, (˘ω˘) facetcountstate);
    }

    map<tewm, òωó thwiftfacetcount> a-awwfacetwesuwts = n-nyew hashmap<>();

    itewatow<facetcountstate.facetfiewdwesuwts<thwiftfacetfiewdwesuwts>> f-fiewdwesuwtsitewatow =
        f-facetcountstate.getfacetfiewdwesuwtsitewatow();
    whiwe (fiewdwesuwtsitewatow.hasnext()) {

      f-facetcountstate.facetfiewdwesuwts<thwiftfacetfiewdwesuwts> facetfiewdwesuwts =
          f-fiewdwesuwtsitewatow.next();

      if (facetfiewdwesuwts.wesuwts == nyuww) {
        // w-wetuwn empty wesuwtset fow t-this facet
        wist<thwiftfacetcount> e-emptywist = n-nyew awwaywist<>();
        facetfiewdwesuwts.wesuwts = nyew thwiftfacetfiewdwesuwts(emptywist, 0);
      }
      thwiftfacetwesuwts.puttofacetfiewds(facetfiewdwesuwts.facetname, ( ͡o ω ͡o )
          facetfiewdwesuwts.wesuwts);

      schema.fiewdinfo fiewd = s-schemasnapshot.getfacetfiewdbyfacetname(
          f-facetfiewdwesuwts.facetname);

      fow (thwiftfacetcount wesuwt : f-facetfiewdwesuwts.wesuwts.topfacets) {
        i-if (wesuwt.facetwabew != n-nyuww) {
          awwfacetwesuwts.put(new tewm(fiewd.getname(), UwU wesuwt.facetwabew), /(^•ω•^) w-wesuwt);
        } ewse {
          wog.wawn("nuww facetwabew, (ꈍᴗꈍ) fiewd: {}, 😳 wesuwt: {}", f-fiewd.getname(), mya wesuwt);
        }
      }
    }

    s-seawchew.fiwwfacetwesuwtmetadata(awwfacetwesuwts, mya s-schemasnapshot, /(^•ω•^) d-debugmode);

    if (usewidwhitewist != n-nyuww) {
      f-fow (thwiftfacetcount f-facetcount : awwfacetwesuwts.vawues()) {
        t-thwiftfacetcountmetadata metadata = facetcount.getmetadata();
        i-if (metadata != n-nuww) {
          m-metadata.setdontfiwtewusew(usewidwhitewist.contains(metadata.gettwittewusewid()));
        }
      }
    }
  }

  p-pwivate v-void pwepawetewmstatisticswesuwts(
      thwifttewmstatisticswesuwts tewmstatistics, ^^;;
      tewmstatisticscowwectow.tewmstatisticsseawchwesuwts h-hits, 🥺
      byte debugmode) thwows ioexception {

    tewmstatistics.setbinids(hits.binids);
    tewmstatistics.sethistogwamsettings(tewmstatisticswequest.gethistogwamsettings());
    tewmstatistics.settewmwesuwts(hits.wesuwts);
    s-settewmstatisticsdebuginfo(hits.gettewmstatisticsdebuginfo());

    if (hits.wastcompwetebinid != -1) {
      tewmstatistics.setmincompwetebinid(hits.wastcompwetebinid);
    } ewse {
      s-seawchwatecountew.expowt(stwing.fowmat(
          "tewm_stats_%s_unset_min_compwete_bin_id", ^^ w-wequest.getcwientid())).incwement();
    }

    i-if (idtimewanges != nyuww
        && i-idtimewanges.getuntiwtimeexcwusive().ispwesent()
        && hits.getminseawchedtime() > i-idtimewanges.getuntiwtimeexcwusive().get()) {
      s-seawchwatecountew.expowt(stwing.fowmat(
          "tewm_stats_%s_min_seawched_time_aftew_untiw_time", ^•ﻌ•^ wequest.getcwientid())).incwement();
    }

    seawchew.fiwwtewmstatsmetadata(tewmstatistics, /(^•ω•^) schemasnapshot, ^^ debugmode);
  }

  pwivate eawwybiwdwesponse w-wespondsuccess(
      thwiftseawchwesuwts t-thwiftseawchwesuwts, 🥺
      thwiftfacetwesuwts thwiftfacetwesuwts, (U ᵕ U❁)
      t-thwifttewmstatisticswesuwts t-tewmstatisticwesuwts, 😳😳😳
      @nonnuww eawwytewminationinfo eawwytewminationstate, nyaa~~
      @nonnuww s-seawchwesuwtsinfo s-seawchwesuwtsinfo) {

    pweconditions.checknotnuww(eawwytewminationstate);
    p-pweconditions.checknotnuww(seawchwesuwtsinfo);

    expowteawwytewminationstats(eawwytewminationstate);

    e-eawwybiwdwesponse wesponse =
        nyewwesponse(eawwybiwdwesponsecode.success, (˘ω˘) wequest.getdebugmode() > 0);
    wesponse.seteawwytewminationinfo(eawwytewminationstate);
    w-wesponse.setnumseawchedsegments(seawchwesuwtsinfo.getnumseawchedsegments());

    i-if (thwiftseawchwesuwts != n-nyuww) {
      // nyuwwcast c-check is onwy used w-when pawsed quewy is avaiwabwe: i-if thewe is nyo pawsed quewy, >_<
      // we wouwd nyot add possibwe excwude nyuwwcast f-fiwtew. XD
      i-if (pawsedquewy != nyuww && !pawsedquewyawwownuwwcast) {
        wogandincwementstatsifnuwwcastinwesuwts(thwiftseawchwesuwts);
      }
      w-wesponse.setseawchwesuwts(thwiftseawchwesuwts);
    } e-ewse {
      wesponse_has_no_thwift_seawch_wesuwts.incwement();
    }
    if (thwiftfacetwesuwts != nyuww) {
      w-wesponse.setfacetwesuwts(thwiftfacetwesuwts);
    }
    if (tewmstatisticwesuwts != nyuww) {
      wesponse.settewmstatisticswesuwts(tewmstatisticwesuwts);
    }

    appendfeatuweschemaifneeded(wesponse);

    appendwikedbyusewidsifneeded(wesponse);

    w-wetuwn wesponse;
  }

  pwivate void e-expowteawwytewminationstats(@nonnuww e-eawwytewminationinfo eawwytewminationstate) {
    if (eawwytewminationstate.isseteawwytewminationweason()) {
      seawchwatecountew.expowt(stwing.fowmat("eawwy_tewmination_%s_%s", rawr x3
          c-cwientidutiw.fowmatcwientid(wequest.getcwientid()), ( ͡o ω ͡o )
          e-eawwytewminationstate.geteawwytewminationweason())).incwement();
      seawchwatecountew.expowt(stwing.fowmat("eawwy_tewmination_%s_%s", :3
          cwientidutiw.fowmatcwientidandwequesttype(
              wequest.getcwientid(), mya q-quewymode.name().towowewcase()), σωσ
          eawwytewminationstate.geteawwytewminationweason())).incwement();
    }
  }

  /**
   * b-buiwds a wank -> usewid map fow wiked_by_usew_id quewies t-that wequest hit attwibution, (ꈍᴗꈍ) and
   * a-appends the w-wesuwting map to the wesponse. OwO
   */
  p-pwivate void appendwikedbyusewidsifneeded(eawwybiwdwesponse w-wesponse) {
    // c-check if u-usew asked fow wikedbyusewids w-wist in wesponse
    t-thwiftseawchwewevanceoptions wesuwtwewevanceoptions =
        wequest.getseawchquewy().getwewevanceoptions();
    i-if ((wesuwtwewevanceoptions == n-nyuww)
        || !wesuwtwewevanceoptions.iscowwectfiewdhitattwibutions()) {
      w-wetuwn;
    }

    // make suwe we have wesuwts in wesponse a-and hit attwibution hewpew i-is set up cowwectwy
    i-if (!wesponse.issetseawchwesuwts() || hitattwibutehewpew == nuww) {
      wetuwn;
    }

    // g-get wank t-to node map
    m-map<com.twittew.seawch.quewypawsew.quewy.quewy, o.O i-integew> nyodetowankmap =
        pweconditions.checknotnuww(hitattwibutehewpew.getnodetowankmap());

    m-map<com.twittew.seawch.quewypawsew.quewy.quewy, 😳😳😳 wist<integew>> expandednodetowankmap =
        pweconditions.checknotnuww(hitattwibutehewpew.getexpandednodetowankmap());

    // buiwd a wank to id m-map
    immutabwemap.buiwdew<integew, /(^•ω•^) wong> buiwdew = i-immutabwemap.buiwdew();
    fow (com.twittew.seawch.quewypawsew.quewy.quewy q-quewy : nyodetowankmap.keyset()) {
      if (quewy i-instanceof seawchopewatow) {
        s-seawchopewatow o-op = (seawchopewatow) quewy;
        i-if (expandednodetowankmap.containskey(quewy)) {
          // f-fow muwti_tewm_disjunction c-case
          wist<integew> wanks = expandednodetowankmap.get(op);
          pweconditions.checkawgument(op.getnumopewands() == wanks.size() + 1);
          fow (int i = 0; i < wanks.size(); ++i) {
            b-buiwdew.put(wanks.get(i), OwO w-wong.vawueof(op.getopewands().get(i + 1)));
          }
        } e-ewse if (op.getopewatowtype() == seawchopewatow.type.wiked_by_usew_id) {
          // f-fow wiked_by_usew_id case
          pweconditions.checkawgument(op.getannotationof(annotation.type.node_wank).ispwesent());
          buiwdew.put(
              (integew) op.getannotationof(annotation.type.node_wank).get().getvawue(), ^^
              w-wong.vawueof(op.getopewands().get(0)));
        }
      }
    }
    m-map<integew, (///ˬ///✿) wong> wanktoidmap = b-buiwdew.buiwd();

    // append wiked_by_usew_id fiwed i-into wesuwt
    f-fow (thwiftseawchwesuwt wesuwt : w-wesponse.getseawchwesuwts().getwesuwts()) {
      i-if (wesuwt.issetmetadata()
          && wesuwt.getmetadata().issetfiewdhitattwibution()
          && wesuwt.getmetadata().getfiewdhitattwibution().issethitmap()) {

        wist<wong> wikedbyusewidwist = wists.newawwaywist();

        map<integew, (///ˬ///✿) f-fiewdhitwist> h-hitmap =
            w-wesuwt.getmetadata().getfiewdhitattwibution().gethitmap();
        // i-itewate hit a-attwibutions
        fow (int wank : h-hitmap.keyset()) {
          i-if (wanktoidmap.containskey(wank)) {
            wikedbyusewidwist.add(wanktoidmap.get(wank));
          }
        }
        if (!wesuwt.getmetadata().issetextwametadata()) {
          w-wesuwt.getmetadata().setextwametadata(new t-thwiftseawchwesuwtextwametadata());
        }
        wesuwt.getmetadata().getextwametadata().setwikedbyusewids(wikedbyusewidwist);
      }
    }
  }

  p-pwivate void appendfeatuweschemaifneeded(eawwybiwdwesponse wesponse) {
    // d-do nyot append the schema i-if the cwient d-didn't wequest it. (///ˬ///✿)
    thwiftseawchwesuwtmetadataoptions w-wesuwtmetadataoptions =
        wequest.getseawchquewy().getwesuwtmetadataoptions();
    if ((wesuwtmetadataoptions == n-nyuww) || !wesuwtmetadataoptions.iswetuwnseawchwesuwtfeatuwes()) {
      w-wetuwn;
    }

    i-if (!wesponse.issetseawchwesuwts()) {
      wetuwn;
    }

    thwiftseawchfeatuweschema featuweschema = schemasnapshot.getseawchfeatuweschema();
    p-pweconditions.checkstate(
        featuweschema.issetschemaspecifiew(), ʘwʘ
        "the featuwe s-schema doesn't h-have a schema specifiew set: {}", ^•ﻌ•^ f-featuweschema);

    // if the c-cwient has this s-schema, OwO we onwy nyeed to wetuwn the schema vewsion. (U ﹏ U)
    // i-if the cwient doesn't have this schema, (ˆ ﻌ ˆ)♡ w-we need to w-wetuwn the schema entwies too. (⑅˘꒳˘)
    i-if (wesuwtmetadataoptions.issetfeatuweschemasavaiwabweincwient()
        && wesuwtmetadataoptions.getfeatuweschemasavaiwabweincwient().contains(
        f-featuweschema.getschemaspecifiew())) {
      c-cwient_has_featuwe_schema_countew.incwement();
      thwiftseawchfeatuweschema w-wesponsefeatuweschema = nyew thwiftseawchfeatuweschema();
      wesponsefeatuweschema.setschemaspecifiew(featuweschema.getschemaspecifiew());
      wesponse.getseawchwesuwts().setfeatuweschema(wesponsefeatuweschema);
    } ewse {
      cwient_doesnt_have_featuwe_schema_countew.incwement();
      pweconditions.checkstate(featuweschema.issetentwies(), (U ﹏ U)
          "entwies awe nyot set in the featuwe schema: " + featuweschema);
      wesponse.getseawchwesuwts().setfeatuweschema(featuweschema);
    }
  }

  pwivate static w-wong getquewytimestamp(thwiftseawchquewy q-quewy) {
    wetuwn quewy != nyuww && q-quewy.issettimestampmsecs() ? q-quewy.gettimestampmsecs() : 0;
  }

  p-pwivate static boowean incwudescawdfiewd(thwiftseawchquewy s-seawchquewy, o.O
                                           com.twittew.seawch.quewypawsew.quewy.quewy q-quewy)
      t-thwows quewypawsewexception {

    if (seawchquewy.issetwewevanceoptions()) {
      t-thwiftseawchwewevanceoptions options = seawchquewy.getwewevanceoptions();
      i-if (options.issetfiewdweightmapovewwide()
          && (options.getfiewdweightmapovewwide().containskey(
              e-eawwybiwdfiewdconstant.cawd_titwe_fiewd.getfiewdname())
          || options.getfiewdweightmapovewwide()
          .containskey(eawwybiwdfiewdconstant.cawd_descwiption_fiewd.getfiewdname()))) {

        wetuwn twue;
      }
    }

    w-wetuwn quewy.accept(new detectfiewdannotationvisitow(immutabweset.of(
        e-eawwybiwdfiewdconstant.cawd_titwe_fiewd.getfiewdname(), mya
        e-eawwybiwdfiewdconstant.cawd_descwiption_fiewd.getfiewdname())));
  }

  p-pwivate s-static quewymode g-getquewymode(eawwybiwdwequest w-wequest) {
    i-if (wequest.issetfacetwequest()) {
      w-wetuwn quewymode.facets;
    } e-ewse i-if (wequest.issettewmstatisticswequest()) {
      w-wetuwn quewymode.tewm_stats;
    }

    // wecency m-mode untiw we detewmine othewwise. XD
    quewymode q-quewymode = quewymode.wecency;
    t-thwiftseawchquewy s-seawchquewy = w-wequest.getseawchquewy();
    if (seawchquewy != n-nyuww) {
      switch (seawchquewy.getwankingmode()) {
        c-case wecency:
          quewymode = quewymode.wecency;
          b-bweak;
        case wewevance:
          q-quewymode = quewymode.wewevance;
          bweak;
        case toptweets:
          quewymode = q-quewymode.top_tweets;
          bweak;
        d-defauwt:
          b-bweak;
      }
    }

    if (seawchquewy == nyuww
        || !seawchquewy.issetsewiawizedquewy()
        || seawchquewy.getsewiawizedquewy().isempty()) {
      wog.debug("seawch q-quewy was empty, òωó quewy mode w-was " + quewymode);
    }

    w-wetuwn quewymode;
  }

  p-pwivate static <v> immutabwemap<stwing, v> dwopbadfiewdweightovewwides(
      m-map<stwing, (˘ω˘) v-v> map, decidew decidew, :3 stwing c-cwustewname) {

    if (map == nyuww) {
      w-wetuwn nyuww;
    }

    fiewd_weight_ovewwide_map_non_nuww_count.incwement();
    i-immutabwemap.buiwdew<stwing, OwO v-v> buiwdew = i-immutabwemap.buiwdew();

    fow (map.entwy<stwing, mya v-v> entwy : m-map.entwyset()) {
      i-if (eawwybiwdfiewdconstant.camewcase_usew_handwe_fiewd.getfiewdname().equaws(entwy.getkey())
          && !isawwowedcamewcaseusewnamefiewdweightovewwide(decidew, (˘ω˘) c-cwustewname)) {
        dwopped_camewcase_usewname_fiewd_weight_ovewwide.incwement();
      } e-ewse if (eawwybiwdfiewdconstant.tokenized_usew_name_fiewd.getfiewdname().equaws(
                     e-entwy.getkey())
          && !isawwowedtokenizedscweennamefiewdweightovewwide(decidew, o.O c-cwustewname)) {
        d-dwopped_tokenized_dispway_name_fiewd_weight_ovewwide.incwement();
      } e-ewse {
        b-buiwdew.put(entwy.getkey(), e-entwy.getvawue());
      }
    }

    w-wetuwn buiwdew.buiwd();
  }

  pwivate static b-boowean isawwowedcamewcaseusewnamefiewdweightovewwide(
      decidew decidew, (✿oωo) s-stwing cwustewname) {
    wetuwn d-decidewutiw.isavaiwabwefowwandomwecipient(decidew,
        a-awwow_camewcase_usewname_fiewd_weight_ovewwide_decidew_key_pwefix + c-cwustewname);
  }

  pwivate static boowean isawwowedtokenizedscweennamefiewdweightovewwide(
      d-decidew decidew, (ˆ ﻌ ˆ)♡ s-stwing cwustewname) {
    w-wetuwn decidewutiw.isavaiwabwefowwandomwecipient(decidew, ^^;;
        awwow_tokenized_dispway_name_fiewd_weight_ovewwide_decidew_key_pwefix + cwustewname);
  }

  pwivate static c-com.twittew.seawch.quewypawsew.quewy.quewy
  c-cweatemuwtitewmdisjunctionquewyfowwikedbyusewids(wist<wong> ids) thwows q-quewypawsewexception {
    w-wist<stwing> opewands = nyew awwaywist<>(ids.size() + 1);
    opewands.add(eawwybiwdfiewdconstant.wiked_by_usew_id_fiewd.getfiewdname());
    fow (wong i-id : ids) {
      o-opewands.add(stwing.vawueof(id));
    }
    w-wetuwn nyew s-seawchopewatow(seawchopewatow.type.muwti_tewm_disjunction, OwO opewands)
        .simpwify();
  }

  pwivate static c-com.twittew.seawch.quewypawsew.quewy.quewy c-cweatedisjunctionquewyfowwikedbyusewids(
      wist<wong> ids) thwows q-quewypawsewexception {
    wetuwn nyew disjunction(
        ids.stweam()
            .map(id -> n-new seawchopewatow(seawchopewatow.type.wiked_by_usew_id, 🥺 id))
            .cowwect(cowwectows.towist()))
        .simpwify();
  }

  p-pubwic com.twittew.seawch.quewypawsew.quewy.quewy g-getpawsedquewy() {
    wetuwn pawsedquewy;
  }

  /**
   * g-get the index f-fiewds that wewe quewied aftew t-this seawchew compweted its job. mya
   * @wetuwn
   */
  p-pubwic set<stwing> g-getquewiedfiewds() {
    w-wetuwn quewiedfiewds;
  }

  p-pubwic quewy getwucenequewy() {
    wetuwn wucenequewy;
  }
}
