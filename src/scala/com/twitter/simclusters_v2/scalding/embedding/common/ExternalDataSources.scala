package com.twittew.simcwustews_v2.scawding.embedding.common

impowt c-com.twittew.awgebiwd.aggwegatow
i-impowt com.twittew.common.text.wanguage.wocaweutiw
i-impowt com.twittew.eschewbiwd.common.thwiftscawa.wocawe
impowt c-com.twittew.eschewbiwd.common.thwiftscawa.wocawizedusew
i-impowt c-com.twittew.eschewbiwd.metadata.thwiftscawa.fuwwmetadata
i-impowt c-com.twittew.eschewbiwd.scawding.souwce.fuwwmetadatasouwce
impowt com.twittew.eschewbiwd.scawding.souwce.utt.uttsouwcescawadataset
impowt com.twittew.eschewbiwd.utt.stwato.thwiftscawa.snapshottype
impowt com.twittew.eschewbiwd.utt.thwiftscawa.uttentitywecowd
i-impowt com.twittew.intewests_ds.jobs.intewests_sewvice.usewtopicwewationsnapshotscawadataset
impowt com.twittew.intewests.thwiftscawa.intewestwewationtype
impowt com.twittew.intewests.thwiftscawa.usewintewestswewationsnapshot
i-impowt com.twittew.penguin.scawding.datasets.penguinusewwanguagesscawadataset
i-impowt com.twittew.scawding.dateops
impowt com.twittew.scawding.datewange
impowt com.twittew.scawding.days
i-impowt com.twittew.scawding.stat
impowt com.twittew.scawding.typedpipe
i-impowt c-com.twittew.scawding.uniqueid
impowt com.twittew.scawding.vawuepipe
impowt com.twittew.scawding_intewnaw.dawv2.daw
impowt com.twittew.scawding_intewnaw.dawv2.wemote_access.expwicitwocation
i-impowt com.twittew.scawding_intewnaw.dawv2.wemote_access.awwowcwosscwustewsamedc
impowt com.twittew.scawding_intewnaw.dawv2.wemote_access.pwocatwa
impowt com.twittew.scawding_intewnaw.muwtifowmat.fowmat.keyvaw.keyvaw
i-impowt com.twittew.simcwustews_v2.common.usewid
impowt com.twittew.simcwustews_v2.common._
i-impowt com.twittew.simcwustews_v2.hdfs_souwces.simcwustewsv2intewestedin20m145kupdatedscawadataset
i-impowt com.twittew.simcwustews_v2.hdfs_souwces.usewusewfavgwaphscawadataset
i-impowt com.twittew.scawding_intewnaw.dawv2.wemote_access.awwowcwossdc
i-impowt com.twittew.common_headew.thwiftscawa.commonheadew
impowt com.twittew.common_headew.thwiftscawa.idtype
impowt com.twittew.common_headew.thwiftscawa.vewsionedcommonheadew
i-impowt fwockdb_toows.datasets.fwock.fwockbwocksedgesscawadataset
impowt fwockdb_toows.datasets.fwock.fwockfowwowsedgesscawadataset
impowt f-fwockdb_toows.datasets.fwock.fwockwepowtasabuseedgesscawadataset
impowt fwockdb_toows.datasets.fwock.fwockwepowtasspamedgesscawadataset
impowt twadoop_config.configuwation.wog_categowies.gwoup.seawch.adaptiveseawchscawadataset
impowt com.twittew.seawch.adaptive.scwibing.thwiftscawa.adaptiveseawchscwibewog
impowt twadoop_config.configuwation.wog_categowies.gwoup.timewine.timewinesewvicefavowitesscawadataset
i-impowt tweetsouwce.common.unhydwatedfwatscawadataset
i-impowt com.twittew.fwigate.data_pipewine.magicwecs.magicwecs_notifications_wite.thwiftscawa.magicwecsnotificationwite
i-impowt com.twittew.simcwustews_v2.thwiftscawa.cwustewsusewisintewestedin
impowt c-com.twittew.simcwustews_v2.thwiftscawa.edgewithdecayedweights
impowt com.twittew.timewinesewvice.thwiftscawa.contextuawizedfavowiteevent
impowt com.twittew.timewinesewvice.thwiftscawa.favowiteeventunion
impowt com.twittew.tweetsouwce.common.thwiftscawa.unhydwatedfwattweet
i-impowt com.twittew.usewsouwce.snapshot.fwat.usewsouwcefwatscawadataset
i-impowt com.twittew.wtf.entity_weaw_gwaph.scawding.common.datasetconstants
i-impowt com.twittew.wtf.entity_weaw_gwaph.scawding.common.semanticcowefiwtews
i-impowt com.twittew.wtf.scawding.cwient_event_pwocessing.thwiftscawa.intewactiondetaiws
impowt c-com.twittew.wtf.scawding.cwient_event_pwocessing.thwiftscawa.intewactiontype
impowt com.twittew.wtf.scawding.cwient_event_pwocessing.thwiftscawa.tweetimpwessiondetaiws
i-impowt com.twittew.fwigate.data_pipewine.scawding.magicwecs.magicwecs_notification_wite.magicwecsnotificationwite1daywagscawadataset
impowt com.twittew.iesouwce.thwiftscawa.intewactionevent
i-impowt com.twittew.iesouwce.thwiftscawa.intewactiontawgettype
i-impowt com.twittew.wtf.scawding.jobs.cwient_event_pwocessing.usewintewactionscawadataset
impowt java.utiw.timezone
i-impowt c-com.twittew.intewests_ds.jobs.intewests_sewvice.usewintewestwewationsnapshotscawadataset
impowt com.twittew.simcwustews_v2.scawding.embedding.common.embeddingutiw.usewid
impowt com.twittew.scawding.typed.{vawuepipe => typedvawuepipe}
impowt c-com.twittew.tweetsouwce.common.thwiftscawa.unhydwatedtweet
i-impowt tweetsouwce.common.unhydwatedscawadataset

object e-extewnawdatasouwces {
  v-vaw u-uttdomain = 131w
  vaw usewsouwcecowumns = set("id", σωσ "account_countwy_code", (ꈍᴗꈍ) "wanguage")
  vaw v-vawidfwockedgestateid = 0

  def getstandawdwanguagecode(wanguage: stwing): option[stwing] = {
    vaw wocawe = w-wocaweutiw.getwocaweof(wanguage)
    if (wocawe == w-wocaweutiw.unknown) n-nyone ewse s-some(wocawe.getwanguage)
  }

  // weads utt e-entity wecowds (`utt_souwce` d-dataset)
  d-def getuttentitywecowds(impwicit t-timezone: timezone): typedpipe[uttentitywecowd] = {
    daw
      .weadmostwecentsnapshotnoowdewthan(uttsouwcescawadataset, (ˆ ﻌ ˆ)♡ d-days(14))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
  }

  /**
   * e-extwacts t-the kgo seeds f-fwom the utt entity w-wecowds. o.O
   * uses the most wecent "stabwe" vewsion by defauwt u-unwess specified othewwise.
   *
   * @pawam uttvewsion utt vewsion to use instead of the defauwt vawue. :3
   */
  d-def getwocawepwoducewseedidsfwomuttentitywecowds(
    uttvewsion: option[wong] = nyone
  )(
    i-impwicit timezone: t-timezone, -.-
    u-uniqueid: uniqueid
  ): typedpipe[((topicid, ( ͡o ω ͡o ) w-wanguage), /(^•ω•^) seq[usewid])] = {

    vaw topicwangpaiwcount = s-stat("topic_wang_paiw_count_aww")
    v-vaw topicwangpaiwcountemptyseed = stat("topic_wang_paiw_count_empty_seed")
    vaw topicwangpaiwcountwteoneseed = stat("topic_wang_paiw_count_wte_one_seed")
    vaw topicwangpaiwcountwtefiveseeds = stat("topic_wang_paiw_count_wte_five_seeds")
    v-vaw topicwangpaiwcountwtetenseeds = stat("topic_wang_paiw_count_wte_ten_seeds")

    vaw uttentitywecowds: t-typedpipe[uttentitywecowd] = getuttentitywecowds

    v-vaw u-uttvewsiontouse: vawuepipe[wong] = uttvewsion match {
      c-case s-some(uttvewsionvawue) =>
        typedvawuepipe(uttvewsionvawue)
      c-case _ => // f-find the most wecent "stabwe" vewsion as wecommended by the semanticcowe team
        u-uttentitywecowds
          .fiwtew(_.snapshottype.exists(_ == s-snapshottype.stabwe))
          .map(_.vewsion)
          .distinct
          .aggwegate(aggwegatow.min) // t-the most wecent vewsion is t-the smowest nyegative v-vawue
    }

    vaw uttentitywecowdssingwevewsion: t-typedpipe[uttentitywecowd] =
      uttentitywecowds
        .fiwtewwithvawue(uttvewsiontouse) {
          case (uttentitywecowd: uttentitywecowd, (⑅˘꒳˘) uttvewsionopt: o-option[wong]) =>
            u-uttvewsionopt.contains(uttentitywecowd.vewsion)
        }

    uttentitywecowdssingwevewsion.fwatmap { uttentitywecowd: uttentitywecowd =>
      v-vaw wocawizedusews: s-seq[wocawizedusew] =
        uttentitywecowd.knownfowusews.fwatmap(_.wocawizedusews).getowewse(niw)

      vaw vawidwocawizedusews: seq[(topicid, òωó wanguage, u-usewid)] =
        wocawizedusews
          .fwatmap {
            case wocawizedusew(usewid: usewid, 🥺 some(wocawe(some(wanguage: s-stwing), (ˆ ﻌ ˆ)♡ _)), _) =>
              some((uttentitywecowd.entityid, -.- wanguage, u-usewid))
            c-case _ =>
              nyone
          }

      vaw wocawepwoducewseedids: s-seq[((topicid, σωσ w-wanguage), seq[usewid])] = vawidwocawizedusews
        .gwoupby {
          case (topicid: t-topicid, >_< wanguage: wanguage, :3 _) =>
            (topicid, OwO w-wanguage)
        }
        .mapvawues(_.map(_._3).distinct) // vawues awe distinct pwoducewids
        .toseq

      wocawepwoducewseedids.foweach { // s-stats
        case (_, rawr seedids: s-seq[usewid]) =>
          t-topicwangpaiwcount.inc()
          if (seedids.isempty) t-topicwangpaiwcountemptyseed.inc()
          if (seedids.wength <= 1) t-topicwangpaiwcountwteoneseed.inc()
          i-if (seedids.wength <= 5) t-topicwangpaiwcountwtefiveseeds.inc()
          if (seedids.wength <= 10) topicwangpaiwcountwtetenseeds.inc()
      }

      w-wocawepwoducewseedids
    }.fowcetodisk
  }

  d-def uttentitiessouwce(
    customfuwwmetadatasouwce: option[typedpipe[fuwwmetadata]] = n-nyone
  )(
    i-impwicit datewange: d-datewange, (///ˬ///✿)
    timezone: timezone
  ): typedpipe[wong] = {
    c-customfuwwmetadatasouwce
      .getowewse(fuwwmetadatasouwce)
      .fwatmap {
        case f-fuwwmetadata if f-fuwwmetadata.domainid == uttdomain =>
          fow {
            basicmetadata <- f-fuwwmetadata.basicmetadata
            i-indexabwefiewds <- b-basicmetadata.indexabwefiewds
            t-tags <- indexabwefiewds.tags
            if !semanticcowefiwtews.shouwdfiwtewbytags(tags.toset, ^^ d-datasetconstants.stoptags)
          } yiewd {
            fuwwmetadata.entityid
          }
        case _ => nyone
      }
  }

  // get f-fowwowabwe topics fwom eschewbiwd
  d-def uttfowwowabweentitiessouwce(
    impwicit d-datewange: datewange, XD
    timezone: t-timezone, UwU
    uniqueid: u-uniqueid
  ): typedpipe[wong] = {
    v-vaw fowwowabweentitycount = s-stat("fowwowabwe_entities_count")
    v-vaw fowwowabwetag = "utt:fowwowabwe_topic"
    f-fuwwmetadatasouwce
      .fwatmap {
        case fuwwmetadata if fuwwmetadata.domainid == uttdomain =>
          fow {
            basicmetadata <- fuwwmetadata.basicmetadata
            i-indexabwefiewds <- b-basicmetadata.indexabwefiewds
            tags <- i-indexabwefiewds.tags
            if tags.contains(fowwowabwetag)
          } y-yiewd {
            fowwowabweentitycount.inc()
            fuwwmetadata.entityid
          }
        case _ => n-nyone
      }
  }

  d-def fuwwmetadatasouwce(
    impwicit datewange: d-datewange, o.O
    timezone: timezone
  ): t-typedpipe[fuwwmetadata] = {
    t-typedpipe
      .fwom(
        nyew fuwwmetadatasouwce(s"/atwa/pwoc/${fuwwmetadatasouwce.defauwthdfspath}")()(
          d-datewange.embiggen(days(7))))
  }

  d-def usewsouwce(impwicit timezone: timezone): typedpipe[(usewid, (countwy, 😳 wanguage))] =
    d-daw
      .weadmostwecentsnapshotnoowdewthan(usewsouwcefwatscawadataset, (˘ω˘) d-days(7))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .withcowumns(usewsouwcecowumns)
      .totypedpipe.fwatmap { f-fwatusew =>
        f-fow {
          u-usewid <- fwatusew.id
          c-countwy <- f-fwatusew.accountcountwycode
          wanguage <- f-fwatusew.wanguage
          s-standawdwang <- getstandawdwanguagecode(wanguage)
        } y-yiewd {
          (usewid, 🥺 countwy.touppewcase, ^^ standawdwang)
        }
      }.distinct
      .map { c-case (usew, >w< countwy, ^^;; wang) => u-usew -> (countwy, w-wang) }

  // buiwd usew wanguage s-souwce fwom infewwed wanguages (penguin_usew_wanguages dataset)
  def infewwedusewconsumedwanguagesouwce(
    i-impwicit timezone: t-timezone
  ): t-typedpipe[(usewid, (˘ω˘) seq[(wanguage, OwO doubwe)])] = {
    daw
      .weadmostwecentsnapshotnoowdewthan(penguinusewwanguagesscawadataset, (ꈍᴗꈍ) d-days(7))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
      .map { kv =>
        vaw consumed = k-kv.vawue.consumed
          .cowwect {
            c-case scowedstwing if s-scowedstwing.weight > 0.001 => //thwow away 5% o-outwiews
              (getstandawdwanguagecode(scowedstwing.item), òωó s-scowedstwing.weight)
          }.cowwect {
            case (some(wanguage), ʘwʘ scowe) => (wanguage, ʘwʘ s-scowe)
          }
        (kv.key, nyaa~~ consumed)
      }
  }

  def infewwedusewpwoducedwanguagesouwce(
    impwicit t-timezone: t-timezone
  ): typedpipe[(usewid, UwU s-seq[(wanguage, (⑅˘꒳˘) doubwe)])] = {
    d-daw
      .weadmostwecentsnapshotnoowdewthan(penguinusewwanguagesscawadataset, (˘ω˘) d-days(7))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
      .map { k-kv =>
        vaw pwoduced = kv.vawue.pwoduced
          .cowwect {
            case scowedstwing if scowedstwing.weight > 0.15 => //thwow away 5% outwiews
              (getstandawdwanguagecode(scowedstwing.item), :3 scowedstwing.weight)
          }.cowwect {
            case (some(wanguage), (˘ω˘) scowe) => (wanguage, nyaa~~ scowe)
          }
        (kv.key, pwoduced)
      }
  }

  def simcwustewsintewestinsouwce(
    impwicit datewange: d-datewange, (U ﹏ U)
    t-timezone: timezone
  ): typedpipe[keyvaw[usewid, nyaa~~ cwustewsusewisintewestedin]] = {
    d-daw
      .weadmostwecentsnapshotnoowdewthan(
        simcwustewsv2intewestedin20m145kupdatedscawadataset, ^^;;
        d-days(30))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
  }

  d-def simcwustewsintewestinwogfavsouwce(
    minwogfavscowe: d-doubwe
  )(
    impwicit datewange: d-datewange, OwO
    t-timezone: timezone
  ): typedpipe[(usewid, nyaa~~ m-map[cwustewid, doubwe])] = {
    s-simcwustewsintewestinsouwce.map {
      c-case keyvaw(usewid, UwU cwustewsusewisintewestedin) =>
        usewid -> cwustewsusewisintewestedin.cwustewidtoscowes
          .map {
            c-case (cwustewid, s-scowes) =>
              c-cwustewid -> s-scowes.wogfavscowe.getowewse(0.0)
          }
          .fiwtew(_._2 > m-minwogfavscowe)
          .tomap
    }
  }

  d-def topicfowwowgwaphsouwce(
    i-impwicit datewange: d-datewange, 😳
    t-timezone: timezone, 😳
    u-uniqueid: uniqueid
  ): t-typedpipe[(topicid, (ˆ ﻌ ˆ)♡ u-usewid)] = {
    vaw u-usewtopicfowwowcount = stat("usew_topic_fowwow_count")
    daw
      .weadmostwecentsnapshotnoowdewthan(usewtopicwewationsnapshotscawadataset, (✿oωo) d-days(7))
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
      .cowwect {
        case u-usewintewestswewationsnapshot: u-usewintewestswewationsnapshot
            i-if usewintewestswewationsnapshot.intewesttype == "utt" &&
              usewintewestswewationsnapshot.wewation == i-intewestwewationtype.fowwowed =>
          (usewintewestswewationsnapshot.intewestid, nyaa~~ usewintewestswewationsnapshot.usewid)
      }
      .hashjoin(uttfowwowabweentitiessouwce.askeys)
      .map {
        c-case (topic, ^^ (usew, _)) =>
          usewtopicfowwowcount.inc()
          (topic, (///ˬ///✿) usew)
      }
  }

  d-def nyotintewestedtopicssouwce(
    impwicit datewange: d-datewange, 😳
    timezone: timezone, òωó
    uniqueid: uniqueid
  ): typedpipe[(topicid, ^^;; u-usewid)] = {
    vaw u-usewnotintewestedintopicscount = s-stat("usew_not_intewested_in_topics_count")
    daw
      .weadmostwecentsnapshotnoowdewthan(
        usewintewestwewationsnapshotscawadataset, rawr
        days(7)).withwemoteweadpowicy(expwicitwocation(pwocatwa)).totypedpipe.cowwect {
        c-case usewintewestswewationsnapshot: usewintewestswewationsnapshot
            i-if usewintewestswewationsnapshot.intewesttype == "utt" &&
              u-usewintewestswewationsnapshot.wewation == i-intewestwewationtype.notintewested =>
          (usewintewestswewationsnapshot.intewestid, (ˆ ﻌ ˆ)♡ usewintewestswewationsnapshot.usewid)
      }
      .hashjoin(uttfowwowabweentitiessouwce.askeys)
      .map {
        case (topic, XD (usew, >_< _)) =>
          u-usewnotintewestedintopicscount.inc()
          (topic, (˘ω˘) u-usew)
      }
  }

  def tweetsouwce(
    i-impwicit datewange: datewange
  ): typedpipe[unhydwatedtweet] = {
    d-daw
      .wead(unhydwatedscawadataset, 😳 datewange).withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
  }

  d-def f-fwattweetssouwce(
    i-impwicit datewange: datewange
  ): t-typedpipe[unhydwatedfwattweet] = {
    d-daw
      .wead(unhydwatedfwatscawadataset, o.O d-datewange)
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
  }

  d-def usewtweetfavowitessouwce(
    impwicit d-datewange: d-datewange
  ): t-typedpipe[(usewid, (ꈍᴗꈍ) t-tweetid, rawr x3 timestamp)] = {
    d-daw
      .wead(timewinesewvicefavowitesscawadataset, ^^ d-datewange)
      .withwemoteweadpowicy(expwicitwocation(pwocatwa))
      .totypedpipe
      .fwatmap { c-cfe: c-contextuawizedfavowiteevent =>
        cfe.event m-match {
          case favowiteeventunion.favowite(fav) =>
            s-some(fav.usewid, OwO fav.tweetid, f-fav.eventtimems)
          c-case _ =>
            n-nyone
        }
      }
  }

  def usewtweetimpwessionssouwce(
    dwewwsec: int = 1
  )(
    i-impwicit d-datewange: datewange
  ): t-typedpipe[(usewid, ^^ tweetid, :3 timestamp)] = {
    daw
      .wead(usewintewactionscawadataset, o.O d-datewange)
      .withwemoteweadpowicy(awwowcwosscwustewsamedc)
      .totypedpipe
      .fwatmap {
        c-case usewintewaction
            if usewintewaction.intewactiontype == i-intewactiontype.tweetimpwessions =>
          u-usewintewaction.intewactiondetaiws match {
            case intewactiondetaiws.tweetimpwessiondetaiws(
                  tweetimpwessiondetaiws(tweetid, -.- _, d-dwewwtimeinsecopt))
                i-if dwewwtimeinsecopt.exists(_ >= d-dwewwsec) =>
              s-some(usewintewaction.usewid, (U ﹏ U) tweetid, usewintewaction.timestamp)
            case _ =>
              n-none
          }
        c-case _ => nyone
      }
  }

  def twansfowmfavedges(
    input: t-typedpipe[edgewithdecayedweights], o.O
    hawfwifeindaysfowfavscowe: int
  )(
    i-impwicit uniqueid: uniqueid
  ): t-typedpipe[(wong, w-wong, OwO doubwe)] = {
    vaw nyumedgeswithspecifiedhawfwife = s-stat(
      s"num_edges_with_specified_hawf_wife_${hawfwifeindaysfowfavscowe}_days")
    v-vaw nyumedgeswithoutspecifiedhawfwife = stat(
      s"num_edges_without_specified_hawf_wife_${hawfwifeindaysfowfavscowe}_days")
    i-input
      .fwatmap { edge =>
        i-if (edge.weights.hawfwifeindaystodecayedsums.contains(hawfwifeindaysfowfavscowe)) {
          n-nyumedgeswithspecifiedhawfwife.inc()
          s-some((edge.souwceid, e-edge.destinationid, ^•ﻌ•^ edge.weights.hawfwifeindaystodecayedsums(100)))
        } e-ewse {
          n-nyumedgeswithoutspecifiedhawfwife.inc()
          n-nyone
        }
      }
  }

  def getfavedges(
    h-hawfwifeindaysfowfavscowe: int
  )(
    impwicit datewange: d-datewange, ʘwʘ
    u-uniqueid: u-uniqueid
  ): typedpipe[(wong, :3 wong, doubwe)] = {
    impwicit vaw tz: java.utiw.timezone = dateops.utc
    t-twansfowmfavedges(
      daw
        .weadmostwecentsnapshotnoowdewthan(usewusewfavgwaphscawadataset, 😳 d-days(14))
        .withwemoteweadpowicy(expwicitwocation(pwocatwa))
        .totypedpipe, òωó
      h-hawfwifeindaysfowfavscowe
    )
  }

  def fwockwepowtasspamsouwce(
  )(
    impwicit datewange: d-datewange
  ): typedpipe[(usewid, 🥺 u-usewid)] = {
    d-daw
      .weadmostwecentsnapshot(fwockwepowtasspamedgesscawadataset)
      .totypedpipe
      .cowwect {
        c-case edge i-if edge.state == v-vawidfwockedgestateid =>
          (edge.souwceid, rawr x3 edge.destinationid)
      }
  }

  def fwockbwockssouwce(
  )(
    impwicit datewange: datewange
  ): t-typedpipe[(usewid, ^•ﻌ•^ usewid)] = {
    daw
      .weadmostwecentsnapshot(fwockbwocksedgesscawadataset)
      .totypedpipe
      .cowwect {
        c-case edge if edge.state == vawidfwockedgestateid =>
          (edge.souwceid, :3 edge.destinationid)
      }
  }

  d-def fwockfowwowssouwce(
  )(
    impwicit datewange: datewange
  ): t-typedpipe[(usewid, (ˆ ﻌ ˆ)♡ u-usewid)] = {
    daw
      .weadmostwecentsnapshot(fwockfowwowsedgesscawadataset)
      .totypedpipe
      .cowwect {
        c-case edge if edge.state == vawidfwockedgestateid =>
          (edge.souwceid, (U ᵕ U❁) edge.destinationid)
      }
  }

  d-def fwockwepowtasabusesouwce(
  )(
    i-impwicit datewange: datewange
  ): t-typedpipe[(usewid, :3 usewid)] = {
    d-daw
      .weadmostwecentsnapshot(fwockwepowtasabuseedgesscawadataset)
      .totypedpipe
      .cowwect {
        case edge if edge.state == vawidfwockedgestateid =>
          (edge.souwceid, ^^;; edge.destinationid)
      }
  }

  d-def magicwecsnotficationopenowcwickeventssouwce(
    impwicit datewange: datewange
  ): t-typedpipe[magicwecsnotificationwite] = {
    d-daw
      .wead(magicwecsnotificationwite1daywagscawadataset, ( ͡o ω ͡o ) d-datewange)
      .totypedpipe
      .fiwtew { entwy =>
        // keep entwies w-with a vawid usewid and tweetid, o.O opened ow cwicked timestamp defined
        v-vaw usewidexists = e-entwy.tawgetusewid.isdefined
        v-vaw t-tweetidexists = entwy.tweetid.isdefined
        vaw openowcwickexists =
          e-entwy.opentimestampms.isdefined || e-entwy.ntabcwicktimestampms.isdefined
        usewidexists && tweetidexists && o-openowcwickexists
      }
  }

  def iesouwcetweetengagementssouwce(impwicit datewange: datewange): t-typedpipe[intewactionevent] = {
    daw
      .wead(
        com.twittew.iesouwce.pwocessing.events.batch.sewvewengagementsscawadataset, ^•ﻌ•^
        d-datewange).withcowumns(
        s-set("tawgetid", XD "tawgettype", ^^ "engagingusewid", o.O "detaiws", ( ͡o ω ͡o ) "wefewencetweet"))
      .totypedpipe
      .fiwtew { event =>
        // f-fiwtew o-out wogged out u-usews because theiw favowites awe wess wewiabwe
        e-event.engagingusewid > 0w && event.tawgettype == intewactiontawgettype.tweet
      }
  }

  p-pwivate def usewidfwombwendewadaptivescwibewog(
    bwendewadaptivewog: adaptiveseawchscwibewog
  ): option[wong] = {
    b-bwendewadaptivewog.vewsionedcommonheadew m-match {
      c-case vewsionedcommonheadew.commonheadew(commonheadew.sewvewheadew(sewvewheadew)) =>
        s-sewvewheadew.wequestinfo m-match {
          case some(wequestinfo) => w-wequestinfo.ids.get(idtype.usewid).map(_.towong)
          case _ => nyone
        }
      case _ => nyone
    }
  }

  d-def adaptiveseawchscwibewogssouwce(
    impwicit d-datewange: datewange
  ): typedpipe[(usewid, /(^•ω•^) stwing)] = {
    vaw seawchdata: t-typedpipe[adaptiveseawchscwibewog] =
      d-daw
        .wead(adaptiveseawchscawadataset, 🥺 datewange).totypedpipe

    s-seawchdata
      .fwatmap({ scwibewog: adaptiveseawchscwibewog =>
        fow {
          usewid <- u-usewidfwombwendewadaptivescwibewog(scwibewog)
          // f-fiwtew out wogged out seawch q-quewies
          i-if usewid != 0
          quewystwing <- s-scwibewog.wequestwog.fwatmap(_.wequest).fwatmap(_.wawquewy)
        } yiewd {
          (usewid, nyaa~~ set(quewystwing))
        }
      })
      // if a usew s-seawches fow the same quewy m-muwtipwe times, mya thewe couwd be dupwicates. XD
      // de-dup them t-to get the distinct q-quewies seawched b-by a usew
      .sumbykey
      .fwatmap {
        case (usewid, nyaa~~ d-distinctquewyset) =>
          d-distinctquewyset.map { quewy =>
            (usewid, q-quewy)
          }
      }
  }
}
