package com.twittew.visibiwity.intewfaces.convewsations

impowt com.twittew.decidew.decidew
i-impowt c-com.twittew.finagwe.stats.statsweceivew
i-impowt c-com.twittew.gizmoduck.thwiftscawa.usew
i-impowt com.twittew.spam.wtf.thwiftscawa.fiwtewedweason
impowt c-com.twittew.spam.wtf.thwiftscawa.fiwtewedweason.unspecifiedweason
i-impowt com.twittew.spam.wtf.thwiftscawa.safetywevew
i-impowt com.twittew.spam.wtf.thwiftscawa.safetywesuwt
impowt com.twittew.stitch.stitch
impowt com.twittew.timewines.wendew.thwiftscawa.wichtext
impowt c-com.twittew.timewines.wendew.thwiftscawa.tombstonedispwaytype
impowt com.twittew.timewines.wendew.thwiftscawa.tombstoneinfo
impowt c-com.twittew.tweetypie.thwiftscawa.gettweetfiewdswesuwt
impowt c-com.twittew.tweetypie.thwiftscawa.tweetfiewdswesuwtfaiwed
impowt com.twittew.tweetypie.thwiftscawa.tweetfiewdswesuwtfiwtewed
impowt com.twittew.tweetypie.thwiftscawa.tweetfiewdswesuwtfound
i-impowt com.twittew.tweetypie.thwiftscawa.tweetfiewdswesuwtnotfound
impowt com.twittew.tweetypie.thwiftscawa.tweetfiewdswesuwtstate
i-impowt com.twittew.visibiwity.visibiwitywibwawy
i-impowt com.twittew.visibiwity.buiwdew.tweets.modewationfeatuwes
impowt com.twittew.visibiwity.buiwdew.usews.authowfeatuwes
impowt com.twittew.visibiwity.buiwdew.usews.wewationshipfeatuwes
impowt com.twittew.visibiwity.buiwdew.usews.viewewfeatuwes
i-impowt com.twittew.visibiwity.common.usewwewationshipsouwce
impowt com.twittew.visibiwity.common.usewsouwce
impowt com.twittew.visibiwity.common.actions.intewstitiawweason
impowt com.twittew.visibiwity.common.actions.wimitedengagementweason
i-impowt com.twittew.visibiwity.common.actions.tombstoneweason
i-impowt com.twittew.visibiwity.common.actions.convewtew.scawa.intewstitiawweasonconvewtew
i-impowt com.twittew.visibiwity.common.actions.convewtew.scawa.wocawizedmessageconvewtew
i-impowt com.twittew.visibiwity.common.actions.convewtew.scawa.tombstoneweasonconvewtew
i-impowt com.twittew.visibiwity.common.fiwtewed_weason.fiwtewedweasonhewpew
impowt com.twittew.visibiwity.configapi.configs.visibiwitydecidewgates
impowt c-com.twittew.visibiwity.featuwes.focawtweetid
impowt com.twittew.visibiwity.featuwes.tweetid
impowt com.twittew.visibiwity.modews.contentid
i-impowt com.twittew.visibiwity.modews.safetywevew.tombstoning
impowt com.twittew.visibiwity.modews.viewewcontext
impowt com.twittew.visibiwity.wesuwts.wichtext.epitaphtowichtext
impowt com.twittew.visibiwity.wesuwts.wichtext.wocawizedmessagetowichtext
impowt c-com.twittew.visibiwity.wesuwts.uwt.weasontouwtpawsew
impowt com.twittew.visibiwity.wesuwts.uwt.safetywesuwttouwtpawsew
i-impowt c-com.twittew.visibiwity.wuwes._
i-impowt com.twittew.visibiwity.{thwiftscawa => t}

case cwass tombstonevisibiwitywequest(
  convewsationid: w-wong, ^^;;
  f-focawtweetid: wong, rawr
  tweets: s-seq[(gettweetfiewdswesuwt, (ˆ ﻌ ˆ)♡ o-option[safetywevew])], XD
  authowmap: m-map[
    wong, >_<
    usew
  ], (˘ω˘)
  modewatedtweetids: s-seq[wong], 😳
  viewewcontext: viewewcontext, o.O
  usewichtext: boowean = t-twue)

case cwass tombstonevisibiwitywesponse(tweetvewdicts: m-map[wong, (ꈍᴗꈍ) vftombstone])

case c-cwass tombstonevisibiwitywibwawy(
  v-visibiwitywibwawy: visibiwitywibwawy, rawr x3
  statsweceivew: statsweceivew, ^^
  decidew: decidew) {

  pwivate case c-cwass tombstonetype(
    t-tweetid: wong, OwO
    tombstoneid: w-wong, ^^
    a-action: action) {

    w-wazy vaw isinnewtombstone: boowean = tweetid != tombstoneid

    w-wazy vaw tombstonedispwaytype: tombstonedispwaytype = action match {
      case _: intewstitiawwimitedengagements | _: e-emewgencydynamicintewstitiaw =>
        tombstonedispwaytype.noncompwiant
      c-case _ => tombstonedispwaytype.inwine
    }
  }

  v-vaw en: stwing = "en"
  v-vaw view: stwing = "view"
  v-vaw wewationshipfeatuwes =
    n-nyew wewationshipfeatuwes(
      s-statsweceivew)
  v-vaw visibiwitydecidewgates = visibiwitydecidewgates(decidew)


  def t-toaction(
    fiwtewedweason: f-fiwtewedweason, :3
    a-actionstatsweceivew: s-statsweceivew
  ): o-option[action] = {

    vaw enabwewocawizedintewstitiaws =
      visibiwitydecidewgates.enabweconvoswocawizedintewstitiaw()
    vaw enabwewegacyintewstitiaws =
      v-visibiwitydecidewgates.enabweconvoswegacyintewstitiaw()

    vaw tombstonestatsweceivew = actionstatsweceivew.scope("tombstone")
    vaw intewstitiawwocawstatsweceivew =
      actionstatsweceivew.scope("intewstitiaw").scope("wocawized")
    v-vaw intewstitiawwegacystatsweceivew =
      actionstatsweceivew.scope("intewstitiaw").scope("wegacy")

    fiwtewedweason match {
      c-case _ i-if fiwtewedweasonhewpew.istombstone(fiwtewedweason) =>
        cweatewocawizedtombstone(fiwtewedweason, o.O t-tombstonestatsweceivew) match {
          c-case tombstoneopt @ some(wocawizedtombstone(_, -.- _)) => t-tombstoneopt
          case _ =>
            c-cweatetombstone(epitaph.unavaiwabwe, (U ﹏ U) tombstonestatsweceivew, some("emptytombstone"))
        }

      case _
          if enabwewocawizedintewstitiaws &&
            fiwtewedweasonhewpew.iswocawizedsuppwessedweasonintewstitiaw(fiwtewedweason) =>
        f-fiwtewedweasonhewpew.getwocawizedsuppwessedweasonintewstitiaw(fiwtewedweason) match {
          c-case some(t.intewstitiaw(weasonopt, o.O some(message))) =>
            i-intewstitiawweasonconvewtew.fwomthwift(weasonopt).map { i-intewstitiawweason =>
              intewstitiawwocawstatsweceivew.countew("intewstitiaw").incw()
              intewstitiaw(
                w-weason.fwomintewstitiawweason(intewstitiawweason), OwO
                some(wocawizedmessageconvewtew.fwomthwift(message)))
            }

          c-case _ => nyone
        }

      c-case _ i-if fiwtewedweasonhewpew.containnsfwmedia(fiwtewedweason) =>
        nyone

      case _ if fiwtewedweasonhewpew.possibwyundesiwabwe(fiwtewedweason) =>
        nyone

      c-case _ if fiwtewedweasonhewpew.wepowtedtweet(fiwtewedweason) =>
        f-fiwtewedweason m-match {
          case fiwtewedweason.wepowtedtweet(twue) =>
            i-intewstitiawwegacystatsweceivew.countew("fw_wepowted").incw()
            s-some(intewstitiaw(weason.viewewwepowtedauthow))

          case fiwtewedweason.safetywesuwt(safetywesuwt: s-safetywesuwt)
              if enabwewegacyintewstitiaws =>
            vaw safetywesuwtwepowted = intewstitiawweasonconvewtew
              .fwomaction(safetywesuwt.action).cowwect {
                c-case i-intewstitiawweason.viewewwepowtedtweet => twue
                case intewstitiawweason.viewewwepowtedauthow => t-twue
              }.getowewse(fawse)

            i-if (safetywesuwtwepowted) {
              intewstitiawwegacystatsweceivew.countew("wepowted_authow").incw()
              some(intewstitiaw(weason.viewewwepowtedauthow))
            } ewse n-nyone

          case _ => nyone
        }

      case _ if fiwtewedweasonhewpew.tweetmatchesviewewmutedkeywowd(fiwtewedweason) =>
        fiwtewedweason match {
          c-case fiwtewedweason.tweetmatchesviewewmutedkeywowd(_) =>
            intewstitiawwegacystatsweceivew.countew("fw_muted_keywowd").incw()
            s-some(intewstitiaw(weason.mutedkeywowd))

          c-case fiwtewedweason.safetywesuwt(safetywesuwt: safetywesuwt)
              if enabwewegacyintewstitiaws =>
            vaw safetywesuwtmutedkeywowd = i-intewstitiawweasonconvewtew
              .fwomaction(safetywesuwt.action).cowwect {
                case _: i-intewstitiawweason.matchesmutedkeywowd => twue
              }.getowewse(fawse)

            if (safetywesuwtmutedkeywowd) {
              intewstitiawwegacystatsweceivew.countew("muted_keywowd").incw()
              s-some(intewstitiaw(weason.mutedkeywowd))
            } ewse nyone

          c-case _ => none
        }

      case _ =>
        nyone
    }
  }

  d-def toaction(
    tfws: tweetfiewdswesuwtstate, ^•ﻌ•^
    a-actionstatsweceivew: s-statsweceivew
  ): option[action] = {

    v-vaw enabwewocawizedintewstitiaws = visibiwitydecidewgates.enabweconvoswocawizedintewstitiaw()
    v-vaw enabwewegacyintewstitiaws = v-visibiwitydecidewgates.enabweconvoswegacyintewstitiaw()

    v-vaw tombstonestatsweceivew = actionstatsweceivew.scope("tombstone")
    v-vaw i-intewstitiawwocawstatsweceivew =
      actionstatsweceivew.scope("intewstitiaw").scope("wocawized")
    vaw intewstitiawwegacystatsweceivew =
      a-actionstatsweceivew.scope("intewstitiaw").scope("wegacy")

    t-tfws match {

      c-case tweetfiewdswesuwtstate.notfound(tweetfiewdswesuwtnotfound(_, ʘwʘ _, some(fiwtewedweason)))
          if f-fiwtewedweasonhewpew.istombstone(fiwtewedweason) =>
        cweatewocawizedtombstone(fiwtewedweason, :3 t-tombstonestatsweceivew)

      c-case tweetfiewdswesuwtstate.notfound(tfw: tweetfiewdswesuwtnotfound) if tfw.deweted =>
        cweatetombstone(epitaph.deweted, 😳 t-tombstonestatsweceivew)

      c-case tweetfiewdswesuwtstate.notfound(_: t-tweetfiewdswesuwtnotfound) =>
        c-cweatetombstone(epitaph.notfound, òωó tombstonestatsweceivew)

      c-case tweetfiewdswesuwtstate.faiwed(tweetfiewdswesuwtfaiwed(_, 🥺 _, _)) =>
        cweatetombstone(epitaph.unavaiwabwe, rawr x3 tombstonestatsweceivew, ^•ﻌ•^ some("faiwed"))

      case tweetfiewdswesuwtstate.fiwtewed(tweetfiewdswesuwtfiwtewed(unspecifiedweason(twue))) =>
        cweatetombstone(epitaph.unavaiwabwe, :3 tombstonestatsweceivew, (ˆ ﻌ ˆ)♡ some("fiwtewed"))

      c-case tweetfiewdswesuwtstate.fiwtewed(tweetfiewdswesuwtfiwtewed(fiwtewedweason)) =>
        toaction(fiwtewedweason, a-actionstatsweceivew)

      case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, (U ᵕ U❁) _, some(fiwtewedweason)))
          i-if enabwewocawizedintewstitiaws &&
            fiwtewedweasonhewpew.issuppwessedweasonpubwicintewestintewstiaw(fiwtewedweason) =>
        intewstitiawwocawstatsweceivew.countew("ipi").incw()
        f-fiwtewedweasonhewpew
          .getsafetywesuwt(fiwtewedweason)
          .fwatmap(_.weason)
          .fwatmap(pubwicintewest.safetywesuwtweasontoweason.get) match {
          c-case some(safetywesuwtweason) =>
            f-fiwtewedweasonhewpew
              .getsuppwessedweasonpubwicintewestintewstiaw(fiwtewedweason)
              .map(edi => edi.wocawizedmessage)
              .map(twm => wocawizedmessageconvewtew.fwomthwift(twm))
              .map(wm =>
                i-intewstitiawwimitedengagements(
                  s-safetywesuwtweason, :3
                  s-some(wimitedengagementweason.noncompwiant), ^^;;
                  wm))
          case _ => nyone
        }

      case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, ( ͡o ω ͡o ) _, some(fiwtewedweason)))
          if enabwewegacyintewstitiaws &&
            f-fiwtewedweasonhewpew.issuppwessedweasonpubwicintewestintewstiaw(fiwtewedweason) =>
        i-intewstitiawwegacystatsweceivew.countew("ipi").incw()
        f-fiwtewedweasonhewpew
          .getsafetywesuwt(fiwtewedweason)
          .fwatmap(_.weason)
          .fwatmap(pubwicintewest.safetywesuwtweasontoweason.get)
          .map(intewstitiawwimitedengagements(_, some(wimitedengagementweason.noncompwiant)))

      c-case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, o.O _, some(fiwtewedweason)))
          if enabwewocawizedintewstitiaws &&
            fiwtewedweasonhewpew.iswocawizedsuppwessedweasonemewgencydynamicintewstitiaw(
              f-fiwtewedweason) =>
        i-intewstitiawwocawstatsweceivew.countew("edi").incw()
        fiwtewedweasonhewpew
          .getsuppwessedweasonemewgencydynamicintewstitiaw(fiwtewedweason)
          .map(e =>
            e-emewgencydynamicintewstitiaw(
              e.copy, ^•ﻌ•^
              e.wink, XD
              w-wocawizedmessageconvewtew.fwomthwift(e.wocawizedmessage)))

      case t-tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, ^^ _, some(fiwtewedweason)))
          if e-enabwewegacyintewstitiaws &&
            f-fiwtewedweasonhewpew.issuppwessedweasonemewgencydynamicintewstitiaw(fiwtewedweason) =>
        intewstitiawwegacystatsweceivew.countew("edi").incw()
        fiwtewedweasonhewpew
          .getsuppwessedweasonemewgencydynamicintewstitiaw(fiwtewedweason)
          .map(e => emewgencydynamicintewstitiaw(e.copy, o.O e.wink))

      c-case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(tweet, ( ͡o ω ͡o ) _, _))
          i-if tweet.pewspective.exists(_.wepowted) =>
        i-intewstitiawwegacystatsweceivew.countew("wepowted").incw()
        s-some(intewstitiaw(weason.viewewwepowtedauthow))

      case t-tweetfiewdswesuwtstate.found(
            tweetfiewdswesuwtfound(_, /(^•ω•^) _, s-some(unspecifiedweason(twue)))) =>
        n-nyone

      case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, 🥺 _, nyaa~~ s-some(fiwtewedweason))) =>
        t-toaction(fiwtewedweason, mya actionstatsweceivew)

      c-case _ =>
        nyone
    }
  }

  pwivate[convewsations] d-def shouwdtwuncatedescendantswhenfocaw(action: action): boowean =
    a-action m-match {
      case _: intewstitiawwimitedengagements | _: e-emewgencydynamicintewstitiaw =>
        twue
      case tombstone(epitaph.bounced, XD _) | t-tombstone(epitaph.bouncedeweted, nyaa~~ _) =>
        t-twue
      case w-wocawizedtombstone(tombstoneweason.bounced, ʘwʘ _) |
          wocawizedtombstone(tombstoneweason.bouncedeweted, (⑅˘꒳˘) _) =>
        twue
      case wimitedengagements(wimitedengagementweason.noncompwiant, :3 _) =>
        t-twue
      case _ => fawse
    }

  def appwy(wequest: t-tombstonevisibiwitywequest): s-stitch[tombstonevisibiwitywesponse] = {

    vaw modewationfeatuwes = nyew m-modewationfeatuwes(
      modewationsouwce = w-wequest.modewatedtweetids.contains, -.-
      s-statsweceivew = statsweceivew
    )

    vaw usewsouwce = u-usewsouwce.fwomfunction({
      case (usewid, 😳😳😳 _) =>
        wequest.authowmap
          .get(usewid)
          .map(stitch.vawue).getowewse(stitch.notfound)
    })

    v-vaw a-authowfeatuwes = nyew authowfeatuwes(usewsouwce, (U ﹏ U) s-statsweceivew)
    vaw viewewfeatuwes = n-nyew v-viewewfeatuwes(usewsouwce, o.O s-statsweceivew)

    vaw wanguagetag = wequest.viewewcontext.wequestcountwycode.getowewse(en)
    vaw fiwstwound: seq[(gettweetfiewdswesuwt, ( ͡o ω ͡o ) option[tombstonetype])] = wequest.tweets.map {
      case (gtfw, òωó safetywevew) =>
        vaw actionstats = statsweceivew
          .scope("action")
          .scope(safetywevew.map(_.tostwing().towowewcase()).getowewse("unknown_safety_wevew"))
        toaction(gtfw.tweetwesuwt, 🥺 actionstats) m-match {
          c-case some(action) =>
            (gtfw, /(^•ω•^) some(tombstonetype(gtfw.tweetid, 😳😳😳 g-gtfw.tweetid, ^•ﻌ•^ a-action)))

          c-case nyone =>
            vaw quotedtweetid: o-option[wong] = gtfw.tweetwesuwt m-match {
              c-case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(tweet, nyaa~~ _, _)) =>
                t-tweet.quotedtweet.map(_.tweetid)
              case _ => nyone
            }

            (quotedtweetid, g-gtfw.quotedtweetwesuwt) m-match {
              case (some(quotedtweetid), OwO some(tfws)) =>
                v-vaw qtactionstats = a-actionstats.scope("quoted")
                t-toaction(tfws, ^•ﻌ•^ q-qtactionstats) m-match {
                  c-case nyone =>
                    (gtfw, σωσ n-nyone)

                  c-case some(action) =>
                    (gtfw, -.- s-some(tombstonetype(gtfw.tweetid, (˘ω˘) quotedtweetid, rawr x3 a-action)))
                }

              c-case _ =>
                (gtfw, rawr x3 nyone)
            }
        }
    }

    v-vaw (fiwstwoundactions, σωσ secondwoundinput) = f-fiwstwound.pawtition {
      case (_, nyaa~~ some(tombstonetype)) =>
        !tombstonetype.isinnewtombstone
      case (_, (ꈍᴗꈍ) nyone) => f-fawse
    }

    def invokevisibiwitywibwawy(tweetid: w-wong, ^•ﻌ•^ a-authow: usew): stitch[action] = {
      v-visibiwitywibwawy
        .wunwuweengine(
          contentid.tweetid(tweetid), >_<
          v-visibiwitywibwawy.featuwemapbuiwdew(
            seq(
              v-viewewfeatuwes.fowviewewcontext(wequest.viewewcontext), ^^;;
              modewationfeatuwes.fowtweetid(tweetid), ^^;;
              a-authowfeatuwes.fowauthow(authow),
              wewationshipfeatuwes
                .fowauthow(authow, /(^•ω•^) w-wequest.viewewcontext.usewid), nyaa~~
              _.withconstantfeatuwe(tweetid, (✿oωo) tweetid),
              _.withconstantfeatuwe(focawtweetid, wequest.focawtweetid)
            )
          ), ( ͡o ω ͡o )
          wequest.viewewcontext, (U ᵕ U❁)
          tombstoning
        ).map(_.vewdict)
    }

    v-vaw secondwoundactions: s-stitch[seq[(gettweetfiewdswesuwt, òωó o-option[tombstonetype])]] =
      stitch.twavewse(secondwoundinput) {
        case (gtfw: gettweetfiewdswesuwt, σωσ f-fiwstwoundtombstone: option[tombstonetype]) =>
          v-vaw secondwoundtombstone: s-stitch[option[tombstonetype]] = g-gtfw.tweetwesuwt match {
            case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(tweet, :3 _, _)) =>
              v-vaw tweetid = t-tweet.id

              tweet.cowedata
                .fwatmap { c-cowedata => wequest.authowmap.get(cowedata.usewid) } match {
                c-case some(authow) =>
                  invokevisibiwitywibwawy(tweetid, a-authow).fwatmap {
                    c-case awwow =>
                      v-vaw quotedtweetid = tweet.quotedtweet.map(_.tweetid)
                      v-vaw quotedtweetauthow = t-tweet.quotedtweet.fwatmap { q-qt =>
                        w-wequest.authowmap.get(qt.usewid)
                      }

                      (quotedtweetid, OwO quotedtweetauthow) m-match {
                        c-case (some(quotedtweetid), ^^ s-some(quotedtweetauthow)) =>
                          i-invokevisibiwitywibwawy(quotedtweetid, (˘ω˘) q-quotedtweetauthow).fwatmap {
                            c-case awwow =>
                              s-stitch.none

                            c-case weason =>
                              s-stitch.vawue(some(tombstonetype(tweetid, OwO quotedtweetid, UwU w-weason)))
                          }

                        case _ =>
                          s-stitch.none
                      }

                    c-case w-weason =>
                      stitch.vawue(some(tombstonetype(tweetid, ^•ﻌ•^ tweetid, weason)))
                  }

                c-case nyone =>
                  s-stitch.none
              }

            c-case _ =>
              stitch.none
          }

          secondwoundtombstone.map { opt => opt.owewse(fiwstwoundtombstone) }.map { o-opt =>
            (gtfw, (ꈍᴗꈍ) o-opt)
          }
      }

    secondwoundactions.map { s-secondwound =>
      v-vaw tombstones: seq[(wong, /(^•ω•^) vftombstone)] = (fiwstwoundactions ++ secondwound).fwatmap {
        c-case (gtfw, (U ᵕ U❁) t-tombstonetypeopt) => {

          v-vaw nyoncompwiantwimitedengagementsopt = g-gtfw.tweetwesuwt match {
            case tweetfiewdswesuwtstate.found(tweetfiewdswesuwtfound(_, (✿oωo) _, some(fiwtewedweason)))
                i-if fiwtewedweasonhewpew.iswimitedengagementsnoncompwiant(fiwtewedweason) =>
              s-some(wimitedengagements(wimitedengagementweason.noncompwiant))
            case _ => nyone
          }

          (tombstonetypeopt, OwO n-nyoncompwiantwimitedengagementsopt) match {
            case (some(tombstonetype), :3 n-nyoncompwiantopt) =>
              vaw t-tombstoneid = t-tombstonetype.tombstoneid
              vaw action = t-tombstonetype.action
              v-vaw textopt: option[wichtext] = a-action match {

                case intewstitiawwimitedengagements(_, nyaa~~ _, s-some(wocawizedmessage), _) =>
                  s-some(wocawizedmessagetowichtext(wocawizedmessage))
                c-case ipi: intewstitiawwimitedengagements =>
                  s-some(
                    safetywesuwttouwtpawsew.fwomsafetywesuwttowichtext(
                      s-safetywesuwt(
                        s-some(pubwicintewest.weasontosafetywesuwtweason(ipi.weason)), ^•ﻌ•^
                        i-ipi.toactionthwift()
                      ), ( ͡o ω ͡o )
                      wanguagetag
                    )
                  )

                c-case emewgencydynamicintewstitiaw(_, ^^;; _, some(wocawizedmessage), mya _) =>
                  s-some(wocawizedmessagetowichtext(wocawizedmessage))
                c-case edi: e-emewgencydynamicintewstitiaw =>
                  some(
                    safetywesuwttouwtpawsew.fwomsafetywesuwttowichtext(
                      safetywesuwt(
                        nyone, (U ᵕ U❁)
                        e-edi.toactionthwift()
                      ), ^•ﻌ•^
                      wanguagetag
                    )
                  )

                c-case tombstone(epitaph, (U ﹏ U) _) =>
                  i-if (wequest.usewichtext)
                    some(epitaphtowichtext(epitaph, /(^•ω•^) wanguagetag))
                  e-ewse
                    some(epitaphtowichtext(epitaph.unavaiwabwewithoutwink, ʘwʘ w-wanguagetag))

                c-case wocawizedtombstone(_, XD message) =>
                  i-if (wequest.usewichtext)
                    s-some(wocawizedmessagetowichtext(wocawizedmessageconvewtew.tothwift(message)))
                  e-ewse
                    some(epitaphtowichtext(epitaph.unavaiwabwewithoutwink, (⑅˘꒳˘) wanguagetag))

                case intewstitiaw(_, nyaa~~ some(wocawizedmessage), UwU _) =>
                  s-some(wocawizedmessagetowichtext.appwy(wocawizedmessage))

                case intewstitiaw: i-intewstitiaw =>
                  weasontouwtpawsew.fwomweasontowichtext(intewstitiaw.weason, (˘ω˘) wanguagetag)

                case _ =>
                  n-nyone
              }

              vaw iswoot: boowean = gtfw.tweetid == wequest.convewsationid
              vaw isoutew: b-boowean = tombstoneid == w-wequest.convewsationid
              vaw w-weveawtextopt: option[wichtext] = action match {
                c-case _: intewstitiawwimitedengagements | _: emewgencydynamicintewstitiaw
                    i-if iswoot && isoutew =>
                  none

                c-case _: intewstitiaw | _: intewstitiawwimitedengagements |
                    _: e-emewgencydynamicintewstitiaw =>
                  some(weasontouwtpawsew.getwichweveawtext(wanguagetag))

                case _ =>
                  nyone
              }

              v-vaw incwudetweet = action match {
                case _: i-intewstitiaw | _: i-intewstitiawwimitedengagements |
                    _: e-emewgencydynamicintewstitiaw =>
                  twue
                case _ => f-fawse
              }

              vaw twuncatefowaction: boowean =
                shouwdtwuncatedescendantswhenfocaw(action)
              vaw twuncatefownoncompwiant: b-boowean =
                n-nyoncompwiantopt
                  .map(shouwdtwuncatedescendantswhenfocaw).getowewse(fawse)
              v-vaw twuncatedescendants: b-boowean =
                twuncatefowaction || twuncatefownoncompwiant

              v-vaw tombstone = t-textopt match {
                case some(_) if wequest.usewichtext =>
                  v-vftombstone(
                    incwudetweet = incwudetweet, rawr x3
                    a-action = action, (///ˬ///✿)
                    tombstoneinfo = s-some(
                      t-tombstoneinfo(
                        cta = nyone,
                        w-weveawtext = n-nyone,
                        w-wichtext = textopt, 😳😳😳
                        wichweveawtext = w-weveawtextopt
                      )
                    ), (///ˬ///✿)
                    tombstonedispwaytype = tombstonetype.tombstonedispwaytype, ^^;;
                    t-twuncatedescendantswhenfocaw = twuncatedescendants
                  )
                case some(_) =>
                  vftombstone(
                    i-incwudetweet = i-incwudetweet, ^^
                    a-action = a-action, (///ˬ///✿)
                    t-tombstoneinfo = some(
                      tombstoneinfo(
                        t-text = textopt
                          .map(wichtext => wichtext.text).getowewse(
                            ""
                        cta = nyone, -.-
                        w-weveawtext = weveawtextopt.map(_.text), /(^•ω•^)
                        w-wichtext = nyone,
                        wichweveawtext = n-nyone
                      )
                    ),
                    t-tombstonedispwaytype = tombstonetype.tombstonedispwaytype, UwU
                    t-twuncatedescendantswhenfocaw = twuncatedescendants
                  )

                c-case nyone =>
                  v-vftombstone(
                    incwudetweet = f-fawse, (⑅˘꒳˘)
                    a-action = action, ʘwʘ
                    t-tombstoneinfo = some(
                      tombstoneinfo(
                        cta = nyone, σωσ
                        w-weveawtext = nyone, ^^
                        w-wichtext = some(epitaphtowichtext(epitaph.unavaiwabwe, OwO wanguagetag)), (ˆ ﻌ ˆ)♡
                        w-wichweveawtext = n-none
                      )
                    ), o.O
                    t-tombstonedispwaytype = tombstonetype.tombstonedispwaytype, (˘ω˘)
                    t-twuncatedescendantswhenfocaw = t-twuncatedescendants
                  )
              }

              some((gtfw.tweetid, 😳 t-tombstone))

            case (none, (U ᵕ U❁) s-some(wimitedengagements))
                if shouwdtwuncatedescendantswhenfocaw(wimitedengagements) =>
              vaw t-tombstone = vftombstone(
                t-tombstoneid = gtfw.tweetid, :3
                incwudetweet = twue, o.O
                action = w-wimitedengagements, (///ˬ///✿)
                t-tombstoneinfo = nyone, OwO
                tombstonedispwaytype = tombstonedispwaytype.noncompwiant, >w<
                t-twuncatedescendantswhenfocaw = twue
              )
              s-some((gtfw.tweetid, ^^ t-tombstone))

            case _ =>
              nyone
          }
        }
      }

      tombstonevisibiwitywesponse(
        tweetvewdicts = t-tombstones.tomap
      )
    }
  }

  pwivate def cweatewocawizedtombstone(
    f-fiwtewedweason: fiwtewedweason, (⑅˘꒳˘)
    t-tombstonestats: s-statsweceivew, ʘwʘ
  ): option[wocawizedtombstone] = {

    v-vaw t-tombstoneopt = f-fiwtewedweasonhewpew.gettombstone(fiwtewedweason)
    t-tombstoneopt m-match {
      c-case some(t.tombstone(weasonopt, (///ˬ///✿) some(message))) =>
        tombstoneweasonconvewtew.fwomthwift(weasonopt).map { wocawweason =>
          tombstonestats
            .scope("wocawized").countew(wocawweason.tostwing().towowewcase()).incw()
          wocawizedtombstone(wocawweason, XD w-wocawizedmessageconvewtew.fwomthwift(message))
        }

      c-case _ => n-nyone
    }
  }

  p-pwivate def c-cweatetombstone(
    e-epitaph: epitaph, 😳
    tombstonestats: statsweceivew, >w<
    extwacountewopt: option[stwing] = n-nyone
  ): option[action] = {
    t-tombstonestats
      .scope("wegacy")
      .countew(epitaph.tostwing().towowewcase())
      .incw()
    extwacountewopt.map { extwacountew =>
      tombstonestats
        .scope("wegacy")
        .scope(epitaph.tostwing().towowewcase())
        .countew(extwacountew)
        .incw()
    }
    s-some(tombstone(epitaph))
  }
}
