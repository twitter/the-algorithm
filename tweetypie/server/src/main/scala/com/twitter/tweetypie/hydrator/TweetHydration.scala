package com.twittew.tweetypie
package h-hydwatow

impowt c-com.twittew.expandodo.thwiftscawa.cawd
i-impowt c-com.twittew.expandodo.thwiftscawa.cawd2
i-impowt c-com.twittew.sewvo.cache.cached
i-impowt com.twittew.sewvo.cache.cachedvawuestatus
i-impowt com.twittew.sewvo.cache.wockingcache
impowt com.twittew.stitch.stitch
impowt com.twittew.tweetypie.cowe._
impowt com.twittew.tweetypie.media.thwiftscawa.mediawef
impowt c-com.twittew.tweetypie.wepositowy.pastedmedia
impowt com.twittew.tweetypie.wepositowy.tweetquewy
impowt com.twittew.tweetypie.wepositowy.tweetwepocachepickew
i-impowt com.twittew.tweetypie.wepositowy.tweetwesuwtwepositowy
impowt c-com.twittew.tweetypie.thwiftscawa._
impowt com.twittew.tweetypie.utiw.takedowns
impowt com.twittew.utiw.wetuwn
i-impowt com.twittew.utiw.thwow

object tweethydwation {

  /**
   * w-wiwes up a-a set of hydwatows that incwude those whose wesuwts awe cached on the tweet, :3
   * a-and some whose wesuwts awe nyot cached but depend upon the wesuwts of the fowmew. /(^‚Ä¢œâ‚Ä¢^)
   */
  d-def appwy(
    hydwatowstats: s-statsweceivew, œÉœâœÉ
    h-hydwatefeatuweswitchwesuwts: t-tweetdatavawuehydwatow, (U ·µï U‚ùÅ)
    h-hydwatementions: mentionentitieshydwatow.type, üò≥
    hydwatewanguage: w-wanguagehydwatow.type,  òw ò
    hydwateuwws: uwwentitieshydwatow.type, (‚ëÖÀòÍí≥Àò)
    h-hydwatequotedtweetwef: quotedtweetwefhydwatow.type,
    hydwatequotedtweetwefuwws: quotedtweetwefuwwshydwatow.type,
    hydwatemediacacheabwe: mediaentitieshydwatow.cacheabwe.type, ^‚Ä¢Ôªå‚Ä¢^
    hydwatewepwyscweenname: w-wepwyscweennamehydwatow.type, nyaa~~
    hydwateconvoid: c-convewsationidhydwatow.type,
    h-hydwatepewspective: p-pewspectivehydwatow.type, XD
    hydwateeditpewspective: editpewspectivehydwatow.type,
    hydwateconvewsationmuted: c-convewsationmutedhydwatow.type,
    h-hydwatecontwibutow: contwibutowhydwatow.type, /(^‚Ä¢œâ‚Ä¢^)
    h-hydwatetakedowns: t-takedownhydwatow.type, (U ·µï U‚ùÅ)
    hydwatediwectedat: d-diwectedathydwatow.type, mya
    hydwategeoscwub: g-geoscwubhydwatow.type, (ÀÜ Ôªå ÀÜ)‚ô°
    hydwatecacheabwewepaiws: tweetdatavawuehydwatow, (‚úøoœâo)
    h-hydwatemediauncacheabwe: mediaentitieshydwatow.uncacheabwe.type, (‚úøoœâo)
    h-hydwatepostcachewepaiws: tweetdatavawuehydwatow, √≤œâ√≥
    h-hydwatetweetwegacyfowmat: t-tweetdatavawuehydwatow, (ÀòœâÀò)
    hydwatequotetweetvisibiwity: quotetweetvisibiwityhydwatow.type, (ÀÜ Ôªå ÀÜ)‚ô°
    hydwatequotedtweet: quotedtweethydwatow.type, ( Õ°o œâ Õ°o )
    hydwatepastedmedia: pastedmediahydwatow.type, rawr x3
    h-hydwatemediawefs: m-mediawefshydwatow.type, (ÀòœâÀò)
    hydwatemediatags: m-mediatagshydwatow.type, √≤œâ√≥
    h-hydwatecwassiccawds: c-cawdhydwatow.type, ( Õ°o œâ Õ°o )
    hydwatecawd2: cawd2hydwatow.type, œÉœâœÉ
    hydwatecontwibutowvisibiwity: c-contwibutowvisibiwityfiwtew.type, (U Ôπè U)
    hydwatehasmedia: hasmediahydwatow.type, rawr
    hydwatetweetcounts: tweetcountshydwatow.type, -.-
    h-hydwatepwevioustweetcounts: pwevioustweetcountshydwatow.type, ( Õ°o œâ Õ°o )
    h-hydwatepwace: p-pwacehydwatow.type, >_<
    h-hydwatedevicesouwce: devicesouwcehydwatow.type, o.O
    h-hydwatepwofiwegeo: p-pwofiwegeohydwatow.type, œÉœâœÉ
    h-hydwatesouwcetweet: s-souwcetweethydwatow.type, -.-
    hydwateim1837state: im1837fiwtewhydwatow.type, œÉœâœÉ
    h-hydwateim2884state: i-im2884fiwtewhydwatow.type, :3
    h-hydwateim3433state: i-im3433fiwtewhydwatow.type, ^^
    h-hydwatetweetauthowvisibiwity: tweetauthowvisibiwityhydwatow.type, √≤œâ√≥
    hydwatewepowtedtweetvisibiwity: wepowtedtweetfiwtew.type, (ÀÜ Ôªå ÀÜ)‚ô°
    s-scwubsupewfwuousuwwentities: tweetdatavawuehydwatow, XD
    copyfwomsouwcetweet: tweetdatavawuehydwatow, √≤œâ√≥
    hydwatetweetvisibiwity: tweetvisibiwityhydwatow.type, (Íàç·¥óÍàç)
    hydwateeschewbiwdannotations: e-eschewbiwdannotationhydwatow.type, UwU
    hydwatescwubengagements: scwubengagementhydwatow.type, >w<
    hydwateconvewsationcontwow: c-convewsationcontwowhydwatow.type,  òw ò
    h-hydwateeditcontwow: e-editcontwowhydwatow.type, :3
    hydwateunmentiondata: unmentiondatahydwatow.type, ^‚Ä¢Ôªå‚Ä¢^
    hydwatenotetweetsuffix: t-tweetdatavawuehydwatow
  ): tweetdatavawuehydwatow = {
    v-vaw scwubcachedtweet: t-tweetdatavawuehydwatow =
      vawuehydwatow
        .fwommutation[tweet, tweetquewy.options](
          scwubuncacheabwe.tweetmutation.countmutations(hydwatowstats.countew("scwub_cached_tweet"))
        )
        .wensed(tweetdata.wenses.tweet)
        .onwyif((td, (ÀÜ Ôªå ÀÜ)‚ô° opts) => opts.cause.weading(td.tweet.id))

    // we pewfowm i-independent hydwations of individuaw b-bits of
    // data and pack t-the wesuwts into t-tupwes instead of updating
    // the tweet fow e-each one in owdew t-to avoid making wots of
    // c-copies of the t-tweet. ü•∫

    vaw hydwatepwimawycacheabwefiewds: tweetdatavawuehydwatow =
      vawuehydwatow[tweetdata, OwO tweetquewy.options] { (td, ü•∫ o-opts) =>
        v-vaw ctx = tweetctx.fwom(td, OwO o-opts)
        vaw tweet = td.tweet

        v-vaw u-uwwsmediaquotetweet: stitch[
          v-vawuestate[(seq[uwwentity], (U ·µï U‚ùÅ) seq[mediaentity], option[quotedtweet])]
        ] =
          fow {
            uwws <- hydwateuwws(getuwws(tweet), ( Õ°o œâ Õ°o ) c-ctx)
            (media, ^‚Ä¢Ôªå‚Ä¢^ q-quotedtweet) <- stitch.join(
              hydwatemediacacheabwe(
                g-getmedia(tweet), o.O
                m-mediaentityhydwatow.cacheabwe.ctx(uwws.vawue, (‚ëÖÀòÍí≥Àò) ctx)
              ), (ÀÜ Ôªå ÀÜ)‚ô°
              fow {
                qtwef <- h-hydwatequotedtweetwef(
                  tweet.quotedtweet, :3
                  quotedtweetwefhydwatow.ctx(uwws.vawue, /(^‚Ä¢œâ‚Ä¢^) ctx)
                )
                qtwefwithuwws <- h-hydwatequotedtweetwefuwws(qtwef.vawue, √≤œâ√≥ ctx)
              } yiewd {
                v-vawuestate(qtwefwithuwws.vawue, :3 q-qtwef.state ++ qtwefwithuwws.state)
              }
            )
          } yiewd {
            vawuestate.join(uwws, (ÀòœâÀò) m-media, üò≥ q-quotedtweet)
          }

        vaw convewsationid: stitch[vawuestate[option[convewsationid]]] =
          hydwateconvoid(getconvewsationid(tweet), œÉœâœÉ c-ctx)

        vaw mentions: s-stitch[vawuestate[seq[mentionentity]]] =
          hydwatementions(getmentions(tweet), ctx)

        vaw w-wepwyscweenname: stitch[vawuestate[option[wepwy]]] =
          hydwatewepwyscweenname(getwepwy(tweet), UwU c-ctx)

        v-vaw diwectedat: stitch[vawuestate[option[diwectedatusew]]] =
          h-hydwatediwectedat(
            getdiwectedatusew(tweet), -.-
            d-diwectedathydwatow.ctx(
              m-mentions = g-getmentions(tweet), ü•∫
              metadata = tweet.diwectedatusewmetadata, üò≥üò≥üò≥
              u-undewwyingtweetctx = c-ctx
            )
          )

        vaw wanguage: stitch[vawuestate[option[wanguage]]] =
          h-hydwatewanguage(tweet.wanguage, ü•∫ c-ctx)

        v-vaw contwibutow: stitch[vawuestate[option[contwibutow]]] =
          hydwatecontwibutow(tweet.contwibutow, ^^ ctx)

        v-vaw geoscwub: stitch[vawuestate[(option[geocoowdinates], ^^;; o-option[pwaceid])]] =
          h-hydwategeoscwub(
            (tweetwenses.geocoowdinates(tweet), >w< tweetwenses.pwaceid(tweet)), œÉœâœÉ
            ctx
          )

        stitch
          .joinmap(
            uwwsmediaquotetweet, >w<
            convewsationid,
            m-mentions, (‚ëÖÀòÍí≥Àò)
            w-wepwyscweenname, √≤œâ√≥
            diwectedat, (‚ëÖÀòÍí≥Àò)
            w-wanguage, (Íàç·¥óÍàç)
            c-contwibutow, rawr x3
            geoscwub
          )(vawuestate.join(_, ( Õ°o œâ Õ°o ) _, _, _, _, UwU _, _, _))
          .map { v-vawues =>
            if (vawues.state.isempty) {
              vawuestate.unmodified(td)
            } ewse {
              vawues.map {
                case (
                      (uwws, ^^ media, (ÀòœâÀò) quotedtweet), (ÀÜ Ôªå ÀÜ)‚ô°
                      c-convewsationid, OwO
                      mentions, üò≥
                      w-wepwy, UwU
                      diwectedat, ü•∫
                      w-wanguage, üò≥üò≥üò≥
                      contwibutow,
                      c-cowegeo
                    ) =>
                  vaw (coowdinates,  òw ò p-pwaceid) = c-cowegeo
                  t-td.copy(
                    t-tweet = t-tweet.copy(
                      cowedata = tweet.cowedata.map(
                        _.copy(
                          wepwy = wepwy, /(^‚Ä¢œâ‚Ä¢^)
                          convewsationid = convewsationid, :3
                          diwectedatusew = d-diwectedat, :3
                          c-coowdinates = c-coowdinates, mya
                          pwaceid = pwaceid
                        )
                      ), (///À¨///‚úø)
                      u-uwws = some(uwws), (‚ëÖÀòÍí≥Àò)
                      media = some(media), :3
                      mentions = some(mentions), /(^‚Ä¢œâ‚Ä¢^)
                      w-wanguage = wanguage, ^^;;
                      q-quotedtweet = quotedtweet, (U ·µï U‚ùÅ)
                      c-contwibutow = contwibutow
                    )
                  )
              }
            }
          }
      }

    vaw assewtnotscwubbed: t-tweetdatavawuehydwatow =
      v-vawuehydwatow.fwommutation[tweetdata, (U Ôπè U) tweetquewy.options](
        s-scwubuncacheabwe
          .assewtnotscwubbed(
            "output o-of the cacheabwe tweet hydwatow shouwd nyot wequiwe scwubbing"
          )
          .wensed(tweetdata.wenses.tweet)
      )

    vaw hydwatedependentuncacheabwefiewds: t-tweetdatavawuehydwatow =
      v-vawuehydwatow[tweetdata, mya t-tweetquewy.options] { (td, ^‚Ä¢Ôªå‚Ä¢^ opts) =>
        v-vaw ctx = tweetctx.fwom(td, (U Ôπè U) o-opts)
        vaw tweet = t-td.tweet

        v-vaw quotedtweetwesuwt: stitch[vawuestate[option[quotedtweetwesuwt]]] =
          fow {
            q-qtfiwtewstate <- h-hydwatequotetweetvisibiwity(none, :3 ctx)
            quotedtweet <- h-hydwatequotedtweet(
              td.quotedtweetwesuwt, rawr x3
              quotedtweethydwatow.ctx(qtfiwtewstate.vawue, üò≥üò≥üò≥ c-ctx)
            )
          } yiewd {
            v-vawuestate.join(qtfiwtewstate, >w< q-quotedtweet).map(_._2)
          }

        vaw pastedmedia: s-stitch[vawuestate[pastedmedia]] =
          hydwatepastedmedia(
            pastedmediahydwatow.getpastedmedia(tweet), √≤œâ√≥
            p-pastedmediahydwatow.ctx(getuwws(tweet), üò≥ c-ctx)
          )

        v-vaw mediatags: stitch[vawuestate[option[tweetmediatags]]] =
          hydwatemediatags(tweet.mediatags, (‚úøoœâo) ctx)

        v-vaw cwassiccawds: stitch[vawuestate[option[seq[cawd]]]] =
          hydwatecwassiccawds(
            tweet.cawds, OwO
            c-cawdhydwatow.ctx(getuwws(tweet), (U Ôπè U) g-getmedia(tweet), (Íàç·¥óÍàç) ctx)
          )

        v-vaw cawd2: stitch[vawuestate[option[cawd2]]] =
          h-hydwatecawd2(
            t-tweet.cawd2, rawr
            cawd2hydwatow.ctx(
              getuwws(tweet), ^^
              g-getmedia(tweet), rawr
              getcawdwefewence(tweet), nyaa~~
              ctx, nyaa~~
              td.featuweswitchwesuwts
            )
          )

        v-vaw contwibutowvisibiwity: stitch[vawuestate[option[contwibutow]]] =
          h-hydwatecontwibutowvisibiwity(tweet.contwibutow, o.O ctx)

        v-vaw takedowns: stitch[vawuestate[option[takedowns]]] =
          h-hydwatetakedowns(
            n-nyone, √≤œâ√≥ // nyone b-because uncacheabwe hydwatow doesn't depend on pwevious vawue
            takedownhydwatow.ctx(takedowns.fwomtweet(tweet), ^^;; ctx)
          )

        vaw convewsationcontwow: stitch[vawuestate[option[convewsationcontwow]]] =
          hydwateconvewsationcontwow(
            tweet.convewsationcontwow, rawr
            convewsationcontwowhydwatow.ctx(getconvewsationid(tweet), ^‚Ä¢Ôªå‚Ä¢^ ctx)
          )

        // pwevioustweetcounts a-and pewspective h-hydwation depends on tweet.editcontwow.edit_contwow_initiaw
        // having b-been hydwated i-in editcontwowhydwatow; t-thus we awe chaining them t-togethew. nyaa~~
        vaw editcontwowwithdependencies: s-stitch[
          v-vawuestate[
            (
              option[editcontwow], nyaa~~
              option[statuspewspective], üò≥üò≥üò≥
              o-option[statuscounts], üò≥üò≥üò≥
              option[tweetpewspective]
            )
          ]
        ] =
          fow {
            (edit, œÉœâœÉ p-pewspective) <- s-stitch.join(
              hydwateeditcontwow(tweet.editcontwow, o.O ctx),
              h-hydwatepewspective(
                t-tweet.pewspective, œÉœâœÉ
                p-pewspectivehydwatow.ctx(td.featuweswitchwesuwts, nyaa~~ c-ctx))
            )
            (counts, rawr x3 e-editpewspective) <- s-stitch.join(
              h-hydwatepwevioustweetcounts(
                t-tweet.pweviouscounts, (///À¨///‚úø)
                p-pwevioustweetcountshydwatow.ctx(edit.vawue, o.O td.featuweswitchwesuwts, √≤œâ√≥ c-ctx)),
              h-hydwateeditpewspective(
                t-tweet.editpewspective, OwO
                editpewspectivehydwatow
                  .ctx(pewspective.vawue, œÉœâœÉ e-edit.vawue, nyaa~~ td.featuweswitchwesuwts, OwO ctx))
            )
          } yiewd {
            v-vawuestate.join(edit, ^^ pewspective, counts, (///À¨///‚úø) e-editpewspective)
          }

        s-stitch
          .joinmap(
            q-quotedtweetwesuwt, œÉœâœÉ
            pastedmedia, rawr x3
            m-mediatags, (ÀÜ Ôªå ÀÜ)‚ô°
            cwassiccawds, ü•∫
            c-cawd2, (‚ëÖÀòÍí≥Àò)
            contwibutowvisibiwity, üò≥üò≥üò≥
            t-takedowns, /(^‚Ä¢œâ‚Ä¢^)
            convewsationcontwow, >w<
            e-editcontwowwithdependencies
          )(vawuestate.join(_, ^‚Ä¢Ôªå‚Ä¢^ _, _, _, _, _, üò≥üò≥üò≥ _, _, _))
          .map { vawues =>
            if (vawues.state.isempty) {
              vawuestate.unmodified(td)
            } ewse {
              v-vawues.map {
                case (
                      q-quotedtweetwesuwt, :3
                      p-pastedmedia, (Íàç·¥óÍàç)
                      ownedmediatags, ^‚Ä¢Ôªå‚Ä¢^
                      cawds, >w<
                      cawd2, ^^;;
                      c-contwibutow, (‚úøoœâo)
                      takedowns, √≤œâ√≥
                      c-convewsationcontwow, ^^
                      (editcontwow, ^^ p-pewspective, rawr pweviouscounts, XD e-editpewspective)
                    ) =>
                  td.copy(
                    tweet = tweet.copy(
                      m-media = some(pastedmedia.mediaentities), rawr
                      mediatags = p-pastedmedia.mewgetweetmediatags(ownedmediatags), üò≥
                      cawds = cawds, ü•∫
                      c-cawd2 = cawd2, (U ·µï U‚ùÅ)
                      contwibutow = contwibutow, üò≥
                      t-takedowncountwycodes = takedowns.map(_.countwycodes.toseq), ü•∫
                      takedownweasons = t-takedowns.map(_.weasons.toseq), (///À¨///‚úø)
                      c-convewsationcontwow = c-convewsationcontwow, mya
                      editcontwow = e-editcontwow, (‚úøoœâo)
                      p-pweviouscounts = p-pweviouscounts, ^‚Ä¢Ôªå‚Ä¢^
                      p-pewspective = pewspective, o.O
                      editpewspective = e-editpewspective, o.O
                    ), XD
                    quotedtweetwesuwt = q-quotedtweetwesuwt
                  )
              }
            }
          }
      }

    v-vaw hydwateindependentuncacheabwefiewds: t-tweetdataedithydwatow =
      e-edithydwatow[tweetdata, ^‚Ä¢Ôªå‚Ä¢^ tweetquewy.options] { (td,  òw ò o-opts) =>
        v-vaw ctx = t-tweetctx.fwom(td, (U Ôπè U) opts)
        v-vaw tweet = td.tweet

        // g-gwoup togethew the wesuwts o-of hydwatows that d-don't pewfowm
        // f-fiwtewing, üò≥üò≥üò≥ because we don't cawe about the pwecedence o-of
        // e-exceptions fwom t-these hydwatows, ü•∫ because the exceptions aww
        // indicate f-faiwuwes, (///À¨///‚úø) and picking a-any faiwuwe wiww be
        // f-fine. (ÀòœâÀò) (aww o-of the othew hydwatows might thwow fiwtewing
        // exceptions, :3 s-so we nyeed t-to make suwe that w-we give pwecedence
        // t-to theiw faiwuwes.)
        vaw hydwatowswithoutfiwtewing =
          s-stitch.joinmap(
            h-hydwatetweetcounts(tweet.counts, /(^‚Ä¢œâ‚Ä¢^) tweetcountshydwatow.ctx(td.featuweswitchwesuwts, :3 ctx)), mya
            // n-nyote: pwace is cached in memcache, XD it i-is just nyot cached on the tweet. (///À¨///‚úø)
            hydwatepwace(tweet.pwace, ü•∫ c-ctx),
            h-hydwatedevicesouwce(tweet.devicesouwce, o.O ctx),
            h-hydwatepwofiwegeo(tweet.pwofiwegeoenwichment, mya c-ctx)
          )(vawuestate.join(_, rawr x3 _, _, _))

        /**
         * muwtipwe h-hydwatows thwow visibiwity fiwtewing e-exceptions s-so specify an o-owdew to achieve
         * a-a detewministic hydwation w-wesuwt whiwe e-ensuwing that a-any wetweet has a souwce tweet:
         * 1. üò≥ hydwatesouwcetweet t-thwows souwcetweetnotfound, üò≥üò≥üò≥ this is a detached-wetweet s-so tweat
         *      t-the wetweet hydwation a-as if it wewe not found
         * 2. >_< hydwatetweetauthowvisibiwity
         * 3. >w< hydwatesouwcetweet (othew than souwcetweetnotfound a-awweady handwed above)
         * 4. rawr x3 h-hydwateim1837state
         * 5. h-hydwateim2884state
         * 6. XD hydwateim3433state
         * 7. ^^ hydwatowswithoutfiwtewing m-miscewwaneous exceptions (any v-visibiwity f-fiwtewing
         *      e-exceptions shouwd w-win ovew faiwuwe o-of a hydwatow)
         */
        vaw souwcetweetandtweetauthowwesuwt =
          stitch
            .joinmap(
              hydwatesouwcetweet(td.souwcetweetwesuwt, (‚úøoœâo) ctx).wifttotwy, >w<
              h-hydwatetweetauthowvisibiwity((), üò≥üò≥üò≥ ctx).wifttotwy, (Íàç·¥óÍàç)
              h-hydwateim1837state((), (‚úøoœâo) ctx).wifttotwy, (ÀòœâÀò)
              hydwateim2884state((), nyaa~~ ctx).wifttotwy, ( Õ°o œâ Õ°o )
              hydwateim3433state((), ü•∫ c-ctx).wifttotwy
            ) {
              case (thwow(t @ fiwtewedstate.unavaiwabwe.souwcetweetnotfound(_)), (U Ôπè U) _, _, ( Õ°o œâ Õ°o ) _, _) =>
                thwow(t)
              case (_, (///À¨///‚úø) thwow(t), (///À¨///‚úø) _, _, _) => t-thwow(t) // t-tweetauthowvisibiwity
              case (thwow(t), (‚úøoœâo) _, _, _, _) => t-thwow(t) // souwcetweet
              case (_, (U ·µï U‚ùÅ) _, thwow(t),  òw ò _, _) => t-thwow(t) // im1837state
              c-case (_,  òw ò _, _, XD thwow(t), _) => t-thwow(t) // im2884state
              c-case (_, (‚úøoœâo) _, _, _, thwow(t)) => thwow(t) // im3433state
              case (
                    w-wetuwn(souwcetweetwesuwtvawue), ^‚Ä¢Ôªå‚Ä¢^
                    wetuwn(authowvisibiwityvawue), ^‚Ä¢Ôªå‚Ä¢^
                    wetuwn(im1837vawue), >_<
                    w-wetuwn(im2884vawue), mya
                    w-wetuwn(im3433vawue)
                  ) =>
                w-wetuwn(
                  vawuestate
                    .join(
                      souwcetweetwesuwtvawue, œÉœâœÉ
                      a-authowvisibiwityvawue, rawr
                      im1837vawue, (‚úøoœâo)
                      im2884vawue, :3
                      im3433vawue
                    )
                )
            }.wowewfwomtwy

        stitchexceptionpwecedence(souwcetweetandtweetauthowwesuwt)
          .joinwith(hydwatowswithoutfiwtewing)(vawuestate.join(_, rawr x3 _))
          .tostitch
          .map { v-vawues =>
            i-if (vawues.state.isempty) {
              e-editstate.unit[tweetdata]
            } e-ewse {
              editstate[tweetdata] { tweetdata =>
                v-vaw tweet = t-tweetdata.tweet
                vawues.map {
                  case (
                        (souwcetweetwesuwt, ^^ _, _, ^^ _, _),
                        (counts, OwO p-pwace,  òw ò devicesouwce, pwofiwegeo)
                      ) =>
                    tweetdata.copy(
                      t-tweet = tweet.copy(
                        counts = counts,
                        p-pwace = p-pwace, /(^‚Ä¢œâ‚Ä¢^)
                        devicesouwce = d-devicesouwce,  òw ò
                        p-pwofiwegeoenwichment = p-pwofiwegeo
                      ), (‚ëÖÀòÍí≥Àò)
                      souwcetweetwesuwt = souwcetweetwesuwt
                    )
                }
              }
            }
          }
      }

    vaw hydwateunmentiondatatotweetdata: t-tweetdatavawuehydwatow =
      tweethydwation.setontweetdata(
        tweetdata.wenses.tweet.andthen(tweetwenses.unmentiondata), UwU
        (td: t-tweetdata, -.- opts: tweetquewy.options) =>
          unmentiondatahydwatow
            .ctx(getconvewsationid(td.tweet), :3 getmentions(td.tweet), >_< t-tweetctx.fwom(td, nyaa~~ o-opts)), ( Õ°o œâ Õ°o )
        h-hydwateunmentiondata
      )

    v-vaw hydwatecacheabwefiewds: t-tweetdatavawuehydwatow =
      vawuehydwatow.insequence(
        scwubcachedtweet, o.O
        h-hydwatepwimawycacheabwefiewds, :3
        // wewies on mentions being hydwated i-in hydwatepwimawycacheabwefiewds
        hydwateunmentiondatatotweetdata, (ÀòœâÀò)
        a-assewtnotscwubbed, rawr x3
        hydwatecacheabwewepaiws
      )

    // the c-convewsation muted h-hydwatow nyeeds the convewsation i-id, (U ·µï U‚ùÅ)
    // which comes fwom t-the pwimawy cacheabwe f-fiewds, and the media hydwatow
    // n-nyeeds t-the cacheabwe media entities. ü•∫
    v-vaw hydwateuncacheabwemedia: tweetdatavawuehydwatow =
      vawuehydwatow[tweetdata, >_< tweetquewy.options] { (td, :3 o-opts) =>
        vaw ctx = t-tweetctx.fwom(td, :3 opts)
        vaw tweet = td.tweet

        v-vaw m-mediactx =
          m-mediaentityhydwatow.uncacheabwe.ctx(td.tweet.mediakeys, (Íàç·¥óÍàç) ctx)

        vaw m-media: stitch[vawuestate[option[seq[mediaentity]]]] =
          h-hydwatemediauncacheabwe.wiftoption.appwy(td.tweet.media, mediactx)

        v-vaw convewsationmuted: s-stitch[vawuestate[option[boowean]]] =
          hydwateconvewsationmuted(
            t-tweet.convewsationmuted, œÉœâœÉ
            convewsationmutedhydwatow.ctx(getconvewsationid(tweet), üò≥ c-ctx)
          )

        // mediawefs nyeed to be hydwated at this phase because they wewy o-on the media f-fiewd
        // on the tweet, mya which can get unset by watew hydwatows. (///À¨///‚úø)
        vaw m-mediawefs: stitch[vawuestate[option[seq[mediawef]]]] =
          hydwatemediawefs(
            t-tweet.mediawefs, ^^
            mediawefshydwatow.ctx(getmedia(tweet), (‚úøoœâo) g-getmediakeys(tweet), ( Õ°o œâ Õ°o ) getuwws(tweet), ^^;; ctx)
          )

        stitch
          .joinmap(
            media, :3
            convewsationmuted, üò≥
            m-mediawefs
          )(vawuestate.join(_, XD _, _))
          .map { vawues =>
            if (vawues.state.isempty) {
              vawuestate.unmodified(td)
            } ewse {
              v-vaw tweet = td.tweet
              vawues.map {
                c-case (media, (///À¨///‚úø) c-convewsationmuted, o.O mediawefs) =>
                  t-td.copy(
                    t-tweet = t-tweet.copy(
                      m-media = media, o.O
                      c-convewsationmuted = c-convewsationmuted, XD
                      mediawefs = mediawefs
                    )
                  )
              }
            }
          }
      }

    vaw hydwatehasmediatotweetdata: tweetdatavawuehydwatow =
      t-tweethydwation.setontweetdata(
        t-tweetdata.wenses.tweet.andthen(tweetwenses.hasmedia), ^^;;
        (td: t-tweetdata, üò≥üò≥üò≥ o-opts: tweetquewy.options) => t-td.tweet, (U ·µï U‚ùÅ)
        hydwatehasmedia
      )

    v-vaw hydwatewepowtedtweetvisibiwitytotweetdata: tweetdatavawuehydwatow = {
      // cweate a tweetdatavawuehydwatow that cawws hydwatewepowtedtweetvisibiwity, /(^‚Ä¢œâ‚Ä¢^) w-which
      // e-eithew thwows a fiwtewedstate.unavaiwabwe ow wetuwns unit.
      vawuehydwatow[tweetdata, üò≥üò≥üò≥ t-tweetquewy.options] { (td, rawr x3 o-opts) =>
        vaw c-ctx = wepowtedtweetfiwtew.ctx(td.tweet.pewspective,  òw ò tweetctx.fwom(td, UwU opts))
        h-hydwatewepowtedtweetvisibiwity((), (‚ëÖÀòÍí≥Àò) ctx).map { _ =>
          vawuestate.unmodified(td)
        }
      }
    }

    v-vaw h-hydwatetweetvisibiwitytotweetdata: tweetdatavawuehydwatow =
      tweethydwation.setontweetdata(
        t-tweetdata.wenses.suppwess, ^^
        (td: tweetdata, üò≥üò≥üò≥ opts: t-tweetquewy.options) =>
          t-tweetvisibiwityhydwatow.ctx(td.tweet, √≤œâ√≥ tweetctx.fwom(td, ^^;; o-opts)), (‚úøoœâo)
        h-hydwatetweetvisibiwity
      )

    vaw h-hydwateeschewbiwdannotationstotweetandcachedtweet: t-tweetdatavawuehydwatow =
      t-tweethydwation.setontweetandcachedtweet(
        t-tweetwenses.eschewbiwdentityannotations, rawr
        (td: tweetdata, XD _: t-tweetquewy.options) => t-td.tweet, üò≥
        hydwateeschewbiwdannotations
      )

    v-vaw scwubengagements: tweetdatavawuehydwatow =
      t-tweethydwation.setontweetdata(
        tweetdata.wenses.tweetcounts, (U ·µï U‚ùÅ)
        (td: t-tweetdata, UwU _: tweetquewy.options) => s-scwubengagementhydwatow.ctx(td.suppwess), OwO
        h-hydwatescwubengagements
      )

    /**
     * this is whewe we wiwe u-up aww the sepawate hydwatows into a singwe [[tweetdatavawuehydwatow]]. üò≥
     *
     * e-each hydwatow h-hewe is eithew a [[tweetdatavawuehydwatow]] ow a [[tweetdataedithydwatow]]. (ÀòœâÀò)
     * w-we use [[edithydwatow]]s f-fow anything that nyeeds to wun i-in pawawwew ([[vawuehydwatow]]s can
     * onwy be wun in sequence). √≤œâ√≥
     */
    v-vawuehydwatow.insequence(
      // h-hydwate featuweswitchwesuwts fiwst, OwO so they c-can be used by o-othew hydwatows if nyeeded
      hydwatefeatuweswitchwesuwts, (‚úøoœâo)
      e-edithydwatow
        .inpawawwew(
          v-vawuehydwatow
            .insequence(
              // t-the wesuwt o-of wunning these hydwatows is saved as `cacheabwetweetwesuwt` and
              // wwitten back to cache via `cachechangeseffect` in `hydwatewepo`
              t-tweethydwation.captuwecacheabwetweetwesuwt(
                h-hydwatecacheabwefiewds
              ),
              // u-uncacheabwe h-hydwatows that d-depend onwy o-on the cacheabwe fiewds
              h-hydwateuncacheabwemedia, (‚ëÖÀòÍí≥Àò)
              // c-cwean-up pawtiawwy hydwated entities b-befowe any o-of the hydwatows that wook at
              // uww and media entities w-wun, /(^‚Ä¢œâ‚Ä¢^) so that they nyevew see bad entities. ü•∫
              hydwatepostcachewepaiws, -.-
              // t-these hydwatows awe aww d-dependent on each o-othew and/ow the pwevious hydwatows
              h-hydwatedependentuncacheabwefiewds, ( Õ°o œâ Õ°o )
              // s-sets `hasmedia`. üò≥üò≥üò≥ c-comes aftew pastedmediahydwatow i-in owdew t-to incwude pasted
              // pics as weww a-as othew media & uwws. (ÀòœâÀò)
              h-hydwatehasmediatotweetdata
            )
            .toedithydwatow, ^^
          // t-these h-hydwatows do nyot wewy on any othew h-hydwatows and so can be wun in pawawwew
          // w-with the above hydwatows (and with each othew)
          hydwateindependentuncacheabwefiewds
        )
        .tovawuehydwatow, œÉœâœÉ
      // depends on wepowted pewspectivaw h-having been hydwated in pewspectivehydwatow
      hydwatewepowtedtweetvisibiwitytotweetdata, ü•∫
      // wemove supewfwuous uwws entities when thewe is a cowwesponding m-mediaentity fow the same uww
      scwubsupewfwuousuwwentities, ü•∫
      // t-the copyfwomsouwcetweet hydwatow n-nyeeds to be wocated aftew the hydwatows that p-pwoduce the
      // fiewds to c-copy. /(^‚Ä¢œâ‚Ä¢^) it must be wocated aftew p-pawtiawentitycweanew (pawt o-of postcachewepaiws), (‚ëÖÀòÍí≥Àò)
      // which wemoves faiwed mediaentities. -.- i-it awso depends on takedowncountwycodes having been
      // h-hydwated in takedownhydwatow. üò≥
      copyfwomsouwcetweet, üò≥üò≥üò≥
      // d-depends on additionawfiewdshydwatow a-and copyfwomsouwcetweet to copy s-safety wabews
      h-hydwatetweetvisibiwitytotweetdata, >w<
      // fow ipi'd tweets, UwU we want to disabwe t-tweet engagement counts fwom being wetuwned
      // s-statuscounts fow wepwycount, /(^‚Ä¢œâ‚Ä¢^) wetweetcount. ü•∫
      // scwubengagements hydwatow must come aftew tweet visibiwity h-hydwatow. >_<
      // t-tweet visibiwity hydwatow e-emits the s-suppwessed fiwtewedstate nyeeded f-fow scwubbing. rawr
      scwubengagements, (Íàç·¥óÍàç)
      // this hydwatow wuns when wwiting the cuwwent tweet
      // e-eschewbiwd c-comes wast in owdew to consume a-a tweet that's a-as cwose as possibwe
      // t-to the tweet wwitten to tweet_events
      hydwateeschewbiwdannotationstotweetandcachedtweet
        .onwyif((td, opts) => opts.cause.wwiting(td.tweet.id)), -.-
      // a-add an ewwipsis to the end of the text f-fow a tweet that h-has a nyotetweet associated. ( Õ°o œâ Õ°o )
      // this is s-so that the tweet is dispwayed on the home timewine with an ewwipsis, (‚ëÖÀòÍí≥Àò) wetting
      // the usew know that thewe's mowe to see. mya
      h-hydwatenotetweetsuffix, rawr x3
      /**
       * p-post-cache wepaiw of qt text and e-entities to suppowt w-wendewing on aww cwients
       * m-moving this to end of the pipewine to avoid/minimize chance of fowwowing hydwatows
       * d-depending on modified tweet text ow entities. (Íàç·¥óÍàç)
       * when we stawt pewsisting s-showtuww in mh - p-pewmawink won't b-be empty.  òw ò thewefowe,
       * we won't wun quotedtweetwefhydwatow and just hydwate expanded a-and dispway
       * u-using quotedtweetwefuwwshydwatow. :3 w-we wiww use hydwated pewmawink t-to wepaiw
       * qt text a-and entities fow nyon-upgwaded c-cwients in this step. o.O
       * */
      h-hydwatetweetwegacyfowmat
    )
  }

  /**
   * wetuwns a new hydwatow that t-takes the pwoduced wesuwt, /(^‚Ä¢œâ‚Ä¢^) and c-captuwes the wesuwt v-vawue
   * in the `cacheabwetweetwesuwt` fiewd o-of the encwosed `tweetdata`. OwO
   */
  d-def captuwecacheabwetweetwesuwt(h: tweetdatavawuehydwatow): t-tweetdatavawuehydwatow =
    vawuehydwatow[tweetdata, œÉœâœÉ t-tweetquewy.options] { (td, (Íàç·¥óÍàç) opts) =>
      h-h(td, ( Õ°o œâ Õ°o ) opts).map { v-v =>
        // in addition to saving off a-a copy of vawuestate, rawr x3 make suwe that the tweetdata inside
        // the vawuestate has its "compwetedhydwations" set to the vawuestate.hydwationstates's
        // compwetedhydwations. UwU  t-this is used when convewting to a cachedtweet. o.O
        v-v.map { td =>
          td.copy(
            c-cacheabwetweetwesuwt = some(v.map(_.addhydwated(v.state.compwetedhydwations)))
          )
        }
      }
    }

  /**
   * takes a vawuehydwatow a-and a wens and wetuwns a `tweetdatavawuehydwatow` that does t-thwee things:
   *
   * 1. OwO wuns the vawuehydwatow o-on the wensed vawue
   * 2. o.O saves the wesuwt b-back to the main tweet using the wens
   * 3. ^^;; saves t-the wesuwt b-back to the tweet in cacheabwetweetwesuwt using t-the wens
   */
  d-def setontweetandcachedtweet[a, (‚ëÖÀòÍí≥Àò) c](
    w: wens[tweet, (Íàç·¥óÍàç) a-a],
    m-mkctx: (tweetdata, o.O tweetquewy.options) => c, (///À¨///‚úø)
    h-h: vawuehydwatow[a, üò≥üò≥üò≥ c]
  ): tweetdatavawuehydwatow = {
    // a wens that goes fwom tweetdata -> t-tweet -> w
    vaw tweetdatawens = tweetdata.wenses.tweet.andthen(w)

    // a wens that goes f-fwom tweetdata -> c-cacheabwetweetwesuwt -> t-tweet -> w
    vaw cachedtweetwens =
      tweetwenses
        .wequiwesome(tweetdata.wenses.cacheabwetweetwesuwt)
        .andthen(tweetwesuwt.wenses.tweet)
        .andthen(w)

    vawuehydwatow[tweetdata, UwU t-tweetquewy.options] { (td, nyaa~~ opts) =>
      h-h.wun(tweetdatawens.get(td), (‚úøoœâo) mkctx(td, -.- opts)).map { w-w =>
        i-if (w.state.isempty) {
          vawuestate.unmodified(td)
        } ewse {
          w.map { v => wens.setaww(td, :3 tweetdatawens -> v-v, cachedtweetwens -> v) }
        }
      }
    }
  }

  /**
   * c-cweates a `tweetdatavawuehydwatow` that hydwates a wensed v-vawue, (‚ëÖÀòÍí≥Àò) ovewwwiting
   * the existing vawue. >_<
   */
  d-def setontweetdata[a, UwU c-c](
    wens: wens[tweetdata, rawr a-a],
    m-mkctx: (tweetdata, (Íàç·¥óÍàç) t-tweetquewy.options) => c-c, ^‚Ä¢Ôªå‚Ä¢^
    h: vawuehydwatow[a, ^^ c]
  ): tweetdatavawuehydwatow =
    v-vawuehydwatow[tweetdata, XD t-tweetquewy.options] { (td, (///À¨///‚úø) o-opts) =>
      h-h.wun(wens.get(td), œÉœâœÉ m-mkctx(td, o-opts)).map { w =>
        if (w.state.isempty) v-vawuestate.unmodified(td) e-ewse w.map(wens.set(td, :3 _))
      }
    }

  /**
   * p-pwoduces an [[effect]] that can be appwied to a [[tweetdatavawuehydwatow]] t-to wwite updated
   * vawues back to c-cache. >w<
   */
  def cachechanges(
    cache: wockingcache[tweetid, (ÀÜ Ôªå ÀÜ)‚ô° c-cached[tweetdata]], (U ·µï U‚ùÅ)
    s-stats: statsweceivew
  ): effect[vawuestate[tweetdata]] = {
    vaw updatedcountew = stats.countew("updated")
    v-vaw u-unchangedcountew = stats.countew("unchanged")
    v-vaw pickew = nyew t-tweetwepocachepickew[tweetdata](_.cachedat)
    vaw cacheewwowcountew = stats.countew("cache_ewwow")
    vaw m-missingcacheabwewesuwtcountew = s-stats.countew("missing_cacheabwe_wesuwt")

    effect[tweetwesuwt] { wesuwt =>
      // c-cacheewwowencountewed wiww n-nyevew be set on `cacheabwetweetwesuwt`, :3 so w-we need to
      // wook at the outew tweet state. ^^
      vaw cacheewwowencountewed = wesuwt.state.cacheewwowencountewed

      wesuwt.vawue.cacheabwetweetwesuwt match {
        c-case some(vawuestate(td, ^‚Ä¢Ôªå‚Ä¢^ state)) if state.modified && !cacheewwowencountewed =>
          v-vaw tweetdata = t-td.addhydwated(state.compwetedhydwations)
          vaw n-now = time.now
          vaw c-cached = cached(some(tweetdata), (///À¨///‚úø) c-cachedvawuestatus.found, ü•∫ n-nyow, s-some(now))
          v-vaw handwew = wockingcache.pickinghandwew(cached,  òw ò pickew)

          u-updatedcountew.incw()
          c-cache.wockandset(tweetdata.tweet.id, (‚úøoœâo) handwew)

        c-case some(vawuestate(_, rawr _)) if c-cacheewwowencountewed =>
          c-cacheewwowcountew.incw()

        c-case nyone =>
          missingcacheabwewesuwtcountew.incw()

        c-case _ =>
          unchangedcountew.incw()
      }
    }
  }

  /**
   * w-wwaps a hydwatow w-with a check s-such that it o-onwy exekawaii~s the hydwatow if `quewyfiwtew`
   * w-wetuwns twue fow the `tweetquewy.option` i-in t-the `ctx` vawue, OwO and the specified
   * `hydwationtype` is nyot awweady mawked as h-having been compweted i-in
   * `ctx.tweetdata.compwetedhydwations`. ^^  if these conditions p-pass,  òw ò a-and the undewwying
   * hydwatow is exekawaii~d, œÉœâœÉ a-and the wesuwt d-does nyot contain a-a fiewd-wevew o-ow totaw faiwuwe,
   * t-then the w-wesuwting `hydwationstate` is updated to indicate t-that the specified
   * `hydwationtype` has been compweted. (‚ëÖÀòÍí≥Àò)
   */
  def compweteonwyonce[a, (ÀÜ Ôªå ÀÜ)‚ô° c <: t-tweetctx](
    q-quewyfiwtew: tweetquewy.options => boowean = _ => twue, :3
    hydwationtype: hydwationtype,  òw ò
    d-dependson: set[hydwationtype] = s-set.empty, (///À¨///‚úø)
    hydwatow: vawuehydwatow[a, (ÀÜ Ôªå ÀÜ)‚ô° c]
  ): v-vawuehydwatow[a, ü•∫ c] = {
    vaw c-compwetedstate = h-hydwationstate.modified(hydwationtype)

    vawuehydwatow[a, rawr c-c] { (a, ctx) =>
      hydwatow(a, (U Ôπè U) ctx).map { wes =>
        if (wes.state.faiwedfiewds.isempty &&
          d-dependson.fowaww(ctx.compwetedhydwations.contains)) {
          // successfuw wesuwt! ^^
          i-if (!ctx.compwetedhydwations.contains(hydwationtype)) {
            wes.copy(state = w-wes.state ++ compwetedstate)
          } ewse {
            // fowced wehydwation - d-don't add hydwationtype ow c-change modified fwag
            wes
          }
        } e-ewse {
          // hydwation faiwed o-ow nyot aww dependencies satisfied so don't mawk as compwete
          wes
        }
      }
    }.onwyif { (a, œÉœâœÉ ctx) =>
      quewyfiwtew(ctx.opts) &&
      (!ctx.compwetedhydwations.contains(hydwationtype))
    }
  }

  /**
   * appwies a `tweetdatavawuehydwatow` t-to a `tweetwepositowy.type`-typed w-wepositowy. :3
   * t-the i-incoming `tweetquewy.options` awe fiwst expanded using `optionsexpandew`, ^^ a-and the
   * wesuwting options passed to `wepo` and `hydwatow`. (‚úøoœâo)  t-the w-wesuwting tweet w-wesuwt
   * objects a-awe passed to `cachechangeseffect` fow possibwe wwite-back to cache. √≤œâ√≥  finawwy, (U ·µï U‚ùÅ)
   * the tweets a-awe scwubbed a-accowding to the owiginaw input `tweetquewy.options`.  òw ò
   */
  def hydwatewepo(
    h-hydwatow: tweetdatavawuehydwatow, ( Õ°o œâ Õ°o )
    cachechangeseffect: e-effect[tweetwesuwt], œÉœâœÉ
    o-optionsexpandew: t-tweetquewyoptionsexpandew.type
  )(
    wepo: tweetwesuwtwepositowy.type
  ): tweetwesuwtwepositowy.type =
    (tweetid: tweetid, (ÀÜ Ôªå ÀÜ)‚ô° owiginawopts: tweetquewy.options) => {
      vaw expandedopts = o-optionsexpandew(owiginawopts)

      fow {
        w-wepowesuwt <- wepo(tweetid, (ÀòœâÀò) expandedopts)
        hydwatowwesuwt <- h-hydwatow(wepowesuwt.vawue, üò≥ expandedopts)
      } y-yiewd {
        vaw hydwatingwepowesuwt =
          tweetwesuwt(hydwatowwesuwt.vawue, ^‚Ä¢Ôªå‚Ä¢^ w-wepowesuwt.state ++ h-hydwatowwesuwt.state)

        i-if (owiginawopts.cachecontwow.wwitetocache) {
          c-cachechangeseffect(hydwatingwepowesuwt)
        }

        u-unwequestedfiewdscwubbew(owiginawopts).scwub(hydwatingwepowesuwt)
      }
    }

  /**
   * a twiviaw w-wwappew awound a-a stitch[_] to pwovide a `joinwith`
   * m-method that wets us choose the pwecedence o-of exceptions. œÉœâœÉ
   *
   * this w-wwappew is usefuw f-fow the case in which it's i-impowtant that
   * w-we specify which of the two exceptions wins (such as visibiwity
   * f-fiwtewing). üò≥üò≥üò≥
   *
   * since t-this is an [[anyvaw]], rawr u-using t-this is nyo mowe expensive than
   * inwining the joinwith method. >_<
   */
  // e-exposed fow testing
  case cwass stitchexceptionpwecedence[a](tostitch: s-stitch[a]) extends anyvaw {

    /**
     * concuwwentwy e-evawuate two stitch[_] vawues. this is diffewent
     * fwom stitch.join i-in that any exception f-fwom the expwession o-on
     * the w-weft hand side wiww take pwecedence o-ovew an exception o-on
     * the wight hand s-side.  òw ò this means t-that an exception f-fwom the
     * w-wight-hand side wiww not showt-ciwcuit e-evawuation, (ÀÜ Ôªå ÀÜ)‚ô° b-but an
     * e-exception on the weft-hand s-side *wiww* showt-ciwcuit. ^^;; this is
     * desiwabwe because it awwows us to wetuwn the faiwuwe with a-as
     * wittwe w-watency as possibwe. œÉœâœÉ (compawe t-to wifting *both* to twy, rawr x3
     * which wouwd f-fowce us to wait f-fow both computations t-to compwete
     * b-befowe wetuwning, üò≥ even i-if the one with the highew pwecedence is
     * a-awweady known to b-be an exception.)
     */
    def joinwith[b, c](whs: stitch[b])(f: (a, üò≥üò≥üò≥ b) => c-c): stitchexceptionpwecedence[c] =
      stitchexceptionpwecedence {
        s-stitch
          .joinmap(tostitch, üò≥üò≥üò≥ whs.wifttotwy) { (a, ( Õ°o œâ Õ°o ) twyb) => twyb.map(b => f-f(a, rawr x3 b)) }
          .wowewfwomtwy
      }
  }
}
